<!DOCTYPE html>
<html><head><meta charset=utf-8><title>crypto_request(9)</title><keywords content=man,crypto_request></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>crypto_request(9)</h1><table class=head><tr><td class=head-ltitle>CRYPTO_REQUEST(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>CRYPTO_REQUEST(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>crypto_request</code> — <div class=Nd>symmetric cryptographic operations</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/opencrypto/cryptodev.h.html>opencrypto/cryptodev.h</a>&gt;</code><p class=Pp><var class=Ft>struct cryptop *</var><br><code class=Fn>crypto_clonereq</code>(<var class=Fa style="white-space: nowrap;">crypto_session_t cses</var>, <var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">int how</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_dispatch</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_dispatch_async</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_dispatch_batch</code>(<var class=Fa style="white-space: nowrap;">struct cryptopq *crpq</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_destroyreq</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_freereq</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><p class=Pp><var class=Ft>struct cryptop *</var><br><code class=Fn>crypto_getreq</code>(<var class=Fa style="white-space: nowrap;">crypto_session_t cses</var>, <var class=Fa style="white-space: nowrap;">int how</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_initreq</code>(<var class=Fa style="white-space: nowrap;">crypto_session_t cses</var>, <var class=Fa style="white-space: nowrap;">int how</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_buf</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">void *buf</var>, <var class=Fa style="white-space: nowrap;">int len</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_mbuf</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">struct mbuf *m</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_uio</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">struct uio *uio</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_vmpage</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">vm_page_t *pages</var>, <var class=Fa style="white-space: nowrap;">int len</var>, <var class=Fa style="white-space: nowrap;">int offset</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_output_buf</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">void *buf</var>, <var class=Fa style="white-space: nowrap;">int len</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_output_mbuf</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">struct mbuf *m</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_output_uio</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">struct uio *uio</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_use_output_vmpage</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>, <var class=Fa style="white-space: nowrap;">vm_page_t *pages</var>, <var class=Fa style="white-space: nowrap;">int len</var>, <var class=Fa style="white-space: nowrap;">int offset</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> Each symmetric cryptographic operation in the kernel is described by an instance of <var class=Vt>struct cryptop</var> and is associated with an active session. <p class=Pp>Requests can either be allocated dynamically or use caller-supplied storage. Dynamically allocated requests should be allocated by either <code class=Fn>crypto_getreq</code>() or <code class=Fn>crypto_clonereq</code>(), and freed by <code class=Fn>crypto_freereq</code>() once the request has completed. Requests using caller-supplied storage should be initialized by <code class=Fn>crypto_initreq</code>() at the start of each operation and destroyed by <code class=Fn>crypto_destroyreq</code>() once the request has completed.</p><p class=Pp>For <code class=Fn>crypto_clonereq</code>(), <code class=Fn>crypto_getreq</code>(), and <code class=Fn>crypto_initreq</code>(), <var class=Fa>cses</var> is a reference to an active session. For <code class=Fn>crypto_clonereq</code>() and <code class=Fn>crypto_getreq</code>(), <var class=Fa>how</var> is passed to <a class=Xr href=malloc.9.html>malloc(9)</a> and should be set to either <code class=Dv>M_NOWAIT</code> or <code class=Dv>M_WAITOK</code>.</p><p class=Pp><code class=Fn>crypto_clonereq</code>() allocates a new request that inherits request inputs such as request buffers from the original <var class=Fa>crp</var> request. However, the new request is associated with the <var class=Fa>cses</var> session rather than inheriting the session from <var class=Fa>crp</var>. <var class=Fa>crp</var> must not be a completed request.</p><p class=Pp>Once a request has been initialized, the caller should set fields in the structure to describe request-specific parameters. Unused fields should be left as-is.</p><p class=Pp>The <code class=Fn>crypto_dispatch</code>(), <code class=Fn>crypto_dispatch_async</code>(), and <code class=Fn>crypto_dispatch_batch</code>() functions pass one or more crypto requests to the driver attached to the request's session. If there are errors in the request's fields, these functions may return an error to the caller. If errors are encountered while servicing the request, they will instead be reported to the request's callback function (<var class=Fa>crp_callback</var>) via <var class=Fa>crp_etype</var>.</p><p class=Pp>Note that a request's callback function may be invoked before <code class=Fn>crypto_dispatch</code>() returns.</p><p class=Pp>Once a request has signaled completion by invoking its callback function, it should be freed via <code class=Fn>crypto_destroyreq</code>() or <code class=Fn>crypto_freereq</code>().</p><p class=Pp>Cryptographic operations include several fields to describe the request.</p><section class=Ss><h2 class=Ss id=Request_Buffers><a class=permalink href=#Request_Buffers>Request Buffers</a></h2> Requests can either specify a single data buffer that is modified in place (<var class=Fa>crp_buf</var>) or separate input (<var class=Fa>crp_buf</var>) and output (<var class=Fa>crp_obuf</var>) buffers. Note that separate input and output buffers are not supported for compression mode requests. <p class=Pp>All requests must have a valid <var class=Fa>crp_buf</var> initialized by one of the following functions:</p><dl class=Bl-tag><dt><code class=Fn>crypto_use_buf</code>()</dt><dd>Uses an array of <var class=Fa>len</var> bytes pointed to by <var class=Fa>buf</var> as the data buffer.</dd><dt><code class=Fn>crypto_use_mbuf</code>()</dt><dd>Uses the network memory buffer <var class=Fa>m</var> as the data buffer.</dd><dt><code class=Fn>crypto_use_uio</code>()</dt><dd>Uses the scatter/gather list <var class=Fa>uio</var> as the data buffer.</dd><dt><code class=Fn>crypto_use_vmpage</code>()</dt><dd>Uses the array of <var class=Vt>vm_page_t</var> structures as the data buffer.</dd></dl><p class=Pp>One of the following functions should be used to initialize <var class=Fa>crp_obuf</var> for requests that use separate input and output buffers:</p><dl class=Bl-tag><dt><code class=Fn>crypto_use_output_buf</code>()</dt><dd>Uses an array of <var class=Fa>len</var> bytes pointed to by <var class=Fa>buf</var> as the output buffer.</dd><dt><code class=Fn>crypto_use_output_mbuf</code>()</dt><dd>Uses the network memory buffer <var class=Fa>m</var> as the output buffer.</dd><dt><code class=Fn>crypto_use_output_uio</code>()</dt><dd>Uses the scatter/gather list <var class=Fa>uio</var> as the output buffer.</dd><dt><code class=Fn>crypto_use_output_vmpage</code>()</dt><dd>Uses the array of <var class=Vt>vm_page_t</var> structures as the output buffer.</dd></dl></section><section class=Ss><h2 class=Ss id=Request_Regions><a class=permalink href=#Request_Regions>Request Regions</a></h2> Each request describes one or more regions in the data buffers. Each region is described by an offset relative to the start of a data buffer and a length. The length of some regions is the same for all requests belonging to a session. Those lengths are set in the session parameters of the associated session. All requests must define a payload region. Other regions are only required for specific session modes. <p class=Pp>For requests with separate input and output data buffers, the AAD, IV, and payload regions are always defined as regions in the input buffer, and a separate payload output region is defined to hold the output of encryption or decryption in the output buffer. The digest region describes a region in the input data buffer for requests that verify an existing digest. For requests that compute a digest, the digest region describes a region in the output data buffer. Note that the only data written to the output buffer is the encryption or decryption result and any computed digest. AAD and IV regions are not copied from the input buffer into the output buffer but are only used as inputs.</p><p class=Pp>The following regions are defined:</p><table class=Bl-column><tr><td><b class=Sy>Region</b></td><td><b class=Sy>Buffer</b></td><td><b class=Sy>Description</b></td></tr><tr><td>AAD</td><td>Input</td><td>Embedded Additional Authenticated Data</td></tr><tr><td>IV</td><td>Input</td><td>Embedded IV or nonce</td></tr><tr><td>Payload</td><td>Input</td><td>Data to encrypt, decrypt, compress, or decompress</td></tr><tr><td>Payload Output</td><td>Output</td><td>Encrypted or decrypted data</td></tr><tr><td>Digest</td><td>Input/Output</td><td>Authentication digest, hash, or tag</td></tr></table><table class=Bl-column><tr><td><b class=Sy>Region</b></td><td><b class=Sy>Start</b></td><td><b class=Sy>Length</b></td></tr><tr><td>AAD</td><td><var class=Fa>crp_aad_start</var></td><td><var class=Fa>crp_aad_length</var></td></tr><tr><td>IV</td><td><var class=Fa>crp_iv_start</var></td><td><var class=Fa>csp_ivlen</var></td></tr><tr><td>Payload</td><td><var class=Fa>crp_payload_start</var></td><td><var class=Fa>crp_payload_length</var></td></tr><tr><td>Payload Output</td><td><var class=Fa>crp_payload_output_start</var></td><td><var class=Fa>crp_payload_length</var></td></tr><tr><td>Digest</td><td><var class=Fa>crp_digest_start</var></td><td><var class=Fa>csp_auth_mlen</var></td></tr></table><p class=Pp>Requests are permitted to operate on only a subset of the data buffer. For example, requests from IPsec operate on network packets that include headers not used as either additional authentication data (AAD) or payload data.</p></section><section class=Ss><h2 class=Ss id=Request_Operations><a class=permalink href=#Request_Operations>Request Operations</a></h2> All requests must specify the type of operation to perform in <var class=Fa>crp_op</var>. Available operations depend on the session's mode. <p class=Pp>Compression requests support the following operations:</p><dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_OP_COMPRESS><code class=Dv id=CRYPTO_OP_COMPRESS>CRYPTO_OP_COMPRESS</code></a></dt><dd>Compress the data in the payload region of the data buffer.</dd><dt><a class=permalink href=#CRYPTO_OP_DECOMPRESS><code class=Dv id=CRYPTO_OP_DECOMPRESS>CRYPTO_OP_DECOMPRESS</code></a></dt><dd>Decompress the data in the payload region of the data buffer.</dd></dl><p class=Pp>Cipher requests support the following operations:</p><dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_OP_ENCRYPT><code class=Dv id=CRYPTO_OP_ENCRYPT>CRYPTO_OP_ENCRYPT</code></a></dt><dd>Encrypt the data in the payload region of the data buffer.</dd><dt><a class=permalink href=#CRYPTO_OP_DECRYPT><code class=Dv id=CRYPTO_OP_DECRYPT>CRYPTO_OP_DECRYPT</code></a></dt><dd>Decrypt the data in the payload region of the data buffer.</dd></dl><p class=Pp>Digest requests support the following operations:</p><dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_OP_COMPUTE_DIGEST><code class=Dv id=CRYPTO_OP_COMPUTE_DIGEST>CRYPTO_OP_COMPUTE_DIGEST</code></a></dt><dd>Calculate a digest over the payload region of the data buffer and store the result in the digest region.</dd><dt><a class=permalink href=#CRYPTO_OP_VERIFY_DIGEST><code class=Dv id=CRYPTO_OP_VERIFY_DIGEST>CRYPTO_OP_VERIFY_DIGEST</code></a></dt><dd>Calculate a digest over the payload region of the data buffer. Compare the calculated digest to the existing digest from the digest region. If the digests match, complete the request successfully. If the digests do not match, fail the request with <code class=Er>EBADMSG</code>.</dd></dl><p class=Pp>AEAD and Encrypt-then-Authenticate requests support the following operations:</p><dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_OP_ENCRYPT_2><code class=Dv id=CRYPTO_OP_ENCRYPT_2>CRYPTO_OP_ENCRYPT</code></a> | <a class=permalink href=#CRYPTO_OP_COMPUTE_DIGEST_2><code class=Dv id=CRYPTO_OP_COMPUTE_DIGEST_2>CRYPTO_OP_COMPUTE_DIGEST</code></a></dt><dd>Encrypt the data in the payload region of the data buffer. Calculate a digest over the AAD and payload regions and store the result in the data buffer.</dd><dt><a class=permalink href=#CRYPTO_OP_DECRYPT_2><code class=Dv id=CRYPTO_OP_DECRYPT_2>CRYPTO_OP_DECRYPT</code></a> | <a class=permalink href=#CRYPTO_OP_VERIFY_DIGEST_2><code class=Dv id=CRYPTO_OP_VERIFY_DIGEST_2>CRYPTO_OP_VERIFY_DIGEST</code></a></dt><dd>Calculate a digest over the AAD and payload regions of the data buffer. Compare the calculated digest to the existing digest from the digest region. If the digests match, decrypt the payload region. If the digests do not match, fail the request with <code class=Er>EBADMSG</code>.</dd></dl></section><section class=Ss><h2 class=Ss id=Request_AAD><a class=permalink href=#Request_AAD>Request AAD</a></h2> AEAD and Encrypt-then-Authenticate requests may optionally include Additional Authenticated Data. AAD may either be supplied in the AAD region of the input buffer or as a single buffer pointed to by <var class=Fa>crp_aad</var>. In either case, <var class=Fa>crp_aad_length</var> always indicates the amount of AAD in bytes. </section><section class=Ss><h2 class=Ss id=Request_ESN><a class=permalink href=#Request_ESN>Request ESN</a></h2> IPsec requests may optionally include Extended Sequence Numbers (ESN). ESN may either be supplied in <var class=Fa>crp_esn</var> or as part of the AAD pointed to by <var class=Fa>crp_aad</var>. <p class=Pp>If the ESN is stored in <var class=Fa>crp_esn</var>, <code class=Dv>CSP_F_ESN</code> should be set in <var class=Fa>csp_flags</var>. This use case is dedicated for encrypt and authenticate mode, since the high-order 32 bits of the sequence number are appended after the Next Header (RFC 4303).</p><p class=Pp>AEAD modes supply the ESN in a separate AAD buffer (see e.g. RFC 4106, Chapter 5 AAD Construction).</p></section><section class=Ss><h2 class=Ss id=Request_IV_and/or_Nonce><a class=permalink href=#Request_IV_and/or_Nonce>Request IV and/or Nonce</a></h2> Some cryptographic operations require an IV or nonce as an input. An IV may be stored either in the IV region of the data buffer or in <var class=Fa>crp_iv</var>. By default, the IV is assumed to be stored in the IV region. If the IV is stored in <var class=Fa>crp_iv</var>, <code class=Dv>CRYPTO_F_IV_SEPARATE</code> should be set in <var class=Fa>crp_flags</var> and <var class=Fa>crp_iv_start</var> should be left as zero. <p class=Pp>Requests that store part, but not all, of the IV in the data buffer should store the partial IV in the data buffer and pass the full IV separately in <var class=Fa>crp_iv</var>.</p></section><section class=Ss><h2 class=Ss id=Request_and_Callback_Scheduling><a class=permalink href=#Request_and_Callback_Scheduling>Request and Callback Scheduling</a></h2> The crypto framework provides multiple methods of scheduling the dispatch of requests to drivers along with the processing of driver callbacks. The <code class=Fn>crypto_dispatch</code>(), <code class=Fn>crypto_dispatch_async</code>(), and <code class=Fn>crypto_dispatch_batch</code>() functions can be used to request different dispatch scheduling policies. <p class=Pp><code class=Fn>crypto_dispatch</code>() synchronously passes the request to the driver. The driver itself may process the request synchronously or asynchronously depending on whether the driver is implemented by software or hardware.</p><p class=Pp><code class=Fn>crypto_dispatch_async</code>() dispatches the request asynchronously. If the driver is inherently synchronous, the request is queued to a taskqueue backed by a pool of worker threads. This can increase througput by allowing requests from a single producer to be processed in parallel. By default the pool is sized to provide one thread for each CPU. Worker threads dequeue requests and pass them to the driver asynchronously. <code class=Fn>crypto_dispatch_async</code>() additionally takes a <var class=Va>flags</var> parameter. The <code class=Dv>CRYPTO_ASYNC_ORDERED</code> flag indicates that completion callbacks for requests must be called in the same order as requests were dispatched. If the driver is asynchronous, the behavior of <code class=Fn>crypto_dispatch_async</code>() is identical to that of <code class=Fn>crypto_dispatch</code>().</p><p class=Pp><code class=Fn>crypto_dispatch_batch</code>() allows the caller to collect a batch of requests and submit them to the driver at the same time. This allows hardware drivers to optimize the scheduling of request processing and batch completion interrupts. A batch is submitted to the driver by invoking the driver's process method on each request, specifying <code class=Dv>CRYPTO_HINT_MORE</code> with each request except for the last. The <var class=Fa>flags</var> parameter to <code class=Fn>crypto_dispatch_batch</code>() is currently ignored.</p><p class=Pp>Callback function scheduling is simpler than request scheduling. Callbacks can either be invoked synchronously from <code class=Fn>crypto_done</code>(), or they can be queued to a pool of worker threads. This pool of worker threads is also sized to provide one worker thread for each CPU by default. Note that a callback function invoked synchronously from <code class=Fn>crypto_done</code>() must follow the same restrictions placed on threaded interrupt handlers.</p><p class=Pp>By default, callbacks are invoked asynchronously by a worker thread. If <code class=Dv>CRYPTO_F_CBIMM</code> is set, the callback is always invoked synchronously from <code class=Fn>crypto_done</code>(). If <code class=Dv>CRYPTO_F_CBIFSYNC</code> is set, the callback is invoked synchronously if the request was processed by a software driver or asynchronously if the request was processed by a hardware driver.</p><p class=Pp>If a request was scheduled to the taskqueue via <code class=Dv>CRYPTO_F_ASYNC</code>, callbacks are always invoked asynchronously ignoring <code class=Dv>CRYPTO_F_CBIMM</code> and <code class=Dv>CRYPTO_F_CBIFSYNC</code>. In this case, <code class=Dv>CRYPTO_F_ASYNC_KEEPORDER</code> may be set to ensure that callbacks for requests on a given session are invoked in the same order that requests were queued to the session via <code class=Fn>crypto_dispatch</code>(). This flag is used by IPsec to ensure that decrypted network packets are passed up the network stack in roughly the same order they were received.</p></section><section class=Ss><h2 class=Ss id=Other_Request_Fields><a class=permalink href=#Other_Request_Fields>Other Request Fields</a></h2> In addition to the fields and flags enumerated above, <var class=Vt>struct cryptop</var> includes the following: <dl class=Bl-tag><dt><var class=Fa>crp_session</var></dt><dd>A reference to the active session. This is set when the request is created by <code class=Fn>crypto_getreq</code>() and should not be modified. Drivers can use this to fetch driver-specific session state or session parameters.</dd><dt><var class=Fa>crp_etype</var></dt><dd>Error status. Either zero on success, or an error if a request fails. Set by drivers prior to completing a request via <code class=Fn>crypto_done</code>().</dd><dt><var class=Fa>crp_flags</var></dt><dd>A bitmask of flags. The following flags are available in addition to flags discussed previously: <dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_F_DONE><code class=Dv id=CRYPTO_F_DONE>CRYPTO_F_DONE</code></a></dt><dd>Set by <var class=Fa>crypto_done</var> before calling <var class=Fa>crp_callback</var>. This flag is not very useful and will likely be removed in the future. It can only be safely checked from the callback routine at which point it is always set.</dd></dl></dd><dt><var class=Fa>crp_cipher_key</var></dt><dd>Pointer to a request-specific encryption key. If this value is not set, the request uses the session encryption key.</dd><dt><var class=Fa>crp_auth_key</var></dt><dd>Pointer to a request-specific authentication key. If this value is not set, the request uses the session authentication key.</dd><dt><var class=Fa>crp_opaque</var></dt><dd>An opaque pointer. This pointer permits users of the cryptographic framework to store information about a request to be used in the callback.</dd><dt><var class=Fa>crp_callback</var></dt><dd>Callback function. This must point to a callback function of type <var class=Vt>void (*)(struct cryptop *)</var>. The callback function should inspect <var class=Fa>crp_etype</var> to determine the status of the completed operation. It should also arrange for the request to be freed via <code class=Fn>crypto_freereq</code>().</dd><dt><var class=Fa>crp_olen</var></dt><dd>Used with compression and decompression requests to describe the updated length of the payload region in the data buffer. <p class=Pp>If a compression request increases the size of the payload, then the data buffer is unmodified, the request completes successfully, and <var class=Fa>crp_olen</var> is set to the size the compressed data would have used. Callers can compare this to the payload region length to determine if the compressed data was discarded.</p></dd></dl></section></section><section class=Sh><h2 class=Sh id=RETURN_VALUES><a class=permalink href=#RETURN_VALUES>RETURN VALUES</a></h2><code class=Fn>crypto_dispatch</code>() returns an error if the request contained invalid fields, or zero if the request was valid. <code class=Fn>crypto_getreq</code>() returns a pointer to a new request structure on success, or <code class=Dv>NULL</code> on failure. <code class=Dv>NULL</code> can only be returned if <code class=Dv>M_NOWAIT</code> was passed in <var class=Fa>how</var>. </section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=ipsec.4.html>ipsec(4)</a>, <a class=Xr href=crypto.7.html>crypto(7)</a>, <a class=Xr href=crypto.9.html>crypto(9)</a>, <a class=Xr href=crypto_session.9.html>crypto_session(9)</a>, <a class=Xr href=mbuf.9.html>mbuf(9)</a>, <a class=Xr href=uio.9.html>uio(9)</a></section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> Not all drivers properly handle mixing session and per-request keys within a single session. Consumers should either use a single key for a session specified in the session parameters or always use per-request keys. </section></div><table class=foot><tr><td class=foot-date>January 4, 2022</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>