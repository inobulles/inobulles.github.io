<!DOCTYPE html>
<html><head><meta charset=utf-8><title>pnfsserver(4)</title><keywords content=man,pnfsserver></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>pnfsserver(4)</h1><table class=head><tr><td class=head-ltitle>PNFSSERVER(4)</td><td class=head-vol>FreeBSD Kernel Interfaces Manual</td><td class=head-rtitle>PNFSSERVER(4)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>pNFSserver</code> — <div class=Nd>NFS Version 4.1 and 4.2 Parallel NFS Protocol Server</div></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> A set of <span class=Ux>FreeBSD</span> servers may be configured to provide a <a class=Xr href=pnfs.4.html>pnfs(4)</a> service. One <span class=Ux>FreeBSD</span> system needs to be configured as a MetaData Server (MDS) and at least one additional <span class=Ux>FreeBSD</span> system needs to be configured as one or more Data Servers (DS)s. <p class=Pp>These <span class=Ux>FreeBSD</span> systems are configured to be NFSv4.1 and NFSv4.2 servers, see <a class=Xr href=nfsd.8.html>nfsd(8)</a> and <a class=Xr href=exports.5.html>exports(5)</a> if you are not familiar with configuring a NFSv4.n server. All DS(s) and the MDS should support NFSv4.2 as well as NFSv4.1. Mixing an MDS that supports NFSv4.2 with any DS(s) that do not support NFSv4.2 will not work correctly. As such, all DS(s) must be upgraded from <span class=Ux>FreeBSD 12</span> to <span class=Ux>FreeBSD 13</span> before upgrading the MDS.</p></section><section class=Sh><h2 class=Sh id=DS_server_configuration><a class=permalink href=#DS_server_configuration>DS server configuration</a></h2> The DS(s) need to be configured as NFSv4.1 and NFSv4.2 server(s), with a top level exported directory used for storage of data files. This directory must be owned by “root” and would normally have a mode of “700”. Within this directory there needs to be additional directories named ds0,...,dsN (where N is 19 by default) also owned by “root” with mode “700”. These are the directories where the data files are stored. The following command can be run by root when in the top level exported directory to create these subdirectories. <div class="Bd Pp Bd-indent"><pre>
jot -w ds 20 0 | xargs mkdir -m 700
</pre></div><p class=Pp>Note that “20” is the default and can be set to a larger value on the MDS as shown below.</p><p class=Pp>The top level exported directory used for storage of data files must be exported to the MDS with the “maproot=root sec=sys” export options so that the MDS can create entries in these subdirectories. It must also be exported to all pNFS aware clients, but these clients do not require the “maproot=root” export option and this directory should be exported to them with the same options as used by the MDS to export file system(s) to the clients.</p><p class=Pp>It is possible to have multiple DSs on the same <span class=Ux>FreeBSD</span> system, but each of these DSs must have a separate top level exported directory used for storage of data files and each of these DSs must be mountable via a separate IP address. Alias addresses can be set on the DS server system for a network interface via <a class=Xr href=ifconfig.8.html>ifconfig(8)</a> to create these different IP addresses. Multiple DSs on the same server may be useful when data for different file systems on the MDS are being stored on different file system volumes on the <span class=Ux>FreeBSD</span> DS system.</p></section><section class=Sh><h2 class=Sh id=MDS_server_configuration><a class=permalink href=#MDS_server_configuration>MDS server configuration</a></h2> The MDS must be a separate <span class=Ux>FreeBSD</span> system from the <span class=Ux>FreeBSD</span> DS system(s) and NFS clients. It is configured as a NFSv4.1 and NFSv4.2 server with file system(s) exported to clients. However, the “-p” command line argument for <a class=Xr href=nfsd.1.html>nfsd</a> is used to indicate that it is running as the MDS for a pNFS server. <p class=Pp>The DS(s) must all be mounted on the MDS using the following mount options:</p><div class="Bd Pp Bd-indent"><pre>
nfsv4,minorversion=2,soft,retrans=2
</pre></div><p class=Pp>so that they can be defined as DSs in the “-p” option. Normally these mounts would be entered in the <a class=Xr href=fstab.5.html>fstab(5)</a> on the MDS. For example, if there are four DSs named nfsv4-data[0-3], the <a class=Xr href=fstab.5.html>fstab(5)</a> lines might look like:</p><div class="Bd Pp"><pre>
nfsv4-data0:/ /data0 nfs rw,nfsv4,minorversion=2,soft,retrans=2 0 0
nfsv4-data1:/ /data1 nfs rw,nfsv4,minorversion=2,soft,retrans=2 0 0
nfsv4-data2:/ /data2 nfs rw,nfsv4,minorversion=2,soft,retrans=2 0 0
nfsv4-data3:/ /data3 nfs rw,nfsv4,minorversion=2,soft,retrans=2 0 0
</pre></div><p class=Pp>The <a class=Xr href=nfsd.8.html>nfsd(8)</a> command line option “-p” indicates that the NFS server is a pNFS MDS and specifies what DSs are to be used. <br> For the above <a class=Xr href=fstab.5.html>fstab(5)</a> example, the <a class=Xr href=nfsd.8.html>nfsd(8)</a> nfs_server_flags line in your <a class=Xr href=rc.conf.5.html>rc.conf(5)</a> might look like:</p><div class="Bd Pp"><pre>
nfs_server_flags="-u -t -n 128 -p nfsv4-data0:/data0,nfsv4-data1:/data1,nfsv4-data2:/data2,nfsv4-data3:/data3"
</pre></div><p class=Pp>This example specifies that the data files should be distributed over the four DSs and File layouts will be issued to pNFS enabled clients. If issuing Flexible File layouts is desired for this case, setting the sysctl “vfs.nfsd.default_flexfile” non-zero in your <a class=Xr href=sysctl.conf.5.html>sysctl.conf(5)</a> file will make the <code class=Nm>pNFSserver</code> do that. <br> Alternately, this variant of “nfs_server_flags” will specify that two way mirroring is to be done, via the “-m” command line option.</p><div class="Bd Pp"><pre>
nfs_server_flags="-u -t -n 128 -p nfsv4-data0:/data0,nfsv4-data1:/data1,nfsv4-data2:/data2,nfsv4-data3:/data3 -m 2"
</pre></div><p class=Pp>With two way mirroring, the data file for each exported file on the MDS will be stored on two of the DSs. When mirroring is enabled, the server will always issue Flexible File layouts.</p><p class=Pp>It is also possible to specify which DSs are to be used to store data files for specific exported file systems on the MDS. For example, if the MDS has exported two file systems “/export1” and “/export2” to clients, the following variant of “nfs_server_flags” will specify that data files for “/export1” will be stored on nfsv4-data0 and nfsv4-data1, whereas the data files for “/export2” will be store on nfsv4-data2 and nfsv4-data3.</p><div class="Bd Pp"><pre>
nfs_server_flags="-u -t -n 128 -p nfsv4-data0:/data0#/export1,nfsv4-data1:/data1#/export1,nfsv4-data2:/data2#/export2,nfsv4-data3:/data3#/export2"
</pre></div><p class=Pp>This can be used by system administrators to control where data files are stored and might be useful for control of storage use. For this case, it may be convenient to co-locate more than one of the DSs on the same <span class=Ux>FreeBSD</span> server, using separate file systems on the DS system for storage of the respective DS's data files. If mirroring is desired for this case, the “-m” option also needs to be specified. There must be enough DSs assigned to each exported file system on the MDS to support the level of mirroring. The above example would be fine for two way mirroring, but four way mirroring would not work, since there are only two DSs assigned to each exported file system on the MDS.</p><p class=Pp>The number of subdirectories in each DS is defined by the “vfs.nfs.dsdirsize” sysctl on the MDS. This value can be increased from the default of 20, but only when the <a class=Xr href=nfsd.8.html>nfsd(8)</a> is not running and after the additional ds20,... subdirectories have been created on all the DSs. For a service that will store a large number of files this sysctl should be set much larger, to avoid the number of entries in a subdirectory from getting too large.</p></section><section class=Sh><h2 class=Sh id=Client_mounts><a class=permalink href=#Client_mounts>Client mounts</a></h2> Once operational, NFSv4.1 or NFSv4.2 <span class=Ux>FreeBSD</span> client mounts done with the “pnfs” option should do I/O directly on the DSs. The clients mounting the MDS must be running the <a class=Xr href=nfscbd.1.html>nfscbd</a> daemon for pNFS to work. Set <div class="Bd Pp Bd-indent"><pre>
nfscbd_enable="YES"
</pre></div><p class=Pp>in the <a class=Xr href=rc.conf.5.html>rc.conf(5)</a> on these clients. Non-pNFS aware clients or NFSv3 mounts will do all I/O RPCs on the MDS, which acts as a proxy for the appropriate DS(s).</p></section><section class=Sh><h2 class=Sh id=Backing_up_a_pNFS_service><a class=permalink href=#Backing_up_a_pNFS_service>Backing up a pNFS service</a></h2> Since the data is separated from the metadata, the simple way to back up a pNFS service is to do so from an NFS client that has the service mounted on it. If you back up the MDS exported file system(s) on the MDS, you must do it in such a way that the “system” namespace extended attributes get backed up. </section><section class=Sh><h2 class=Sh id=Handling_of_failed_mirrored_DSs><a class=permalink href=#Handling_of_failed_mirrored_DSs>Handling of failed mirrored DSs</a></h2> When a mirrored DS fails, it can be disabled one of three ways: <p class=Pp>1 - The MDS detects a problem when trying to do proxy operations on the DS. This can take a couple of minutes after the DS failure or network partitioning occurs.</p><p class=Pp>2 - A pNFS client can report an I/O error that occurred for a DS to the MDS in the arguments for a LayoutReturn operation.</p><p class=Pp>3 - The system administrator can perform the pnfsdskill(8) command on the MDS to disable it. If the system administrator does a pnfsdskill(8) and it fails with ENXIO (Device not configured) that normally means the DS was already disabled via #1 or #2. Since doing this is harmless, once a system administrator knows that there is a problem with a mirrored DS, doing the command is recommended.</p><p class=Pp>Once a system administrator knows that a mirrored DS has malfunctioned or has been network partitioned, they should do the following as root/su on the MDS:</p><div class="Bd Pp Bd-indent"><pre>
# pnfsdskill &lt;mounted-on-path-of-DS&gt;
# umount -N &lt;mounted-on-path-of-DS&gt;
</pre></div><p class=Pp>Note that the &lt;mounted-on-path-of-DS&gt; must be the exact mounted-on path string used when the DS was mounted on the MDS.</p><p class=Pp>Once the mirrored DS has been disabled, the pNFS service should continue to function, but file updates will only happen on the DS(s) that have not been disabled. Assuming two way mirroring, that implies the one DS of the pair stored in the “pnfsd.dsfile” extended attribute for the file on the MDS, for files stored on the disabled DS.</p><p class=Pp>The next step is to clear the IP address in the “pnfsd.dsfile” extended attribute on all files on the MDS for the failed DS. This is done so that, when the disabled DS is repaired and brought back online, the data files on this DS will not be used, since they may be out of date. The command that clears the IP address is <a class=Xr href=pnfsdsfile.8.html>pnfsdsfile(8)</a> with the “-r” option.</p><div class="Bd Pp"><pre>
For example:
# pnfsdsfile -r nfsv4-data3 yyy.c
yyy.c:	nfsv4-data2.home.rick	ds0/207508569ff983350c000000ec7c0200e4c57b2e0000000000000000	0.0.0.0	ds0/207508569ff983350c000000ec7c0200e4c57b2e0000000000000000
</pre></div><p class=Pp>replaces nfsv4-data3 with an IPv4 address of 0.0.0.0, so that nfsv4-data3 will not get used.</p><p class=Pp>Normally this will be called within a <a class=Xr href=find.1.html>find(1)</a> command for all regular files in the exported directory tree and must be done on the MDS. When used with <a class=Xr href=find.1.html>find(1)</a>, you will probably also want the “-q” option so that it won't spit out the results for every file. If the disabled/repaired DS is nfsv4-data3, the commands done on the MDS would be:</p><div class="Bd Pp"><pre>
# cd &lt;top-level-exported-dir&gt;
# find . -type f -exec pnfsdsfile -q -r nfsv4-data3 {} ;
</pre></div><p class=Pp>There is a problem with the above command if the file found by <a class=Xr href=find.1.html>find(1)</a> is renamed or unlinked before the <a class=Xr href=pnfsdsfile.8.html>pnfsdsfile(8)</a> command is done on it. This should normally generate an error message. A simple unlink is harmless but a link/unlink or rename might result in the file not having been processed under its new name. To check that all files have their IP addresses set to 0.0.0.0 these commands can be used (assuming the <a class=Xr href=sh.1.html>sh(1)</a> shell):</p><div class="Bd Pp"><pre>
# cd &lt;top-level-exported-dir&gt;
# find . -type f -exec pnfsdsfile {} ; | sed "/nfsv4-data3/!d"
</pre></div><p class=Pp>Any line(s) printed require the <a class=Xr href=pnfsdsfile.8.html>pnfsdsfile(8)</a> with “-r” to be done again. Once this is done, the replaced/repaired DS can be brought back online. It should have empty ds0,...,dsN directories under the top level exported directory for storage of data files just like it did when first set up. Mount it on the MDS exactly as you did before disabling it. For the nfsv4-data3 example, the command would be:</p><div class="Bd Pp"><pre>
# mount -t nfs -o nfsv4,minorversion=2,soft,retrans=2 nfsv4-data3:/ /data3
</pre></div><p class=Pp>Then restart the nfsd to re-enable the DS.</p><div class="Bd Pp"><pre>
# /etc/rc.d/nfsd restart
</pre></div><p class=Pp>Now, new files can be stored on nfsv4-data3, but files with the IP address zeroed out on the MDS will not yet use the repaired DS (nfsv4-data3). The next step is to go through the exported file tree on the MDS and, for each of the files with an IPv4 address of 0.0.0.0 in its extended attribute, copy the file data to the repaired DS and re-enable use of this mirror for it. This command for copying the file data for one MDS file is <a class=Xr href=pnfsdscopymr.8.html>pnfsdscopymr(8)</a> and it will also normally be used in a <a class=Xr href=find.1.html>find(1)</a>. For the example case, the commands on the MDS would be:</p><div class="Bd Pp"><pre>
# cd &lt;top-level-exported-dir&gt;
# find . -type f -exec pnfsdscopymr -r /data3 {} ;
</pre></div><p class=Pp>When this completes, the recovery should be complete or at least nearly so. As noted above, if a link/unlink or rename occurs on a file name while the above <a class=Xr href=find.1.html>find(1)</a> is in progress, it may not get copied. To check for any file(s) not yet copied, the commands are:</p><div class="Bd Pp"><pre>
# cd &lt;top-level-exported-dir&gt;
# find . -type f -exec pnfsdsfile {} ; | sed "/0.0.0.0/!d"
</pre></div><p class=Pp>If this command prints out any file name(s), these files must have the <a class=Xr href=pnfsdscopymr.8.html>pnfsdscopymr(8)</a> command done on them to complete the recovery.</p><div class="Bd Pp"><pre>
# pnfsdscopymr -r /data3 &lt;file-path-reported&gt;
</pre></div><p class=Pp>If this command fails with the error <br> “pnfsdscopymr: Copymr failed for file &lt;path&gt;: Device not configured” <br> repeatedly, this may be caused by a Read/Write layout that has not been returned. The only way to get rid of such a layout is to restart the <a class=Xr href=nfsd.8.html>nfsd(8)</a>.</p><p class=Pp>All of these commands are designed to be done while the pNFS service is running and can be re-run safely.</p><p class=Pp>For a more detailed discussion of the setup and management of a pNFS service see:</p><div class="Bd Pp Bd-indent"><pre>
https://people.freebsd.org/~rmacklem/pnfs-planb-setup.txt
</pre></div><p class=Pp></p></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=nfsv4.4.html>nfsv4(4)</a>, <a class=Xr href=pnfs.4.html>pnfs(4)</a>, <a class=Xr href=exports.5.html>exports(5)</a>, <a class=Xr href=fstab.5.html>fstab(5)</a>, <a class=Xr href=rc.conf.5.html>rc.conf(5)</a>, <a class=Xr href=sysctl.conf.5.html>sysctl.conf(5)</a>, <a class=Xr href=nfscbd.8.html>nfscbd(8)</a>, <a class=Xr href=nfsd.8.html>nfsd(8)</a>, <a class=Xr href=nfsuserd.8.html>nfsuserd(8)</a>, <a class=Xr href=pnfsdscopymr.8.html>pnfsdscopymr(8)</a>, <a class=Xr href=pnfsdsfile.8.html>pnfsdsfile(8)</a>, <a class=Xr href=pnfsdskill.8.html>pnfsdskill(8)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The <code class=Nm>pNFSserver</code> service first appeared in <span class=Ux>FreeBSD 12.0</span>. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> Since the MDS cannot be mirrored, it is a single point of failure just as a non pNFS server is. For non-mirrored configurations, all <span class=Ux>FreeBSD</span> systems used in the service are single points of failure. </section></div><table class=foot><tr><td class=foot-date>December 20, 2019</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>