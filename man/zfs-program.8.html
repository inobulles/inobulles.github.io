<!DOCTYPE html>
<html><head><meta charset=utf-8><title>zfs-program(8)</title><keywords content=man,zfs-program></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>zfs-program(8)</h1><table class=head><tr><td class=head-ltitle>ZFS-PROGRAM(8)</td><td class=head-vol>FreeBSD System Manager's Manual</td><td class=head-rtitle>ZFS-PROGRAM(8)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>zfs program</code> — <div class=Nd>executes ZFS channel programs</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=Cm>zfs program</code> [<code class=Fl>-jn</code>] [<code class=Fl>-t</code><var class=Ar>instruction-limit</var>] [<code class=Fl>-m</code><var class=Ar>memory-limit</var>] <var class=Ar>pool</var><var class=Ar>script</var></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The ZFS channel program interface allows ZFS administrative operations to be run programmatically as a Lua script. The entire script is executed atomically, with no other administrative operations taking effect concurrently. A library of ZFS calls is made available to channel program scripts. Channel programs may only be run with root privileges. <p class=Pp>A modified version of the Lua 5.2 interpreter is used to run channel program scripts. The Lua 5.2 manual can be found at:</p><div class="Bd Pp Bd-indent"><a href=http://www.lua.org/manual/5.2/ class=Lk>http://www.lua.org/manual/5.2/</a></div><p class=Pp>The channel program given by <var class=Ar>script</var> will be run on <var class=Ar>pool</var>, and any attempts to access or modify other pools will cause an error.</p></section><section class=Sh><h2 class=Sh id=OPTIONS><a class=permalink href=#OPTIONS>OPTIONS</a></h2><dl class=Bl-tag><dt><a class=permalink href=#j><code class=Fl id=j>-j</code></a></dt><dd>Display channel program output in JSON format. When this flag is specified and standard output is empty - channel program encountered an error. The details of such an error will be printed to standard error in plain text.</dd><dt><a class=permalink href=#n><code class=Fl id=n>-n</code></a></dt><dd>Executes a read-only channel program, which runs faster. The program cannot change on-disk state by calling functions from the zfs.sync submodule. The program can be used to gather information such as properties and determining if changes would succeed (zfs.check.*). Without this flag, all pending changes must be synced to disk before a channel program can complete.</dd><dt><a class=permalink href=#t><code class=Fl id=t>-t</code></a><var class=Ar>instruction-limit</var></dt><dd>Execution time limit, in number of Lua instructions to execute. If a channel program executes more than the specified number of instructions, it will be stopped and an error will be returned. The default limit is 10 million instructions, and it can be set to a maximum of 100 million instructions.</dd><dt><a class=permalink href=#m><code class=Fl id=m>-m</code></a><var class=Ar>memory-limit</var></dt><dd>Memory limit, in bytes. If a channel program attempts to allocate more memory than the given limit, it will be stopped and an error returned. The default memory limit is 10 MB, and can be set to a maximum of 100 MB.</dd></dl><p class=Pp>All remaining argument strings will be passed directly to the Lua script as described in the <a class=Sx href=#LUA_INTERFACE>LUA INTERFACE</a> section below.</p></section><section class=Sh><h2 class=Sh id=LUA_INTERFACE><a class=permalink href=#LUA_INTERFACE>LUA INTERFACE</a></h2> A channel program can be invoked either from the command line, or via a library call to <code class=Fn>lzc_channel_program</code>(). <section class=Ss><h2 class=Ss id=Arguments><a class=permalink href=#Arguments>Arguments</a></h2> Arguments passed to the channel program are converted to a Lua table. If invoked from the command line, extra arguments to the Lua script will be accessible as an array stored in the argument table with the key 'argv': <div class="Bd Pp Bd-indent"><pre>
args = ...
argv = args["argv"]
-- argv == {1="arg1", 2="arg2", ...}
</pre></div><p class=Pp>If invoked from the libZFS interface, an arbitrary argument list can be passed to the channel program, which is accessible via the same "..." syntax in Lua:</p><div class="Bd Pp Bd-indent"><pre>
args = ...
-- args == {"foo"="bar", "baz"={...}, ...}
</pre></div><p class=Pp>Note that because Lua arrays are 1-indexed, arrays passed to Lua from the libZFS interface will have their indices incremented by 1. That is, the element in <var class=Va>arr[0]</var> in a C array passed to a channel program will be stored in <var class=Va>arr[1]</var> when accessed from Lua.</p></section><section class=Ss><h2 class=Ss id=Return_Values><a class=permalink href=#Return_Values>Return Values</a></h2> Lua return statements take the form: <div class="Bd Pp Bd-indent"><pre>
return ret0, ret1, ret2, ...
</pre></div><p class=Pp>Return statements returning multiple values are permitted internally in a channel program script, but attempting to return more than one value from the top level of the channel program is not permitted and will throw an error. However, tables containing multiple values can still be returned. If invoked from the command line, a return statement:</p><div class="Bd Pp Bd-indent"><pre>
a = {foo="bar", baz=2}
return a
</pre></div><p class=Pp>Will be output formatted as:</p><div class="Bd Pp Bd-indent"><pre>
Channel program fully executed with return value:
    return:
        baz: 2
        foo: 'bar'
</pre></div></section><section class=Ss><h2 class=Ss id=Fatal_Errors><a class=permalink href=#Fatal_Errors>Fatal Errors</a></h2> If the channel program encounters a fatal error while running, a non-zero exit status will be returned. If more information about the error is available, a singleton list will be returned detailing the error: <div class="Bd Pp Bd-indent"><pre>
error: "error string, including Lua stack trace"
</pre></div><p class=Pp>If a fatal error is returned, the channel program may have not executed at all, may have partially executed, or may have fully executed but failed to pass a return value back to userland.</p><p class=Pp>If the channel program exhausts an instruction or memory limit, a fatal error will be generated and the program will be stopped, leaving the program partially executed. No attempt is made to reverse or undo any operations already performed. Note that because both the instruction count and amount of memory used by a channel program are deterministic when run against the same inputs and filesystem state, as long as a channel program has run successfully once, you can guarantee that it will finish successfully against a similar size system.</p><p class=Pp>If a channel program attempts to return too large a value, the program will fully execute but exit with a nonzero status code and no return value.</p><p class=Pp><i class=Em>Note:</i> ZFS API functions do not generate Fatal Errors when correctly invoked, they return an error code and the channel program continues executing. See the <a class=Sx href=#ZFS_API>ZFS API</a> section below for function-specific details on error return codes.</p></section><section class=Ss><h2 class=Ss id=Lua_to_C_Value_Conversion><a class=permalink href=#Lua_to_C_Value_Conversion>Lua to C Value Conversion</a></h2> When invoking a channel program via the libZFS interface, it is necessary to translate arguments and return values from Lua values to their C equivalents, and vice-versa. <p class=Pp>There is a correspondence between nvlist values in C and Lua tables. A Lua table which is returned from the channel program will be recursively converted to an nvlist, with table values converted to their natural equivalents:</p><div class="Bd Pp Bd-indent"><pre>
string -&gt; string
number -&gt; int64
boolean -&gt; boolean_value
nil -&gt; boolean (no value)
table -&gt; nvlist
</pre></div><p class=Pp>Likewise, table keys are replaced by string equivalents as follows:</p><div class="Bd Pp Bd-indent"><pre>
string -&gt; no change
number -&gt; signed decimal string ("%lld")
boolean -&gt; "true" | "false"
</pre></div><p class=Pp>Any collision of table key strings (for example, the string "true" and a true boolean value) will cause a fatal error.</p><p class=Pp>Lua numbers are represented internally as signed 64-bit integers.</p></section></section><section class=Sh><h2 class=Sh id=LUA_STANDARD_LIBRARY><a class=permalink href=#LUA_STANDARD_LIBRARY>LUA STANDARD LIBRARY</a></h2> The following Lua built-in base library functions are available: <div class="Bd Pp Bd-indent"><pre>
assert                  rawlen
collectgarbage          rawget
error                   rawset
getmetatable            select
ipairs                  setmetatable
next                    tonumber
pairs                   tostring
rawequal                type
</pre></div><p class=Pp>All functions in the <i class=Em>coroutine</i>, <i class=Em>string</i>, and <i class=Em>table</i> built-in submodules are also available. A complete list and documentation of these modules is available in the Lua manual.</p><p class=Pp>The following functions base library functions have been disabled and are not available for use in channel programs:</p><div class="Bd Pp Bd-indent"><pre>
dofile
loadfile
load
pcall
print
xpcall
</pre></div></section><section class=Sh><h2 class=Sh id=ZFS_API><a class=permalink href=#ZFS_API>ZFS API</a></h2><section class=Ss><h2 class=Ss id=Function_Arguments><a class=permalink href=#Function_Arguments>Function Arguments</a></h2> Each API function takes a fixed set of required positional arguments and optional keyword arguments. For example, the destroy function takes a single positional string argument (the name of the dataset to destroy) and an optional "defer" keyword boolean argument. When using parentheses to specify the arguments to a Lua function, only positional arguments can be used: <div class="Bd Pp Bd-indent"><pre>
zfs.sync.destroy("rpool@snap")
</pre></div><p class=Pp>To use keyword arguments, functions must be called with a single argument that is a Lua table containing entries mapping integers to positional arguments and strings to keyword arguments:</p><div class="Bd Pp Bd-indent"><pre>
zfs.sync.destroy({1="rpool@snap", defer=true})
</pre></div><p class=Pp>The Lua language allows curly braces to be used in place of parenthesis as syntactic sugar for this calling convention:</p><div class="Bd Pp Bd-indent"><pre>
zfs.sync.snapshot{"rpool@snap", defer=true}
</pre></div></section><section class=Ss><h2 class=Ss id=Function_Return_Values><a class=permalink href=#Function_Return_Values>Function Return Values</a></h2> If an API function succeeds, it returns 0. If it fails, it returns an error code and the channel program continues executing. API functions do not generate Fatal Errors except in the case of an unrecoverable internal file system error. <p class=Pp>In addition to returning an error code, some functions also return extra details describing what caused the error. This extra description is given as a second return value, and will always be a Lua table, or Nil if no error details were returned. Different keys will exist in the error details table depending on the function and error case. Any such function may be called expecting a single return value:</p><div class="Bd Pp Bd-indent"><pre>
errno = zfs.sync.promote(dataset)
</pre></div><p class=Pp>Or, the error details can be retrieved:</p><div class="Bd Pp Bd-indent"><pre>
errno, details = zfs.sync.promote(dataset)
if (errno == EEXIST) then
    assert(details ~= Nil)
    list_of_conflicting_snapshots = details
end
</pre></div><p class=Pp>The following global aliases for API function error return codes are defined for use in channel programs:</p><div class="Bd Pp Bd-indent"><pre>
EPERM     ECHILD      ENODEV      ENOSPC
ENOENT    EAGAIN      ENOTDIR     ESPIPE
ESRCH     ENOMEM      EISDIR      EROFS
EINTR     EACCES      EINVAL      EMLINK
EIO       EFAULT      ENFILE      EPIPE
ENXIO     ENOTBLK     EMFILE      EDOM
E2BIG     EBUSY       ENOTTY      ERANGE
ENOEXEC   EEXIST      ETXTBSY     EDQUOT
EBADF     EXDEV       EFBIG
</pre></div></section><section class=Ss><h2 class=Ss id=API_Functions><a class=permalink href=#API_Functions>API Functions</a></h2> For detailed descriptions of the exact behavior of any zfs administrative operations, see the main <a class=Xr href=zfs.8.html>zfs(8)</a> manual page. <dl class=Bl-tag><dt><i class=Em>zfs.debug(msg)</i></dt><dd>Record a debug message in the zfs_dbgmsg log. A log of these messages can be printed via mdb's "::zfs_dbgmsg" command, or can be monitored live by running: <div class="Bd Pp Bd-indent"><pre>
  dtrace -n 'zfs-dbgmsg{trace(stringof(arg0))}'
    </pre></div><p class=Pp>msg (string)</p><div class="Bd Bd-indent">Debug message to be printed.</div></dd><dt><i class=Em>zfs.exists(dataset)</i></dt><dd>Returns true if the given dataset exists, or false if it doesn't. A fatal error will be thrown if the dataset is not in the target pool. That is, in a channel program running on rpool, zfs.exists("rpool/nonexistent_fs") returns false, but zfs.exists("somepool/fs_that_may_exist") will error. <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Dataset to check for existence. Must be in the target pool.</div></dd><dt><i class=Em>zfs.get_prop(dataset, property)</i></dt><dd>Returns two values. First, a string, number or table containing the property value for the given dataset. Second, a string containing the source of the property (i.e. the name of the dataset in which it was set or nil if it is readonly). Throws a Lua error if the dataset is invalid or the property doesn't exist. Note that Lua only supports int64 number types whereas ZFS number properties are uint64. This means very large values (like guid) may wrap around and appear negative. <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Filesystem or snapshot path to retrieve properties from.</div><p class=Pp>property (string)</p><div class="Bd Bd-indent">Name of property to retrieve. All filesystem, snapshot and volume properties are supported except for 'mounted' and 'iscsioptions.' Also supports the 'written@snap' and 'written#bookmark' properties and the '&lt;user|group&gt;&lt;quota|used&gt;@id' properties, though the id must be in numeric form.</div></dd></dl><dl class=Bl-tag><dt><b class=Sy>zfs.sync submodule</b></dt><dd>The sync submodule contains functions that modify the on-disk state. They are executed in "syncing context". <p class=Pp>The available sync submodule functions are as follows:</p><dl class=Bl-tag><dt><i class=Em>zfs.sync.destroy(dataset, [defer=true|false])</i></dt><dd>Destroy the given dataset. Returns 0 on successful destroy, or a nonzero error code if the dataset could not be destroyed (for example, if the dataset has any active children or clones). <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Filesystem or snapshot to be destroyed.</div><p class=Pp>[optional] defer (boolean)</p><div class="Bd Bd-indent">Valid only for destroying snapshots. If set to true, and the snapshot has holds or clones, allows the snapshot to be marked for deferred deletion rather than failing.</div></dd><dt><i class=Em>zfs.sync.promote(dataset)</i></dt><dd>Promote the given clone to a filesystem. Returns 0 on successful promotion, or a nonzero error code otherwise. If EEXIST is returned, the second return value will be an array of the clone's snapshots whose names collide with snapshots of the parent filesystem. <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Clone to be promoted.</div></dd><dt><i class=Em>zfs.sync.rollback(filesystem)</i></dt><dd>Rollback to the previous snapshot for a dataset. Returns 0 on successful rollback, or a nonzero error code otherwise. Rollbacks can be performed on filesystems or zvols, but not on snapshots or mounted datasets. EBUSY is returned in the case where the filesystem is mounted. <p class=Pp>filesystem (string)</p><div class="Bd Bd-indent">Filesystem to rollback.</div></dd><dt><i class=Em>zfs.sync.snapshot(dataset)</i></dt><dd>Create a snapshot of a filesystem. Returns 0 if the snapshot was successfully created, and a nonzero error code otherwise. <p class=Pp>Note: Taking a snapshot will fail on any pool older than legacy version 27. To enable taking snapshots from ZCP scripts, the pool must be upgraded.</p><p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Name of snapshot to create.</div></dd></dl></dd><dt><b class=Sy>zfs.check submodule</b></dt><dd>For each function in the zfs.sync submodule, there is a corresponding zfs.check function which performs a "dry run" of the same operation. Each takes the same arguments as its zfs.sync counterpart and returns 0 if the operation would succeed, or a non-zero error code if it would fail, along with any other error details. That is, each has the same behavior as the corresponding sync function except for actually executing the requested change. For example, <i class=Em>zfs.check.destroy("fs")</i> returns 0 if <i class=Em>zfs.sync.destroy("fs")</i> would successfully destroy the dataset. <p class=Pp>The available zfs.check functions are:</p><dl class=Bl-tag><dt><i class=Em>zfs.check.destroy(dataset, [defer=true|false])</i></dt><dd style="width: auto;"> </dd><dt><i class=Em>zfs.check.promote(dataset)</i></dt><dd style="width: auto;"> </dd><dt><i class=Em>zfs.check.rollback(filesystem)</i></dt><dd style="width: auto;"> </dd><dt><i class=Em>zfs.check.snapshot(dataset)</i></dt><dd style="width: auto;"> </dd></dl></dd><dt><b class=Sy>zfs.list submodule</b></dt><dd>The zfs.list submodule provides functions for iterating over datasets and properties. Rather than returning tables, these functions act as Lua iterators, and are generally used as follows: <div class="Bd Pp Bd-indent"><pre>
for child in zfs.list.children("rpool") do
    ...
end
    </pre></div><p class=Pp>The available zfs.list functions are:</p><dl class=Bl-tag><dt><i class=Em>zfs.list.clones(snapshot)</i></dt><dd>Iterate through all clones of the given snapshot. <p class=Pp>snapshot (string)</p><div class="Bd Bd-indent">Must be a valid snapshot path in the current pool.</div></dd><dt><i class=Em>zfs.list.snapshots(dataset)</i></dt><dd>Iterate through all snapshots of the given dataset. Each snapshot is returned as a string containing the full dataset name, e.g. "pool/fs@snap". <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Must be a valid filesystem or volume.</div></dd><dt><i class=Em>zfs.list.children(dataset)</i></dt><dd>Iterate through all direct children of the given dataset. Each child is returned as a string containing the full dataset name, e.g. "pool/fs/child". <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Must be a valid filesystem or volume.</div></dd><dt><i class=Em>zfs.list.properties(dataset)</i></dt><dd>Iterate through all user properties for the given dataset. <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Must be a valid filesystem, snapshot, or volume.</div></dd><dt><i class=Em>zfs.list.system_properties(dataset)</i></dt><dd>Returns an array of strings, the names of the valid system (non-user defined) properties for the given dataset. Throws a Lua error if the dataset is invalid. <p class=Pp>dataset (string)</p><div class="Bd Bd-indent">Must be a valid filesystem, snapshot or volume.</div></dd></dl></dd></dl></section></section><section class=Sh><h2 class=Sh id=EXAMPLES><a class=permalink href=#EXAMPLES>EXAMPLES</a></h2><section class=Ss><h2 class=Ss id=Example_1><a class=permalink href=#Example_1>Example 1</a></h2> The following channel program recursively destroys a filesystem and all its snapshots and children in a naive manner. Note that this does not involve any error handling or reporting. <div class="Bd Pp Bd-indent"><pre>
function destroy_recursive(root)
    for child in zfs.list.children(root) do
        destroy_recursive(child)
    end
    for snap in zfs.list.snapshots(root) do
        zfs.sync.destroy(snap)
    end
    zfs.sync.destroy(root)
end
destroy_recursive("pool/somefs")
</pre></div></section><section class=Ss><h2 class=Ss id=Example_2><a class=permalink href=#Example_2>Example 2</a></h2> A more verbose and robust version of the same channel program, which properly detects and reports errors, and also takes the dataset to destroy as a command line argument, would be as follows: <div class="Bd Pp Bd-indent"><pre>
succeeded = {}
failed = {}

function destroy_recursive(root)
    for child in zfs.list.children(root) do
        destroy_recursive(child)
    end
    for snap in zfs.list.snapshots(root) do
        err = zfs.sync.destroy(snap)
        if (err ~= 0) then
            failed[snap] = err
        else
            succeeded[snap] = err
        end
    end
    err = zfs.sync.destroy(root)
    if (err ~= 0) then
        failed[root] = err
    else
        succeeded[root] = err
    end
end

args = ...
argv = args["argv"]

destroy_recursive(argv[1])

results = {}
results["succeeded"] = succeeded
results["failed"] = failed
return results
</pre></div></section><section class=Ss><h2 class=Ss id=Example_3><a class=permalink href=#Example_3>Example 3</a></h2> The following function performs a forced promote operation by attempting to promote the given clone and destroying any conflicting snapshots. <div class="Bd Pp Bd-indent"><pre>
function force_promote(ds)
   errno, details = zfs.check.promote(ds)
   if (errno == EEXIST) then
       assert(details ~= Nil)
       for i, snap in ipairs(details) do
           zfs.sync.destroy(ds .. "@" .. snap)
       end
   elseif (errno ~= 0) then
       return errno
   end
   return zfs.sync.promote(ds)
end
</pre></div></section></section></div><table class=foot><tr><td class=foot-date>April 18, 2020</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>