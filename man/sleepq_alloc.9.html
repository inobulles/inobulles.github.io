<!DOCTYPE html>
<html><head><meta charset=utf-8><title>sleepq_alloc(9)</title><keywords content=man,sleepq_alloc></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>sleepq_alloc(9)</h1><table class=head><tr><td class=head-ltitle>SLEEPQUEUE(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>SLEEPQUEUE(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>init_sleepqueues</code>, <code class=Nm>sleepq_abort</code>, <code class=Nm>sleepq_add</code>, <code class=Nm>sleepq_alloc</code>, <code class=Nm>sleepq_broadcast</code>, <code class=Nm>sleepq_free</code>, <code class=Nm>sleepq_lock</code>, <code class=Nm>sleepq_lookup</code>, <code class=Nm>sleepq_release</code>, <code class=Nm>sleepq_remove</code>, <code class=Nm>sleepq_signal</code>, <code class=Nm>sleepq_set_timeout</code>, <code class=Nm>sleepq_set_timeout_sbt</code>, <code class=Nm>sleepq_sleepcnt</code>, <code class=Nm>sleepq_timedwait</code>, <code class=Nm>sleepq_timedwait_sig</code>, <code class=Nm>sleepq_type</code>, <code class=Nm>sleepq_wait</code>, <code class=Nm>sleepq_wait_sig</code> — <div class=Nd>manage the queues of sleeping threads</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/sys/param.h.html>sys/param.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/sleepqueue.h.html>sys/sleepqueue.h</a>&gt;</code><p class=Pp><var class=Ft>void</var><br><code class=Fn>init_sleepqueues</code>(<var class=Fa style="white-space: nowrap;">void</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_abort</code>(<var class=Fa style="white-space: nowrap;">struct thread *td</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_add</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">struct lock_object *lock</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int flags</var>, <var class=Fa style="white-space: nowrap;">int queue</var>);</p><p class=Pp><var class=Ft>struct sleepqueue *</var><br><code class=Fn>sleepq_alloc</code>(<var class=Fa style="white-space: nowrap;">void</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_broadcast</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int flags</var>, <var class=Fa style="white-space: nowrap;">int pri</var>, <var class=Fa style="white-space: nowrap;">int queue</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_free</code>(<var class=Fa style="white-space: nowrap;">struct sleepqueue *sq</var>);</p><p class=Pp><var class=Ft>struct sleepqueue *</var><br><code class=Fn>sleepq_lookup</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_lock</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_release</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_remove</code>(<var class=Fa style="white-space: nowrap;">struct thread *td</var>, <var class=Fa style="white-space: nowrap;">void *wchan</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_signal</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int flags</var>, <var class=Fa style="white-space: nowrap;">int pri</var>, <var class=Fa style="white-space: nowrap;">int queue</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_set_timeout</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int timo</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_set_timeout_sbt</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">sbintime_t sbt</var>, <var class=Fa style="white-space: nowrap;">sbintime_t pr</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>u_int</var><br><code class=Fn>sleepq_sleepcnt</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int queue</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_timedwait</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int pri</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_timedwait_sig</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int pri</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_type</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>sleepq_wait</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int pri</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>sleepq_wait_sig</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">int pri</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> Sleep queues provide a mechanism for suspending execution of a thread until some condition is met. Each queue is associated with a specific wait channel when it is active, and only one queue may be associated with a wait channel at any given point in time. The implementation of each wait channel splits its sleepqueue into 2 sub-queues in order to enable some optimizations on threads' wakeups. An active queue holds a list of threads that are blocked on the associated wait channel. Threads that are not blocked on a wait channel have an associated inactive sleep queue. When a thread blocks on a wait channel it donates its inactive sleep queue to the wait channel. When a thread is resumed, the wait channel that it was blocked on gives it an inactive sleep queue for later use. <p class=Pp>The <code class=Fn>sleepq_alloc</code>() function allocates an inactive sleep queue and is used to assign a sleep queue to a thread during thread creation. The <code class=Fn>sleepq_free</code>() function frees the resources associated with an inactive sleep queue and is used to free a queue during thread destruction.</p><p class=Pp>Active sleep queues are stored in a hash table hashed on the addresses pointed to by wait channels. Each bucket in the hash table contains a sleep queue chain. A sleep queue chain contains a spin mutex and a list of sleep queues that hash to that specific chain. Active sleep queues are protected by their chain's spin mutex. The <code class=Fn>init_sleepqueues</code>() function initializes the hash table of sleep queue chains.</p><p class=Pp>The <code class=Fn>sleepq_lock</code>() function locks the sleep queue chain associated with wait channel <var class=Fa>wchan</var>.</p><p class=Pp>The <code class=Fn>sleepq_lookup</code>() returns a pointer to the currently active sleep queue for that wait channel associated with <var class=Fa>wchan</var> or <code class=Dv>NULL</code> if there is no active sleep queue associated with argument <var class=Fa>wchan</var>. It requires the sleep queue chain associated with <var class=Fa>wchan</var> to have been locked by a prior call to <code class=Fn>sleepq_lock</code>().</p><p class=Pp>The <code class=Fn>sleepq_release</code>() function unlocks the sleep queue chain associated with <code class=Fn>wchan</code>() and is primarily useful when aborting a pending sleep request before one of the wait functions is called.</p><p class=Pp>The <code class=Fn>sleepq_add</code>() function places the current thread on the sleep queue associated with the wait channel <var class=Fa>wchan</var>. The sleep queue chain associated with argument <var class=Fa>wchan</var> must be locked by a prior call to <code class=Fn>sleepq_lock</code>() when this function is called. If a lock is specified via the <var class=Fa>lock</var> argument, and if the kernel was compiled with <code class=Cd>options INVARIANTS</code>, then the sleep queue code will perform extra checks to ensure that the lock is used by all threads sleeping on <var class=Fa>wchan</var>. The <var class=Fa>wmesg</var> parameter should be a short description of <var class=Fa>wchan</var>. The <var class=Fa>flags</var> parameter is a bitmask consisting of the type of sleep queue being slept on and zero or more optional flags. The <var class=Fa>queue</var> parameter specifies the sub-queue, in which the contending thread will be inserted.</p><p class=Pp>There are currently three types of sleep queues:</p><p class=Pp></p><dl class="Bl-tag Bl-compact"><dt><a class=permalink href=#SLEEPQ_CONDVAR><code class=Dv id=SLEEPQ_CONDVAR>SLEEPQ_CONDVAR</code></a></dt><dd>A sleep queue used to implement condition variables.</dd><dt><a class=permalink href=#SLEEPQ_SLEEP><code class=Dv id=SLEEPQ_SLEEP>SLEEPQ_SLEEP</code></a></dt><dd>A sleep queue used to implement <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=wakeup.9.html>wakeup(9)</a> and <a class=Xr href=wakeup_one.9.html>wakeup_one(9)</a>.</dd><dt><a class=permalink href=#SLEEPQ_PAUSE><code class=Dv id=SLEEPQ_PAUSE>SLEEPQ_PAUSE</code></a></dt><dd>A sleep queue used to implement <a class=Xr href=pause.9.html>pause(9)</a>.</dd></dl><p class=Pp>There are currently two optional flag:</p><p class=Pp></p><dl class="Bl-tag Bl-compact"><dt><a class=permalink href=#SLEEPQ_INTERRUPTIBLE><code class=Dv id=SLEEPQ_INTERRUPTIBLE>SLEEPQ_INTERRUPTIBLE</code></a></dt><dd>The current thread is entering an interruptible sleep.</dd></dl><dl class="Bl-tag Bl-compact"><dt><a class=permalink href=#SLEEPQ_STOP_ON_BDRY><code class=Dv id=SLEEPQ_STOP_ON_BDRY>SLEEPQ_STOP_ON_BDRY</code></a></dt><dd>When thread is entering an interruptible sleep, do not stop it upon arrival of stop action, like <code class=Dv>SIGSTOP</code>. Wake it up instead.</dd></dl><p class=Pp>A timeout on the sleep may be specified by calling <code class=Fn>sleepq_set_timeout</code>() after <code class=Fn>sleepq_add</code>(). The <var class=Fa>wchan</var> parameter should be the same value from the preceding call to <code class=Fn>sleepq_add</code>(), and the sleep queue chain associated with <var class=Fa>wchan</var> must have been locked by a prior call to <code class=Fn>sleepq_lock</code>(). The <var class=Fa>timo</var> parameter should specify the timeout value in ticks.</p><p class=Pp><code class=Fn>sleepq_set_timeout_sbt</code>() function takes <var class=Fa>sbt</var> argument instead of <var class=Fa>timo</var>. It allows to specify relative or absolute wakeup time with higher resolution in form of <var class=Vt>sbintime_t</var>. The parameter <var class=Fa>pr</var> allows to specify wanted absolute event precision. The parameter <var class=Fa>flags</var> allows to pass additional <code class=Fn>callout_reset_sbt</code>() flags.</p><p class=Pp>Once the thread is ready to suspend, one of the wait functions is called to put the current thread to sleep until it is awakened and to context switch to another thread. The <code class=Fn>sleepq_wait</code>() function is used for non-interruptible sleeps that do not have a timeout. The <code class=Fn>sleepq_timedwait</code>() function is used for non-interruptible sleeps that have had a timeout set via <code class=Fn>sleepq_set_timeout</code>(). The <code class=Fn>sleepq_wait_sig</code>() function is used for interruptible sleeps that do not have a timeout. The <code class=Fn>sleepq_timedwait_sig</code>() function is used for interruptible sleeps that do have a timeout set. The <var class=Fa>wchan</var> argument to all of the wait functions is the wait channel being slept on. The sleep queue chain associated with argument <var class=Fa>wchan</var> needs to have been locked with a prior call to <code class=Fn>sleepq_lock</code>(). The <var class=Fa>pri</var> argument is used to set the priority of the thread when it is awakened. If it is set to zero, the thread's priority is left alone.</p><p class=Pp>When the thread is resumed, the wait functions return a non-zero value if the thread was awakened due to an interrupt other than a signal or a timeout. If the sleep timed out, then <code class=Er>EWOULDBLOCK</code> is returned. If the sleep was interrupted by something other than a signal, then some other return value will be returned.</p><p class=Pp>A sleeping thread is normally resumed by the <code class=Fn>sleepq_broadcast</code>() and <code class=Fn>sleepq_signal</code>() functions. The <code class=Fn>sleepq_signal</code>() function awakens the highest priority thread sleeping on a wait channel (if SLEEPQ_UNFAIR flag is set, thread that went to sleep recently) while <code class=Fn>sleepq_broadcast</code>() awakens all of the threads sleeping on a wait channel. The <var class=Fa>wchan</var> argument specifics which wait channel to awaken. The <var class=Fa>flags</var> argument must match the sleep queue type contained in the <var class=Fa>flags</var> argument passed to <code class=Fn>sleepq_add</code>() by the threads sleeping on the wait channel. If the <var class=Fa>pri</var> argument does not equal -1, then each thread that is awakened will have its priority raised to <var class=Fa>pri</var> if it has a lower priority. The sleep queue chain associated with argument <var class=Fa>wchan</var> must be locked by a prior call to <code class=Fn>sleepq_lock</code>() before calling any of these functions. The <var class=Fa>queue</var> argument specifies the sub-queue, from which threads need to be woken up.</p><p class=Pp>A thread in an interruptible sleep can be interrupted by another thread via the <code class=Fn>sleepq_abort</code>() function. The <var class=Fa>td</var> argument specifies the thread to interrupt. An individual thread can also be awakened from sleeping on a specific wait channel via the <code class=Fn>sleepq_remove</code>() function. The <var class=Fa>td</var> argument specifies the thread to awaken and the <var class=Fa>wchan</var> argument specifies the wait channel to awaken it from. If the thread <var class=Fa>td</var> is not blocked on the wait channel <var class=Fa>wchan</var> then this function will not do anything, even if the thread is asleep on a different wait channel. This function should only be used if one of the other functions above is not sufficient. One possible use is waking up a specific thread from a widely shared sleep channel.</p><p class=Pp>The <code class=Fn>sleepq_sleepcnt</code>() function offer a simple way to retrieve the number of threads sleeping for the specified <var class=Fa>queue</var>, given a <var class=Fa>wchan</var>.</p><p class=Pp>The <code class=Fn>sleepq_type</code>() function returns the type of <var class=Fa>wchan</var> associated to a sleepqueue.</p><p class=Pp>The <code class=Fn>sleepq_abort</code>(), <code class=Fn>sleepq_broadcast</code>(), and <code class=Fn>sleepq_signal</code>() functions all return a boolean value. If the return value is true, then at least one thread was resumed that is currently swapped out. The caller is responsible for awakening the scheduler process so that the resumed thread will be swapped back in. This is done by calling the <code class=Fn>kick_proc0</code>() function after releasing the sleep queue chain lock via a call to <code class=Fn>sleepq_release</code>().</p><p class=Pp>The sleep queue interface is currently used to implement the <a class=Xr href=sleep.9.html>sleep(9)</a> and <a class=Xr href=condvar.9.html>condvar(9)</a> interfaces. Almost all other code in the kernel should use one of those interfaces rather than manipulating sleep queues directly.</p></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=condvar.9.html>condvar(9)</a>, <a class=Xr href=runqueue.9.html>runqueue(9)</a>, <a class=Xr href=scheduler.9.html>scheduler(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=timeout.9.html>timeout(9)</a></section></div><table class=foot><tr><td class=foot-date>June 19, 2019</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>