<!DOCTYPE html>
<html><head><meta charset=utf-8><title>ipnat(5)</title><keywords content=man,ipnat></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>ipnat(5)</h1><table class=head><tr><td class=head-ltitle>IPNAT(5)</td><td class=head-vol>FreeBSD File Formats Manual</td><td class=head-rtitle>IPNAT(5)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2> ipnat, ipnat.conf - IPFilter NAT file format </section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <b>ipnat.conf</b> file is used to specify rules for the Network Address Translation (NAT) component of IPFilter. To load rules specified in the <b>ipnat.conf</b> file, the <b>ipnat(8)</b> program is used. <p class=Pp>For standard NAT functionality, a rule should start with <b>map</b> and then proceeds to specify the interface for which outgoing packets will have their source address rewritten. Following this it is expected that the old source address, and optionally port number, will be specified.</p><p class=Pp>In general, all NAT rules conform to the following layout: the first word indicates what type of NAT rule is present, this is followed by some stanzas to match a packet, followed by a "-&gt;" and this is then followed by several more stanzas describing the new data to be put in the packet.</p><p class=Pp>In this text and in others, use of the term "left hand side" (LHS) when talking about a NAT rule refers to text that appears before the "-&gt;" and the "right hand side" (RHS) for text that appears after it. In essence, the LHS is the packet matching and the RHS is the new data to be used.</p></section><section class=Sh><h2 class=Sh id=VARIABLES><a class=permalink href=#VARIABLES>VARIABLES</a></h2> This configuration file, like all others used with IPFilter, supports the use of variable substitution throughout the text. <pre>
nif="ppp0";
map $nif 0/0 -&gt; 0/32
</pre><p class=Pp>would become</p><pre>
map ppp0 0/0 -&gt; 0/32
</pre><p class=Pp>Variables can be used recursively, such as 'foo="$bar baz";', so long as $bar exists when the parser reaches the assignment for foo.</p><p class=Pp>See <b>ipnat(8)</b> for instructions on how to define variables to be used from a shell environment.</p></section><section class=Sh><h2 class=Sh id="OUTBOUND_SOURCE_TRANSLATION_(map'ing)"><a class=permalink href="#OUTBOUND_SOURCE_TRANSLATION_(map'ing)">OUTBOUND SOURCE TRANSLATION (map'ing)</a></h2> Changing the source address of a packet is traditionally performed using <b>map</b> rules. Both the source address and optionally port number can be changed according to various controls. <p class=Pp>To start out with, a common rule used is of the form:</p><pre>
map le0 0/0 -&gt; 0/32
</pre><p class=Pp>Here we're saying change the source address of all packets going out of le0 (the address/mask pair of 0/0 matching all packets) to that of the interface le0 (0/32 is a synonym for the interface's own address at the current point in time.) If we wanted to pass the packet through with no change in address, we would write it as:</p><pre>
map le0 0/0 -&gt; 0/0
</pre><p class=Pp>If we only want to change a portion of our internal network and to a different address that is routed back through this host, we might do:</p><pre>
map le0 10.1.1.0/24 -&gt; 192.168.55.3/32
</pre><p class=Pp>In some instances, we may have an entire subnet to map internal addresses out onto, in which case we can express the translation as this:</p><pre>
map le0 10.0.0.0/8 -&gt; 192.168.55.0/24
</pre><p class=Pp>IPFilter will cycle through each of the 256 addresses in the 192.168.55.0/24 address space to ensure that they all get used.</p><p class=Pp>Of course this poses a problem for TCP and UDP, with many connections made, each with its own port number pair. If we're unlucky, translations can be dropped because the new address/port pair mapping already exists. To mitigate this problem, we add in port translation or port mapping:</p><pre>
map le0 10.0.0.0/8 -&gt; 192.168.55.0/24 portmap tcp/udp auto
</pre><p class=Pp>In this instance, the word "auto" tells IPFilter to calculate a private range of port numbers for each address on the LHS to use without fear of them being trampled by others. This can lead to problems if there are connections being generated more quickly than IPFilter can expire them. In this instance, and if we want to get away from a private range of port numbers, we can say:</p><pre>
map le0 10.0.0.0/8 -&gt; 192.168.55.0/24 portmap tcp/udp 5000:65000
</pre><p class=Pp>And now each connection through le0 will add to the enumeration of the port number space 5000-65000 as well as the IP address subnet of 192.168.55.0/24.</p><p class=Pp>If the new addresses to be used are in a consecutive range, rather than a complete subnet, we can express this as:</p><pre>
map le0 10.0.0.0/8 -&gt; range 192.168.55.10-192.168.55.249
                      portmap tcp/udp 5000:65000
</pre><p class=Pp>This tells IPFilter that it has a range of 240 IP address to use, from 192.168.55.10 to 192.168.55.249, inclusive.</p><p class=Pp>If there were several ranges of addresses for use, we can use each one in a round-robin fashion as followed:</p><pre>
map le0 10.0.0.0/8 -&gt; range 192.168.55.10-192.168.55.29
                      portmap tcp/udp 5000:65000 round-robin
map le0 10.0.0.0/8 -&gt; range 192.168.55.40-192.168.55.49
                      portmap tcp/udp 5000:65000 round-robin
</pre><p class=Pp>To specify translation rules that impact a specific IP protocol, the protocol name or number is appended to the rule like this:</p><pre>
map le0 10.0.0.0/8 -&gt; 192.168.55.0/24 tcp/udp
map le0 10.0.0.0/8 -&gt; 192.168.55.1/32 icmp
map le0 10.0.0.0/8 -&gt; 192.168.55.2/32 gre
</pre><p class=Pp>For TCP connections exiting a connection such as PPPoE where the MTU is slightly smaller than normal ethernet, it can be useful to reduce the Maximum Segment Size (MSS) offered by the internal machines to match, reducing the liklihood that the either end will attempt to send packets that are too big and result in fragmentation. This is acheived using the <b>mssclamp</b> option with TCP <b>map</b> rules like this:</p><pre>
map pppoe0 0/0 -&gt; 0/32 mssclamp 1400 tcp
</pre><p class=Pp>For ICMP packets, we can map the ICMP id space in query packets:</p><pre>
map le0 10.0.0.0/8 -&gt; 192.168.55.1/32 icmpidmap icmp 1000:20000
</pre><p class=Pp>If we wish to be more specific about our initial matching criteria on the LHS, we can expand to using a syntax more similar to that in <b>ipf.conf(5)</b> :</p><pre>
map le0 from 10.0.0.0/8 to 26.0.0.0/8 -&gt;
                      192.168.55.1
map le0 from 10.0.0.0/8 port &gt; 1024 to 26.0.0.0/8 -&gt;
                      192.168.55.2 portmap 5000:9999 tcp/udp
map le0 from 10.0.0.0/8 ! to 26.0.0.0/8 -&gt;
                      192.168.55.3 portmap 5000:9999 tcp/udp
</pre><dl class=Bl-tag><dt><b>NOTE:</b></dt><dd>negation matching with source addresses is <b>NOT</b> possible with <b>map</b> / <b>map-block</b> rules.</dd></dl><p class=Pp>The NAT code has builtin default timeouts for TCP, UDP, ICMP and another for all other protocols. In general, the timeout for an entry to be deleted shrinks once a reply packet has been seen (excluding TCP.) If you wish to specify your own timeouts, this can be achieved either by setting one timeout for both directions:</p><pre>
map le0 0/0 -&gt; 0/32 gre age 30
</pre><p class=Pp>or setting a different timeout for the reply:</p><pre>
map le0 from any to any port = 53 -&gt; 0/32 age 60/10 udp
</pre><p class=Pp>A pressing problem that many people encounter when using NAT is that the address protocol can be embedded inside an application's communication. To address this problem, IPFilter provides a number of built-in proxies for the more common trouble makers, such as FTP. These proxies can be used as follows:</p><pre>
map le0 0/0 -&gt; 0/32 proxy port 21 ftp/tcp
</pre><p class=Pp>In this rule, the word "proxy" tells us that we want to connect up this translation with an internal proxy. The "port 21" is an extra restriction that requires the destination port number to be 21 if this rule is to be activated. The word "ftp" is the proxy identifier that the kernel will try and resolve internally, "tcp" the protocol that packets must match.</p><p class=Pp>See below for a list of proxies and their relative staus.</p><p class=Pp>To associate NAT rules with filtering rules, it is possible to set and match tags during either inbound or outbound processing. At present the tags for forwarded packets are not preserved by forwarding, so once the packet leaves IPFilter, the tag is forgotten. For <b>map</b> rules, we can match tags set by filter rules like this:</p><pre>
map le0 0/0 -&gt; 0/32 proxy portmap 5000:5999 tag lan1 tcp
</pre><p class=Pp>This would be used with "pass out" rules that includes a stanza such as "set-tag (nat = lan1)".</p><p class=Pp>If the interface in which packets are received is different from the interface on which packets are sent out, then the translation rule needs to be written to take this into account:</p><pre>
map hme0,le0 0/0 -&gt; 0/32
</pre><p class=Pp>Although this might seem counterintuitive, the interfaces when listed in rules for <b>ipnat.conf</b> are always in the <i>inbound</i> , <i>outbound</i> order. In this case, hme0 would be the return interface and le0 would be the outgoing interface. If you wish to allow return packets on any interface, the correct syntax to use would be:</p><pre>
map *,le0 0/0 -&gt; 0/32
</pre><p class=Pp>A special variant of <b>map</b> rules exists, called <b>map-block.</b> This command is intended for use when there is a large network to be mapped onto a smaller network, where the difference in netmasks is upto 14 bits difference in size. This is achieved by dividing the address space and port space up to ensure that each source address has its own private range of ports to use. For example, this rule:</p><pre>
map-block ppp0 172.192.0.0/16 -&gt; 209.1.2.0/24 ports auto
</pre><p class=Pp>would result in 172.192.0.0/24 being mapped to 209.1.2.0/32 with each address, from 172.192.0.0 to 172.192.0.255 having 252 ports of its own. As opposed to the above use of <b>map</b>, if for some reason the user of (say) 172.192.0.2 wanted 260 simultaneous connections going out, they would be limited to 252 with <b>map-block</b> but would just <i>move on</i> to the next IP address with the <b>map</b> command.</p><section class=Ss><h2 class=Ss id=Extended_matching><a class=permalink href=#Extended_matching>Extended matching</a></h2> If it is desirable to match on both the source and destination of a packet before applying an address translation to it, this can be achieved by using the same from-to syntax as is used in <b>ipf.conf</b>(5). What follows applies equally to the <b>map</b> rules discussed above and <b>rdr</b> rules discussed below. A simple example is as follows: <pre>
map bge0 from 10.1.0.0/16 to 192.168.1.0/24 -&gt; 172.12.1.4
</pre><p class=Pp>This would only match packets that are coming from hosts that have a source address matching 10.1.0.0/16 and a destination matching 192.168.1.0/24. This can be expanded upon with ports for TCP like this:</p><pre>
rdr bge0 from 10.1.0.0/16 to any port = 25 -&gt; 127.0.0.1 port 2501 tcp
</pre><p class=Pp>Where only TCP packets from 10.1.0.0/16 to port 25 will be redirected to port 2501.</p><p class=Pp>As with <b>ipf.conf</b>(5), if we have a large set of networks or addresses that we would like to match up with then we can define a pool using <b>ippool</b>(8) in <b>ippool.conf</b>(5) and then refer to it in an <b>ipnat</b> rule like this:</p><pre>
map bge0 from pool/100 to any port = 25 -&gt; 127.0.0.1 port 2501 tcp
</pre><dl class=Bl-tag><dt><b>NOTE:</b></dt><dd>In this situation, the rule is considered to have a netmask of "0" and thus is looked at last, after any rules with /16's or /24's in them, <i>even if</i> the defined pool only has /24's or /32's. Pools may also be used <i>wherever</i> the from-to syntax in <b>ipnat.conf</b>(5) is allowed.</dd></dl></section></section><section class=Sh><h2 class=Sh id=INBOUND_DESTINATION_TRANSLATION_(redirection)><a class=permalink href=#INBOUND_DESTINATION_TRANSLATION_(redirection)>INBOUND DESTINATION TRANSLATION (redirection)</a></h2> Redirection of packets is used to change the destination fields in a packet and is supported for packets that are moving <i>in</i> on a network interface. While the same general syntax for <b>map</b> rules is supported, there are differences and limitations. <p class=Pp>Firstly, by default all redirection rules target a single IP address, not a network or range of network addresses, so a rule written like this:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.0
</pre><p class=Pp>Will not spread packets across all 256 IP addresses in that class C network. If you were to try a rule like this:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.0/24
</pre><p class=Pp>then you will receive a parsing error.</p><p class=Pp>The from-to source-destination matching used with <b>map</b> rules can be used with rdr rules, along with negation, however the restriction moves - only a source address match can be negated:</p><pre>
rdr le0 from 1.1.0.0/16 to any -&gt; 192.168.1.3
rdr le0 ! from 1.1.0.0/16 to any -&gt; 192.168.1.4
</pre><p class=Pp>If there is a consective set of addresses you wish to spread the packets over, then this can be done in one of two ways, the word "range" optional to preserve:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.1 - 192.168.1.5
rdr le0 0/0 -&gt; range 192.168.1.1 - 192.168.1.5
</pre><p class=Pp>If there are only two addresses to split the packets across, the recommended method is to use a comma (",") like this:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.1,192.168.1.2
</pre><p class=Pp>If there is a large group of destination addresses that are somewhat disjoint in nature, we can cycle through them using a <b>round-robin</b> technique like this:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.1,192.168.1.2 round-robin
rdr le0 0/0 -&gt; 192.168.1.5,192.168.1.7 round-robin
rdr le0 0/0 -&gt; 192.168.1.9 round-robin
</pre><p class=Pp>If there are a large number of redirect rules and hosts being targetted then it may be desirable to have all those from a single source address be targetted at the same destination address. To achieve this, the word <b>sticky</b> is appended to the rule like this:</p><pre>
rdr le0 0/0 -&gt; 192.168.1.1,192.168.1.2 sticky
rdr le0 0/0 -&gt; 192.168.1.5,192.168.1.7 round-robin sticky
rdr le0 0/0 -&gt; 192.168.1.9 round-robin sticky
</pre><p class=Pp>The <b>sticky</b> feature can only be combined with <b>round-robin</b> and the use of comma.</p><p class=Pp>For TCP and UDP packets, it is possible to both match on the destiantion port number and to modify it. For example, to change the destination port from 80 to 3128, we would use a rule like this:</p><pre>
rdr de0 0/0 port 80 -&gt; 127.0.0.1 port 3128 tcp
</pre><p class=Pp>If a range of ports is given on the LHS and a single port is given on the RHS, the entire range of ports is moved. For example, if we had this:</p><pre>
rdr le0 0/0 port 80-88 -&gt; 127.0.0.1 port 3128 tcp
</pre><p class=Pp>then port 80 would become 3128, port 81 would become 3129, etc. If we want to redirect a number of different pots to just a single port, an equals sign ("=") is placed before the port number on the RHS like this:</p><pre>
rdr le0 0/0 port 80-88 -&gt; 127.0.0.1 port = 3128 tcp
</pre><p class=Pp>In this case, port 80 goes to 3128, port 81 to 3128, etc.</p><p class=Pp>As with <b>map</b> rules, it is possible to manually set a timeout using the <b>age</b> option, like this:</p><pre>
rdr le0 0/0 port 53 -&gt; 127.0.0.1 port 10053 udp age 5/5
</pre><p class=Pp>The use of proxies is not restricted to <b>map</b> rules and outbound sessions. Proxies can also be used with redirect rules, although the syntax is slightly different:</p><pre>
rdr ge0 0/0 port 21 -&gt; 127.0.0.1 port 21 tcp proxy ftp
</pre><p class=Pp>For <b>rdr</b> rules, the interfaces supplied are in the same order as <b>map</b> rules - input first, then output. In situations where the outgoing interface is not certain, it is also possible to use a wildcard ("*") to effect a match on any interface.</p><pre>
rdr le0,* 0/0 -&gt; 192.168.1.0
</pre><p class=Pp>A single rule, with as many options set as possible would look something like this:</p><pre>
rdr le0,ppp0 9.8.7.6/32 port 80 -&gt; 1.1.1.1,1.1.1.2 port 80 tcp
    round-robin frag age 40/40 sticky mssclamp 1000 tag tagged
</pre></section><section class=Sh><h2 class=Sh id=REWRITING_SOURCE_AND_DESTINATION><a class=permalink href=#REWRITING_SOURCE_AND_DESTINATION>REWRITING SOURCE AND DESTINATION</a></h2> Whilst the above two commands provide a lot of flexibility in changing addressing fields in packets, often it can be of benefit to translate <i>both</i> source <b>and</b> destination at the same time or to change the source address on input or the destination address on output. Doing all of these things can be accomplished using <b>rewrite</b> NAT rules. <p class=Pp>A <b>rewrite</b> rule requires the same level of packet matching as before, protocol and source/destination information but in addition allows either <b>in</b> or <b>out</b> to be specified like this:</p><pre>
rewrite in on ppp0 proto tcp from any to any port = 80 -&gt;
	src 0/0 dst 127.0.0.1,3128;
rewrite out on ppp0 from any to any -&gt;
	src 0/32 dst 10.1.1.0/24;
</pre><p class=Pp>On the RHS we can specify both new source and destination information to place into the packet being sent out. As with other rules used in <b>ipnat.conf</b>, there are shortcuts syntaxes available to use the original address information (<b>0/0</b>) and the address associated with the network interface (<b>0/32</b>.) For TCP and UDP, both address and port information can be changed. At present it is only possible to specify either a range of port numbers to be used (<b>X-Y</b>) or a single port number (<b>= X</b>) as follows:</p><pre>
rewrite in on le0 proto tcp from any to any port = 80 -&gt;
	src 0/0,2000-20000 dst 127.0.0.1,port = 3128;
</pre><p class=Pp>There are four fields that are stepped through in enumerating the number space available for creating a new destination:</p><p class=Pp>source address</p><p class=Pp>source port</p><p class=Pp>destination address</p><p class=Pp>destination port</p><p class=Pp>If one of these happens to be a static then it will be skipped and the next one incremented. As an example:</p><pre>
rewrite out on le0 proto tcp from any to any port = 80 -&gt;
	src 1.0.0.0/8,5000-5999 dst 2.0.0.0/24,6000-6999;
</pre><p class=Pp>The translated packets would be:</p><p class=Pp>1st src=1.0.0.1,5000 dst=2.0.0.1,6000</p><p class=Pp>2nd src=1.0.0.2,5000 dst=2.0.0.1,6000</p><p class=Pp>3rd src=1.0.0.2,5001 dst=2.0.0.1,6000</p><p class=Pp>4th src=1.0.0.2,5001 dst=2.0.0.2,6000</p><p class=Pp>5th src=1.0.0.2,5001 dst=2.0.0.2,6001</p><p class=Pp>6th src=1.0.0.3,5001 dst=2.0.0.2,6001</p><p class=Pp>and so on.</p><p class=Pp>As with <b>map</b> rules, it is possible to specify a range of addresses by including the word <i>range</i> before the addresses:</p><pre>
rewrite from any to any port = 80 -&gt;
	src 1.1.2.3 - 1.1.2.6 dst 2.2.3.4 - 2.2.3.6;
</pre></section><section class=Sh><h2 class=Sh id=DIVERTING_PACKETS><a class=permalink href=#DIVERTING_PACKETS>DIVERTING PACKETS</a></h2> If you'd like to send packets to a UDP socket rather than just another computer to be decapsulated, this can be achieved using a <b>divert</b> rule. <p class=Pp>Divert rules can be used with both inbound and outbound packet matching however the rule <b>must</b> specify host addresses for the outer packet, not ranges of addresses or netmasks, just single addresses. Additionally the syntax must supply required information for UDP. An example of what a divert rule looks ike is as follows:</p><pre>
divert in on le0 proto udp from any to any port = 53 -&gt;
	src 192.1.1.1,54 dst 192.168.1.22.1,5300;
</pre><p class=Pp>On the LHS is a normal set of matching capabilities but on the RHS it is a requirement to specify both the source and destination addresses and ports.</p><p class=Pp>As this feature is intended to be used with targetting packets at sockets and not IPFilter running on other systems, there is no rule provided to <i>undivert</i> packets.</p><dl class=Bl-tag><dt><b>NOTE:</b></dt><dd>Diverted packets <i>may</i> be fragmented if the addition of the encapsulating IP header plus UDP header causes the packet to exceed the size allowed by the outbound network interface. At present it is not possible to cause Path MTU discovery to happen as this feature is intended to be transparent to both endpoints. <b>Path MTU Discovery</b> If Path MTU discovery is being used and the "do not fragment" flag is set in packets to be encapsulated, an ICMP error message will be sent back to the sender if the new packet would need to be fragmented.</dd></dl></section><section class=Sh><h2 class=Sh id=COMMON_OPTIONS><a class=permalink href=#COMMON_OPTIONS>COMMON OPTIONS</a></h2> This section deals with options that are available with all rules. <dl class=Bl-tag><dt><b>purge</b></dt><dd>When the purge keyword is added to the end of a NAT rule, it will cause all of the active NAT sessions to be removed when the rule is removed as an individual operation. If all of the NAT rules are flushed out, it is expected that the operator will similarly flush the NAT table and thus NAT sessions are not removed when the NAT rules are flushed out.</dd></dl></section><section class=Sh><h2 class=Sh id=RULE_ORDERING><a class=permalink href=#RULE_ORDERING>RULE ORDERING</a></h2><b>NOTE:</b> Rules in <b>ipnat.conf</b> are read in sequentially as listed and loaded into the kernel in this fashion <b>BUT</b> packet matching is done on <b>netmask</b>, going from 32 down to 0. If a rule uses <b>pool</b> or <b>hash</b> to reference a set of addresses or networks, the netmask value for these fields is considered to be "0". So if your <b>ipnat.conf</b> has the following rules: <pre>
rdr le0 192.0.0.0/8 port 80 -&gt; 127.0.0.1 3132 tcp
rdr le0 192.2.0.0/16 port 80 -&gt; 127.0.0.1 3131 tcp
rdr le0 from any to pool/100 port 80 -&gt; 127.0.0.1 port 3130 tcp
rdr le0 192.2.2.0/24 port 80 -&gt; 127.0.0.1 3129 tcp
rdr le0 192.2.2.1 port 80 -&gt; 127.0.0.1 3128 tcp
</pre><p class=Pp>then the rule with 192.2.2.1 will match <b>first</b>, regardless of where it appears in the ordering of the above rules. In fact, the order in which they would be used to match a packet is:</p><pre>
rdr le0 192.2.2.1 port 80 -&gt; 127.0.0.1 3128 tcp
rdr le0 192.2.2.0/24 port 80 -&gt; 127.0.0.1 3129 tcp
rdr le0 192.2.0.0/16 port 80 -&gt; 127.0.0.1 3131 tcp
rdr le0 192.0.0.0/8 port 80 -&gt; 127.0.0.1 3132 tcp
rdr le0 from any to pool/100 port 80 -&gt; 127.0.0.1 port 3130 tcp
</pre><p class=Pp>where the first line is actually a /32.</p><p class=Pp>If your <b>ipnat.conf</b> file has entries with matching target fields (source address for <b>map</b> rules and destination address for <b>rdr</b> rules), then the ordering in the <b>ipnat.conf</b> file does matter. So if you had the following:</p><pre>
rdr le0 from 1.1.0.0/16 to 192.2.2.1 port 80 -&gt; 127.0.0.1 3129 tcp
rdr le0 from 1.1.1.0/24 to 192.2.2.1 port 80 -&gt; 127.0.0.1 3128 tcp
</pre><p class=Pp>Then no packets will match the 2nd rule, they'll all match the first.</p></section><section class=Sh><h2 class=Sh id=IPv6><a class=permalink href=#IPv6>IPv6</a></h2> In all of the examples above, where an IPv4 address is present, an IPv6 address can also be used. All rules must use either IPv4 addresses with both halves of the NAT rule or IPv6 addresses for both halves. Mixing IPv6 addresses with IPv4 addresses, in a single rule, will result in an error. <p class=Pp>For shorthand notations such as "0/32", the equivalent for IPv6 is "0/128". IPFilter will treat any netmask greater than 32 as an implicit direction that the address should be IPv6, not IPv4. To be unambiguous with 0/0, for IPv6 use ::0/0.</p></section><section class=Sh><h2 class=Sh id=KERNEL_PROXIES><a class=permalink href=#KERNEL_PROXIES>KERNEL PROXIES</a></h2> IP Filter comes with a few, simple, proxies built into the code that is loaded into the kernel to allow secondary channels to be opened without forcing the packets through a user program. The current state of the proxies is listed below, as one of three states: <p class="Pp HP">Aging - protocol is roughly understood from the time at which the proxy was written but it is not well tested or maintained;</p><p class="Pp HP">Developmental - basic functionality exists, works most of the time but may be problematic in extended real use;</p><p class="Pp HP">Experimental - rough support for the protocol at best, may or may not work as testing has been at best sporadic, possible large scale changes to the code in order to properly support the protocol.</p><p class="Pp HP">Mature - well tested, protocol is properly understood by the proxy;</p><p class=Pp>The currently compiled in proxy list is as follows:</p><dl class=Bl-tag><dt>FTP - Mature</dt><dd>(map ... proxy port ftp ftp/tcp)</dd><dt>IRC - Experimental</dt><dd>(proxy port 6667 irc/tcp)</dd><dt>rpcbind - Experimental</dt><dd></dd><dt>PPTP - Experimental</dt><dd></dd><dt>H.323 - Experimental</dt><dd>(map ... proxy port 1720 h323/tcp)</dd><dt>Real Audio (PNA) - Aging</dt><dd></dd><dt>DNS - Developmental</dt><dd>(map ... proxy port 53 dns/udp { block .cnn.com; })</dd><dt>IPsec - Developmental</dt><dd>(map ... proxy port 500 ipsec/tcp)</dd><dt>netbios - Experimental</dt><dd></dd><dt>R-command - Mature</dt><dd>(map ... proxy port shell rcmd/tcp)</dd></dl></section><section class=Sh><h2 class=Sh id=KERNEL_PROXIES_2><a class=permalink href=#KERNEL_PROXIES_2>KERNEL PROXIES</a></h2></section><section class=Sh><h2 class=Sh id=FILES><a class=permalink href=#FILES>FILES</a></h2> /dev/ipnat <br> /etc/protocols <br> /etc/services <br> /etc/hosts </section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2> ipnat(4), hosts(5), ipf(5), services(5), ipf(8), ipnat(8) </section></div><table class=foot><tr><td class=foot-date></td><td class=foot-os></td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>