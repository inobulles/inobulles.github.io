<!DOCTYPE html>
<html><head><meta charset=utf-8><title>locking(9)</title><keywords content=man,locking></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>locking(9)</h1><table class=head><tr><td class=head-ltitle>LOCKING(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>LOCKING(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>locking</code> — <div class=Nd>kernel synchronization primitives</div></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <i class=Em>FreeBSD</i> kernel is written to run across multiple CPUs and as such provides several different synchronization primitives to allow developers to safely access and manipulate many data types. <section class=Ss><h2 class=Ss id=Mutexes><a class=permalink href=#Mutexes>Mutexes</a></h2> Mutexes (also called "blocking mutexes") are the most commonly used synchronization primitive in the kernel. A thread acquires (locks) a mutex before accessing data shared with other threads (including interrupt threads), and releases (unlocks) it afterwards. If the mutex cannot be acquired, the thread requesting it will wait. Mutexes are adaptive by default, meaning that if the owner of a contended mutex is currently running on another CPU, then a thread attempting to acquire the mutex will spin rather than yielding the processor. Mutexes fully support priority propagation. <p class=Pp>See <a class=Xr href=mutex.9.html>mutex(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Spin_Mutexes><a class=permalink href=#Spin_Mutexes>Spin Mutexes</a></h2> Spin mutexes are a variation of basic mutexes; the main difference between the two is that spin mutexes never block. Instead, they spin while waiting for the lock to be released. To avoid deadlock, a thread that holds a spin mutex must never yield its CPU. Unlike ordinary mutexes, spin mutexes disable interrupts when acquired. Since disabling interrupts can be expensive, they are generally slower to acquire and release. Spin mutexes should be used only when absolutely necessary, e.g. to protect data shared with interrupt filter code (see <a class=Xr href=bus_setup_intr.9.html>bus_setup_intr(9)</a> for details), or for scheduler internals. </section><section class=Ss><h2 class=Ss id=Mutex_Pools><a class=permalink href=#Mutex_Pools>Mutex Pools</a></h2> With most synchronization primitives, such as mutexes, the programmer must provide memory to hold the primitive. For example, a mutex may be embedded inside the structure it protects. Mutex pools provide a preallocated set of mutexes to avoid this requirement. Note that mutexes from a pool may only be used as leaf locks. <p class=Pp>See <a class=Xr href=mtx_pool.9.html>mtx_pool(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Reader/Writer_Locks><a class=permalink href=#Reader/Writer_Locks>Reader/Writer Locks</a></h2> Reader/writer locks allow shared access to protected data by multiple threads or exclusive access by a single thread. The threads with shared access are known as <i class=Em>readers</i> since they should only read the protected data. A thread with exclusive access is known as a <i class=Em>writer</i> since it may modify protected data. <p class=Pp>Reader/writer locks can be treated as mutexes (see above and <a class=Xr href=mutex.9.html>mutex(9)</a>) with shared/exclusive semantics. Reader/writer locks support priority propagation like mutexes, but priority is propagated only to an exclusive holder. This limitation comes from the fact that shared owners are anonymous.</p><p class=Pp>See <a class=Xr href=rwlock.9.html>rwlock(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Read_Mostly_Locks><a class=permalink href=#Read_Mostly_Locks>Read-Mostly Locks</a></h2> Read-mostly locks are similar to <i class=Em>reader/writer</i> locks but optimized for very infrequent write locking. <i class=Em>Read-mostly</i> locks implement full priority propagation by tracking shared owners using a caller-supplied <i class=Em>tracker</i> data structure. <p class=Pp>See <a class=Xr href=rmlock.9.html>rmlock(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Sleepable_Read_Mostly_Locks><a class=permalink href=#Sleepable_Read_Mostly_Locks>Sleepable Read-Mostly Locks</a></h2> Sleepable read-mostly locks are a variation on read-mostly locks. Threads holding an exclusive lock may sleep, but threads holding a shared lock may not. Priority is propagated to shared owners but not to exclusive owners. </section><section class=Ss><h2 class=Ss id=Shared/exclusive_locks><a class=permalink href=#Shared/exclusive_locks>Shared/exclusive locks</a></h2> Shared/exclusive locks are similar to reader/writer locks; the main difference between them is that shared/exclusive locks may be held during unbounded sleep. Acquiring a contested shared/exclusive lock can perform an unbounded sleep. These locks do not support priority propagation. <p class=Pp>See <a class=Xr href=sx.9.html>sx(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Lockmanager_locks><a class=permalink href=#Lockmanager_locks>Lockmanager locks</a></h2> Lockmanager locks are sleepable shared/exclusive locks used mostly in <a class=Xr href=VFS.9.html>VFS(9)</a> (as a <a class=Xr href=vnode.9.html>vnode(9)</a> lock) and in the buffer cache (<a class=Xr href=BUF_LOCK.9.html>BUF_LOCK(9)</a>). They have features other lock types do not have such as sleep timeouts, blocking upgrades, writer starvation avoidance, draining, and an interlock mutex, but this makes them complicated both to use and to implement; for this reason, they should be avoided. <p class=Pp>See <a class=Xr href=lock.9.html>lock(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Counting_semaphores><a class=permalink href=#Counting_semaphores>Counting semaphores</a></h2> Counting semaphores provide a mechanism for synchronizing access to a pool of resources. Unlike mutexes, semaphores do not have the concept of an owner, so they can be useful in situations where one thread needs to acquire a resource, and another thread needs to release it. They are largely deprecated. <p class=Pp>See <a class=Xr href=sema.9.html>sema(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Condition_variables><a class=permalink href=#Condition_variables>Condition variables</a></h2> Condition variables are used in conjunction with locks to wait for a condition to become true. A thread must hold the associated lock before calling one of the <code class=Fn>cv_wait</code>(), functions. When a thread waits on a condition, the lock is atomically released before the thread yields the processor and reacquired before the function call returns. Condition variables may be used with blocking mutexes, reader/writer locks, read-mostly locks, and shared/exclusive locks. <p class=Pp>See <a class=Xr href=condvar.9.html>condvar(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Sleep/Wakeup><a class=permalink href=#Sleep/Wakeup>Sleep/Wakeup</a></h2> The functions <code class=Fn>tsleep</code>(), <code class=Fn>msleep</code>(), <code class=Fn>msleep_spin</code>(), <code class=Fn>pause</code>(), <code class=Fn>wakeup</code>(), and <code class=Fn>wakeup_one</code>() also handle event-based thread blocking. Unlike condition variables, arbitrary addresses may be used as wait channels and a dedicated structure does not need to be allocated. However, care must be taken to ensure that wait channel addresses are unique to an event. If a thread must wait for an external event, it is put to sleep by <code class=Fn>tsleep</code>(), <code class=Fn>msleep</code>(), <code class=Fn>msleep_spin</code>(), or <code class=Fn>pause</code>(). Threads may also wait using one of the locking primitive sleep routines <a class=Xr href=mtx_sleep.9.html>mtx_sleep(9)</a>, <a class=Xr href=rw_sleep.9.html>rw_sleep(9)</a>, or <a class=Xr href=sx_sleep.9.html>sx_sleep(9)</a>. <p class=Pp>The parameter <var class=Fa>chan</var> is an arbitrary address that uniquely identifies the event on which the thread is being put to sleep. All threads sleeping on a single <var class=Fa>chan</var> are woken up later by <code class=Fn>wakeup</code>() (often called from inside an interrupt routine) to indicate that the event the thread was blocking on has occurred.</p><p class=Pp>Several of the sleep functions including <code class=Fn>msleep</code>(), <code class=Fn>msleep_spin</code>(), and the locking primitive sleep routines specify an additional lock parameter. The lock will be released before sleeping and reacquired before the sleep routine returns. If <var class=Fa>priority</var> includes the <code class=Dv>PDROP</code> flag, then the lock will not be reacquired before returning. The lock is used to ensure that a condition can be checked atomically, and that the current thread can be suspended without missing a change to the condition or an associated wakeup. In addition, all of the sleep routines will fully drop the <var class=Va>Giant</var> mutex (even if recursed) while the thread is suspended and will reacquire the <var class=Va>Giant</var> mutex (restoring any recursion) before the function returns.</p><p class=Pp>The <code class=Fn>pause</code>() function is a special sleep function that waits for a specified amount of time to pass before the thread resumes execution. This sleep cannot be terminated early by either an explicit <code class=Fn>wakeup</code>() or a signal.</p><p class=Pp>See <a class=Xr href=sleep.9.html>sleep(9)</a> for details.</p></section><section class=Ss><h2 class=Ss id=Giant><a class=permalink href=#Giant>Giant</a></h2> Giant is a special mutex used to protect data structures that do not yet have their own locks. Since it provides semantics akin to the old <a class=Xr href=spl.9.html>spl(9)</a> interface, Giant has special characteristics: <ol class=Bl-enum><li>It is recursive.</li><li>Drivers can request that Giant be locked around them by not marking themselves MPSAFE. Note that infrastructure to do this is slowly going away as non-MPSAFE drivers either became properly locked or disappear.</li><li>Giant must be locked before other non-sleepable locks.</li><li>Giant is dropped during unbounded sleeps and reacquired after wakeup.</li><li>There are places in the kernel that drop Giant and pick it back up again. Sleep locks will do this before sleeping. Parts of the network or VM code may do this as well. This means that you cannot count on Giant keeping other code from running if your code sleeps, even if you want it to.</li></ol></section></section><section class=Sh><h2 class=Sh id=INTERACTIONS><a class=permalink href=#INTERACTIONS>INTERACTIONS</a></h2> The primitives can interact and have a number of rules regarding how they can and can not be combined. Many of these rules are checked by <a class=Xr href=witness.4.html>witness(4)</a>. <section class=Ss><h2 class=Ss id=Bounded_vs._Unbounded_Sleep><a class=permalink href=#Bounded_vs._Unbounded_Sleep>Bounded vs. Unbounded Sleep</a></h2> In a bounded sleep (also referred to as “blocking”) the only resource needed to resume execution of a thread is CPU time for the owner of a lock that the thread is waiting to acquire. In an unbounded sleep (often referred to as simply “sleeping”) a thread waits for an external event or for a condition to become true. In particular, a dependency chain of threads in bounded sleeps should always make forward progress, since there is always CPU time available. This requires that no thread in a bounded sleep is waiting for a lock held by a thread in an unbounded sleep. To avoid priority inversions, a thread in a bounded sleep lends its priority to the owner of the lock that it is waiting for. <p class=Pp>The following primitives perform bounded sleeps: mutexes, reader/writer locks and read-mostly locks.</p><p class=Pp>The following primitives perform unbounded sleeps: sleepable read-mostly locks, shared/exclusive locks, lockmanager locks, counting semaphores, condition variables, and sleep/wakeup.</p></section><section class=Ss><h2 class=Ss id=General_Principles><a class=permalink href=#General_Principles>General Principles</a></h2><ul class=Bl-bullet><li>It is an error to do any operation that could result in yielding the processor while holding a spin mutex.</li><li>It is an error to do any operation that could result in unbounded sleep while holding any primitive from the 'bounded sleep' group. For example, it is an error to try to acquire a shared/exclusive lock while holding a mutex, or to try to allocate memory with M_WAITOK while holding a reader/writer lock. <p class=Pp>Note that the lock passed to one of the <code class=Fn>sleep</code>() or <code class=Fn>cv_wait</code>() functions is dropped before the thread enters the unbounded sleep and does not violate this rule.</p></li><li>It is an error to do any operation that could result in yielding of the processor when running inside an interrupt filter.</li><li>It is an error to do any operation that could result in unbounded sleep when running inside an interrupt thread.</li></ul></section><section class=Ss><h2 class=Ss id=Interaction_table><a class=permalink href=#Interaction_table>Interaction table</a></h2> The following table shows what you can and can not do while holding one of the locking primitives discussed. Note that “sleep” includes <code class=Fn>sema_wait</code>(), <code class=Fn>sema_timedwait</code>(), any of the <code class=Fn>cv_wait</code>() functions, and any of the <code class=Fn>sleep</code>() functions. <table class="Bl-column Bd-indent"><tr><td><i class=Em> You want:</i></td><td>spin mtx</td><td>mutex/rw</td><td>rmlock</td><td>sleep rm</td><td>sx/lk</td><td>sleep</td></tr><tr><td><i class=Em>You have: </i></td><td>--------</td><td>--------</td><td>------</td><td>--------</td><td>------</td><td>------</td></tr><tr><td>spin mtx</td><td>ok</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no-1</td></tr><tr><td>mutex/rw</td><td>ok</td><td>ok</td><td>ok</td><td>no</td><td>no</td><td>no-1</td></tr><tr><td>rmlock</td><td>ok</td><td>ok</td><td>ok</td><td>no</td><td>no</td><td>no-1</td></tr><tr><td>sleep rm</td><td>ok</td><td>ok</td><td>ok</td><td>ok-2</td><td>ok-2</td><td>ok-2/3</td></tr><tr><td>sx</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok-3</td></tr><tr><td>lockmgr</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td></tr></table><p class=Pp><i class=Em>*1</i> There are calls that atomically release this primitive when going to sleep and reacquire it on wakeup (<code class=Fn>mtx_sleep</code>(), <code class=Fn>rw_sleep</code>(), <code class=Fn>msleep_spin</code>(), etc.).</p><p class=Pp><i class=Em>*2</i> These cases are only allowed while holding a write lock on a sleepable read-mostly lock.</p><p class=Pp><i class=Em>*3</i> Though one can sleep while holding this lock, one can also use a <code class=Fn>sleep</code>() function to atomically release this primitive when going to sleep and reacquire it on wakeup.</p><p class=Pp>Note that non-blocking try operations on locks are always permitted.</p></section><section class=Ss><h2 class=Ss id=Context_mode_table><a class=permalink href=#Context_mode_table>Context mode table</a></h2> The next table shows what can be used in different contexts. At this time this is a rather easy to remember table. <table class="Bl-column Bd-indent"><tr><td><i class=Em>Context:</i></td><td>spin mtx</td><td>mutex/rw</td><td>rmlock</td><td>sleep rm</td><td>sx/lk</td><td>sleep</td></tr><tr><td>interrupt filter:</td><td>ok</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr><tr><td>interrupt thread:</td><td>ok</td><td>ok</td><td>ok</td><td>no</td><td>no</td><td>no</td></tr><tr><td>callout:</td><td>ok</td><td>ok</td><td>ok</td><td>no</td><td>no</td><td>no</td></tr><tr><td>direct callout:</td><td>ok</td><td>no</td><td>no</td><td>no</td><td>no</td><td>no</td></tr><tr><td>system call:</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td><td>ok</td></tr></table></section></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=lockstat.1.html>lockstat(1)</a>, <a class=Xr href=witness.4.html>witness(4)</a>, <a class=Xr href=BUS_SETUP_INTR.9.html>BUS_SETUP_INTR(9)</a>, <a class=Xr href=condvar.9.html>condvar(9)</a>, <a class=Xr href=lock.9.html>lock(9)</a>, <a class=Xr href=LOCK_PROFILING.9.html>LOCK_PROFILING(9)</a>, <a class=Xr href=mtx_pool.9.html>mtx_pool(9)</a>, <a class=Xr href=mutex.9.html>mutex(9)</a>, <a class=Xr href=rmlock.9.html>rmlock(9)</a>, <a class=Xr href=rwlock.9.html>rwlock(9)</a>, <a class=Xr href=sema.9.html>sema(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=sx.9.html>sx(9)</a>, <a class=Xr href=timeout.9.html>timeout(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> These functions appeared in <span class=Ux>BSD/OS 4.1</span> through <span class=Ux>FreeBSD 7.0</span>. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> There are too many locking primitives to choose from. </section></div><table class=foot><tr><td class=foot-date>March 29, 2022</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>