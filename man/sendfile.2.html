<!DOCTYPE html>
<html><head><meta charset=utf-8><title>sendfile(2)</title><keywords content=man,sendfile></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>sendfile(2)</h1><table class=head><tr><td class=head-ltitle>SENDFILE(2)</td><td class=head-vol>FreeBSD System Calls Manual</td><td class=head-rtitle>SENDFILE(2)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>sendfile</code> — <div class=Nd>send a file to a socket</div></section><section class=Sh><h2 class=Sh id=LIBRARY><a class=permalink href=#LIBRARY>LIBRARY</a></h2><span class=Lb>Standard C Library (libc, -lc)</span></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/sys/types.h.html>sys/types.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/socket.h.html>sys/socket.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/uio.h.html>sys/uio.h</a>&gt;</code><p class=Pp><var class=Ft>int</var><br><code class=Fn>sendfile</code>(<var class=Fa>int fd</var>, <var class=Fa>int s</var>, <var class=Fa>off_t offset</var>, <var class=Fa>size_t nbytes</var>, <var class=Fa>struct sf_hdtr *hdtr</var>, <var class=Fa>off_t *sbytes</var>, <var class=Fa>int flags</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <code class=Fn>sendfile</code>() system call sends a regular file or shared memory object specified by descriptor <var class=Fa>fd</var> out a stream socket specified by descriptor <var class=Fa>s</var>. <p class=Pp>The <var class=Fa>offset</var> argument specifies where to begin in the file. Should <var class=Fa>offset</var> fall beyond the end of file, the system will return success and report 0 bytes sent as described below. The <var class=Fa>nbytes</var> argument specifies how many bytes of the file should be sent, with 0 having the special meaning of send until the end of file has been reached.</p><p class=Pp>An optional header and/or trailer can be sent before and after the file data by specifying a pointer to a <var class=Vt>struct sf_hdtr</var>, which has the following structure:</p><p class=Pp></p><div class="Bd Bd-indent"><pre>
struct sf_hdtr {
	struct iovec *headers;	/* pointer to header iovecs */
	int hdr_cnt;		/* number of header iovecs */
	struct iovec *trailers;	/* pointer to trailer iovecs */
	int trl_cnt;		/* number of trailer iovecs */
};
</pre></div><p class=Pp>The <var class=Fa>headers</var> and <var class=Fa>trailers</var> pointers, if non-<code class=Dv>NULL</code>, point to arrays of <var class=Vt>struct iovec</var> structures. See the <code class=Fn>writev</code>() system call for information on the iovec structure. The number of iovecs in these arrays is specified by <var class=Fa>hdr_cnt</var> and <var class=Fa>trl_cnt</var>.</p><p class=Pp>If non-<code class=Dv>NULL</code>, the system will write the total number of bytes sent on the socket to the variable pointed to by <var class=Fa>sbytes</var>.</p><p class=Pp>The least significant 16 bits of <var class=Fa>flags</var> argument is a bitmap of these values:</p><div class=Bd-indent><dl class=Bl-tag><dt><a class=permalink href=#SF_NODISKIO><code class=Dv id=SF_NODISKIO>SF_NODISKIO</code></a></dt><dd>This flag causes <code class=Nm>sendfile</code> to return <code class=Er>EBUSY</code> instead of blocking when a busy page is encountered. This rare situation can happen if some other process is now working with the same region of the file. It is advised to retry the operation after a short period. <p class=Pp>Note that in older <span class=Ux>FreeBSD</span> versions the <code class=Dv>SF_NODISKIO</code> had slightly different notion. The flag prevented <code class=Nm>sendfile</code> to run I/O operations in case if an invalid (not cached) page is encountered, thus avoiding blocking on I/O. Starting with <span class=Ux>FreeBSD 11</span><code class=Nm>sendfile</code> sending files off the <a class=Xr href=ffs.7.html>ffs(7)</a> filesystem does not block on I/O (see <a class=Sx href=#IMPLEMENTATION_NOTES>IMPLEMENTATION NOTES</a> ), so the condition no longer applies. However, it is safe if an application utilizes <code class=Dv>SF_NODISKIO</code> and on <code class=Er>EBUSY</code> performs the same action as it did in older <span class=Ux>FreeBSD</span> versions, e.g., <a class=Xr href=aio_read.2.html>aio_read(2)</a>, <a class=Xr href=read.2.html>read(2)</a> or <code class=Nm>sendfile</code> in a different context.</p></dd><dt><a class=permalink href=#SF_NOCACHE><code class=Dv id=SF_NOCACHE>SF_NOCACHE</code></a></dt><dd>The data sent to socket will not be cached by the virtual memory system, and will be freed directly to the pool of free pages.</dd><dt><a class=permalink href=#SF_SYNC><code class=Dv id=SF_SYNC>SF_SYNC</code></a></dt><dd><code class=Nm>sendfile</code> sleeps until the network stack no longer references the VM pages of the file, making subsequent modifications to it safe. Please note that this is not a guarantee that the data has actually been sent.</dd><dt><a class=permalink href=#SF_USER_READAHEAD><code class=Dv id=SF_USER_READAHEAD>SF_USER_READAHEAD</code></a></dt><dd><code class=Nm>sendfile</code> has some internal heuristics to do readahead when sending data. This flag forces <code class=Nm>sendfile</code> to override any heuristically calculated readahead and use exactly the application specified readahead. See <a class=Sx href=#SETTING_READAHEAD>SETTING READAHEAD</a> for more details on readahead.</dd></dl></div><p class=Pp>When using a socket marked for non-blocking I/O, <code class=Fn>sendfile</code>() may send fewer bytes than requested. In this case, the number of bytes successfully written is returned in <var class=Fa>*sbytes</var> (if specified), and the error <code class=Er>EAGAIN</code> is returned.</p></section><section class=Sh><h2 class=Sh id=SETTING_READAHEAD><a class=permalink href=#SETTING_READAHEAD>SETTING READAHEAD</a></h2><code class=Nm>sendfile</code> uses internal heuristics based on request size and file system layout to do readahead. Additionally application may request extra readahead. The most significant 16 bits of <var class=Fa>flags</var> specify amount of pages that <code class=Nm>sendfile</code> may read ahead when reading the file. A macro <code class=Fn>SF_FLAGS</code>() is provided to combine readahead amount and flags. An example showing specifying readahead of 16 pages and <code class=Dv>SF_NOCACHE</code> flag: <p class=Pp></p><div class="Bd Bd-indent"><pre>
	SF_FLAGS(16, SF_NOCACHE)
</pre></div><p class=Pp><code class=Nm>sendfile</code> will use either application specified readahead or internally calculated, whichever is bigger. Setting flag <code class=Dv>SF_USER_READAHEAD</code> would turn off any heuristics and set maximum possible readahead length to the number of pages specified via flags.</p></section><section class=Sh><h2 class=Sh id=IMPLEMENTATION_NOTES><a class=permalink href=#IMPLEMENTATION_NOTES>IMPLEMENTATION NOTES</a></h2> The <span class=Ux>FreeBSD</span> implementation of <code class=Fn>sendfile</code>() does not block on disk I/O when it sends a file off the <a class=Xr href=ffs.7.html>ffs(7)</a> filesystem. The syscall returns success before the actual I/O completes, and data is put into the socket later unattended. However, the order of data in the socket is preserved, so it is safe to do further writes to the socket. <p class=Pp>The <span class=Ux>FreeBSD</span> implementation of <code class=Fn>sendfile</code>() is "zero-copy", meaning that it has been optimized so that copying of the file data is avoided.</p></section><section class=Sh><h2 class=Sh id=TUNING><a class=permalink href=#TUNING>TUNING</a></h2><section class=Ss><h2 class=Ss id=physical_paging_buffers><a class=permalink href=#physical_paging_buffers>physical paging buffers</a></h2><code class=Fn>sendfile</code>() uses vnode pager to read file pages into memory. The pager uses a pool of physical buffers to run its I/O operations. When system runs out of pbufs, sendfile will block and report state “<code class=Li>zonelimit</code>”. Size of the pool can be tuned with <var class=Va>vm.vnode_pbufs</var><a class=Xr href=loader.conf.5.html>loader.conf(5)</a> tunable and can be checked with <a class=Xr href=sysctl.8.html>sysctl(8)</a> OID of the same name at runtime. </section><section class=Ss><h2 class=Ss id=sendfile(2)_buffers><a class=permalink href=#sendfile(2)_buffers>sendfile(2) buffers</a></h2> On some architectures, this system call internally uses a special <code class=Fn>sendfile</code>() buffer (<var class=Vt>struct sf_buf</var>) to handle sending file data to the client. If the sending socket is blocking, and there are not enough <code class=Fn>sendfile</code>() buffers available, <code class=Fn>sendfile</code>() will block and report a state of “<code class=Li>sfbufa</code>”. If the sending socket is non-blocking and there are not enough <code class=Fn>sendfile</code>() buffers available, the call will block and wait for the necessary buffers to become available before finishing the call. <p class=Pp>The number of <var class=Vt>sf_buf</var>'s allocated should be proportional to the number of nmbclusters used to send data to a client via <code class=Fn>sendfile</code>(). Tune accordingly to avoid blocking! Busy installations that make extensive use of <code class=Fn>sendfile</code>() may want to increase these values to be inline with their <var class=Va>kern.ipc.nmbclusters</var> (see <a class=Xr href=tuning.7.html>tuning(7)</a> for details).</p><p class=Pp>The number of <code class=Fn>sendfile</code>() buffers available is determined at boot time by either the <var class=Va>kern.ipc.nsfbufs</var><a class=Xr href=loader.conf.5.html>loader.conf(5)</a> variable or the <code class=Dv>NSFBUFS</code> kernel configuration tunable. The number of <code class=Fn>sendfile</code>() buffers scales with <var class=Va>kern.maxusers</var>. The <var class=Va>kern.ipc.nsfbufsused</var> and <var class=Va>kern.ipc.nsfbufspeak</var> read-only <a class=Xr href=sysctl.8.html>sysctl(8)</a> variables show current and peak <code class=Fn>sendfile</code>() buffers usage respectively. These values may also be viewed through <code class=Nm>netstat</code><code class=Fl>-m</code>.</p><p class=Pp>If <a class=Xr href=sysctl.8.html>sysctl(8)</a> OID <var class=Va>kern.ipc.nsfbufs</var> doesn't exist, your architecture does not need to use <code class=Fn>sendfile</code>() buffers because their task can be efficiently performed by the generic virtual memory structures.</p></section></section><section class=Sh><h2 class=Sh id=RETURN_VALUES><a class=permalink href=#RETURN_VALUES>RETURN VALUES</a></h2> The <code class=Fn>sendfile</code>() function returns the value 0 if successful; otherwise the value -1 is returned and the global variable <var class=Va>errno</var> is set to indicate the error. </section><section class=Sh><h2 class=Sh id=ERRORS><a class=permalink href=#ERRORS>ERRORS</a></h2><dl class=Bl-tag><dt>[<a class=permalink href=#EAGAIN><code class=Er id=EAGAIN>EAGAIN</code></a>]</dt><dd>The socket is marked for non-blocking I/O and not all data was sent due to the socket buffer being filled. If specified, the number of bytes successfully sent will be returned in <var class=Fa>*sbytes</var>.</dd><dt>[<a class=permalink href=#EBADF><code class=Er id=EBADF>EBADF</code></a>]</dt><dd>The <var class=Fa>fd</var> argument is not a valid file descriptor.</dd><dt>[<a class=permalink href=#EBADF_2><code class=Er id=EBADF_2>EBADF</code></a>]</dt><dd>The <var class=Fa>s</var> argument is not a valid socket descriptor.</dd><dt>[<a class=permalink href=#EBUSY><code class=Er id=EBUSY>EBUSY</code></a>]</dt><dd>A busy page was encountered and <code class=Dv>SF_NODISKIO</code> had been specified. Partial data may have been sent.</dd><dt>[<a class=permalink href=#EFAULT><code class=Er id=EFAULT>EFAULT</code></a>]</dt><dd>An invalid address was specified for an argument.</dd><dt>[<a class=permalink href=#EINTR><code class=Er id=EINTR>EINTR</code></a>]</dt><dd>A signal interrupted <code class=Fn>sendfile</code>() before it could be completed. If specified, the number of bytes successfully sent will be returned in <var class=Fa>*sbytes</var>.</dd><dt>[<a class=permalink href=#EINVAL><code class=Er id=EINVAL>EINVAL</code></a>]</dt><dd>The <var class=Fa>fd</var> argument is not a regular file.</dd><dt>[<a class=permalink href=#EINVAL_2><code class=Er id=EINVAL_2>EINVAL</code></a>]</dt><dd>The <var class=Fa>s</var> argument is not a SOCK_STREAM type socket.</dd><dt>[<a class=permalink href=#EINVAL_3><code class=Er id=EINVAL_3>EINVAL</code></a>]</dt><dd>The <var class=Fa>offset</var> argument is negative.</dd><dt>[<a class=permalink href=#EIO><code class=Er id=EIO>EIO</code></a>]</dt><dd>An error occurred while reading from <var class=Fa>fd</var>.</dd><dt>[<a class=permalink href=#EINTEGRITY><code class=Er id=EINTEGRITY>EINTEGRITY</code></a>]</dt><dd>Corrupted data was detected while reading from <var class=Fa>fd</var>.</dd><dt>[<a class=permalink href=#ENOTCAPABLE><code class=Er id=ENOTCAPABLE>ENOTCAPABLE</code></a>]</dt><dd>The <var class=Fa>fd</var> or the <var class=Fa>s</var> argument has insufficient rights.</dd><dt>[<a class=permalink href=#ENOBUFS><code class=Er id=ENOBUFS>ENOBUFS</code></a>]</dt><dd>The system was unable to allocate an internal buffer.</dd><dt>[<a class=permalink href=#ENOTCONN><code class=Er id=ENOTCONN>ENOTCONN</code></a>]</dt><dd>The <var class=Fa>s</var> argument points to an unconnected socket.</dd><dt>[<a class=permalink href=#ENOTSOCK><code class=Er id=ENOTSOCK>ENOTSOCK</code></a>]</dt><dd>The <var class=Fa>s</var> argument is not a socket.</dd><dt>[<a class=permalink href=#EOPNOTSUPP><code class=Er id=EOPNOTSUPP>EOPNOTSUPP</code></a>]</dt><dd>The file system for descriptor <var class=Fa>fd</var> does not support <code class=Fn>sendfile</code>().</dd><dt>[<a class=permalink href=#EPIPE><code class=Er id=EPIPE>EPIPE</code></a>]</dt><dd>The socket peer has closed the connection.</dd></dl></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=netstat.1.html>netstat(1)</a>, <a class=Xr href=open.2.html>open(2)</a>, <a class=Xr href=send.2.html>send(2)</a>, <a class=Xr href=socket.2.html>socket(2)</a>, <a class=Xr href=writev.2.html>writev(2)</a>, <a class=Xr href=loader.conf.5.html>loader.conf(5)</a>, <a class=Xr href=tuning.7.html>tuning(7)</a>, <a class=Xr href=sysctl.8.html>sysctl(8)</a><p class=Pp><cite class=Rs><span class=RsA>K. Elmeleegy</span>, <span class=RsA>A. Chanda</span>, <span class=RsA>A. L. Cox</span>, and <span class=RsA>W. Zwaenepoel</span>, <span class=RsT>A Portable Kernel Abstraction for Low-Overhead Ephemeral Mapping Management</span>, <i class=RsJ>The Proceedings of the 2005 USENIX Annual Technical Conference</i>, <span class=RsP>pp 223-236</span>, <span class=RsD>2005</span>.</cite></p></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The <code class=Fn>sendfile</code>() system call first appeared in <span class=Ux>FreeBSD 3.0</span>. This manual page first appeared in <span class=Ux>FreeBSD 3.1</span>. In <span class=Ux>FreeBSD 10</span> support for sending shared memory descriptors had been introduced. In <span class=Ux>FreeBSD 11</span> a non-blocking implementation had been introduced. </section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2> The initial implementation of <code class=Fn>sendfile</code>() system call and this manual page were written by <span class=An>David G. Lawrence</span> &lt;<a class=Mt href=mailto:dg@dglawrence.com>dg@dglawrence.com</a>&gt;. The <span class=Ux>FreeBSD 11</span> implementation was written by <br><span class=An>Gleb Smirnoff</span> &lt;<a class=Mt href=mailto:glebius@FreeBSD.org>glebius@FreeBSD.org</a>&gt;. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> The <code class=Fn>sendfile</code>() system call will not fail, i.e., return <code class=Dv>-1</code> and set <var class=Va>errno</var> to <code class=Er>EFAULT</code>, if provided an invalid address for <var class=Fa>sbytes</var>. The <code class=Fn>sendfile</code>() system call does not support SCTP sockets, it will return <code class=Dv>-1</code> and set <var class=Va>errno</var> to <code class=Er>EINVAL</code>. </section></div><table class=foot><tr><td class=foot-date>March 30, 2020</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>