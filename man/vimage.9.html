<!DOCTYPE html>
<html><head><meta charset=utf-8><title>vimage(9)</title><keywords content=man,vimage></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>vimage(9)</h1><table class=head><tr><td class=head-ltitle>VNET(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>VNET(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>VNET</code> — <div class=Nd>network subsystem virtualization infrastructure</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=Cd>options VIMAGE</code><br><code class=Cd>options VNET_DEBUG</code><p class=Pp><br><code class=In>#include &lt;<a class=In href=../src/sys/vnet.h.html>sys/vnet.h</a>&gt;</code></p><section class=Ss><h2 class=Ss id=Constants_and_Global_Variables><a class=permalink href=#Constants_and_Global_Variables>Constants and Global Variables</a></h2><code class=Dv>VNET_SETNAME</code><code class=Dv>VNET_SYMPREFIX</code><br><var class=Vt>extern struct vnet *vnet0;</var></section><section class=Ss><h2 class=Ss id=Variable_Declaration><a class=permalink href=#Variable_Declaration>Variable Declaration</a></h2><code class=Fn>VNET</code>(<var class=Fa>name</var>); <p class=Pp><code class=Fn>VNET_NAME</code>(<var class=Fa>name</var>);</p><p class=Pp><code class=Fn>VNET_DECLARE</code>(<var class=Fa>type</var>, <var class=Fa>name</var>);</p><p class=Pp><code class=Fn>VNET_DEFINE</code>(<var class=Fa>type</var>, <var class=Fa>name</var>);</p><p class=Pp><code class=Fn>VNET_DEFINE_STATIC</code>(<var class=Fa>type</var>, <var class=Fa>name</var>);</p><div class="Bd Pp"><pre>
#define	V_name	VNET(name)
</pre></div></section><section class=Ss><h2 class=Ss id=Virtual_Instance_Selection><a class=permalink href=#Virtual_Instance_Selection>Virtual Instance Selection</a></h2><code class=Fn>CRED_TO_VNET</code>(<var class=Fa>struct ucred *</var>); <p class=Pp><code class=Fn>TD_TO_VNET</code>(<var class=Fa>struct thread *</var>);</p><p class=Pp><code class=Fn>P_TO_VNET</code>(<var class=Fa>struct proc *</var>);</p><p class=Pp><code class=Fn>IS_DEFAULT_VNET</code>(<var class=Fa>struct vnet *</var>);</p><p class=Pp><code class=Fn>VNET_ASSERT</code>(<var class=Fa>exp</var>, <var class=Fa>msg</var>);</p><p class=Pp><code class=Fn>CURVNET_SET</code>(<var class=Fa>struct vnet *</var>);</p><p class=Pp><code class=Fn>CURVNET_SET_QUIET</code>(<var class=Fa>struct vnet *</var>);</p><p class=Pp><code class=Fn>CURVNET_RESTORE</code>();</p><p class=Pp><code class=Fn>VNET_ITERATOR_DECL</code>(<var class=Fa>struct vnet *</var>);</p><p class=Pp><code class=Fn>VNET_FOREACH</code>(<var class=Fa>struct vnet *</var>);</p></section><section class=Ss><h2 class=Ss id=Locking><a class=permalink href=#Locking>Locking</a></h2><code class=Fn>VNET_LIST_RLOCK</code>(); <p class=Pp><code class=Fn>VNET_LIST_RUNLOCK</code>();</p><p class=Pp><code class=Fn>VNET_LIST_RLOCK_NOSLEEP</code>();</p><p class=Pp><code class=Fn>VNET_LIST_RUNLOCK_NOSLEEP</code>();</p></section><section class=Ss><h2 class=Ss id=Startup_and_Teardown_Functions><a class=permalink href=#Startup_and_Teardown_Functions>Startup and Teardown Functions</a></h2><var class=Ft>struct vnet *</var><br><code class=Fn>vnet_alloc</code>(<var class=Fa>void</var>); <p class=Pp><var class=Ft>void</var><br><code class=Fn>vnet_destroy</code>(<var class=Fa>struct vnet *</var>);</p><p class=Pp><code class=Fn>VNET_SYSINIT</code>(<var class=Fa>ident</var>, <var class=Fa>enum sysinit_sub_id subsystem</var>, <var class=Fa>enum sysinit_elem_order order</var>, <var class=Fa>sysinit_cfunc_t func</var>, <var class=Fa>const void *arg</var>);</p><p class=Pp><code class=Fn>VNET_SYSUNINIT</code>(<var class=Fa>ident</var>, <var class=Fa>enum sysinit_sub_id subsystem</var>, <var class=Fa>enum sysinit_elem_order order</var>, <var class=Fa>sysinit_cfunc_t func</var>, <var class=Fa>const void *arg</var>);</p></section><section class=Ss><h2 class=Ss id=Eventhandlers><a class=permalink href=#Eventhandlers>Eventhandlers</a></h2><code class=Fn>VNET_GLOBAL_EVENTHANDLER_REGISTER</code>(<var class=Fa>const char *name</var>, <var class=Fa>void *func</var>, <var class=Fa>void *arg</var>, <var class=Fa>int priority</var>); <p class=Pp><code class=Fn>VNET_GLOBAL_EVENTHANDLER_REGISTER_TAG</code>(<var class=Fa>eventhandler_tag tag</var>, <var class=Fa>const char *name</var>, <var class=Fa>void *func</var>, <var class=Fa>void *arg</var>, <var class=Fa>int priority</var>);</p></section><section class=Ss><h2 class=Ss id=Sysctl_Handling><a class=permalink href=#Sysctl_Handling>Sysctl Handling</a></h2><code class=Fn>SYSCTL_VNET_INT</code>(<var class=Fa>parent</var>, <var class=Fa>nbr</var>, <var class=Fa>name</var>, <var class=Fa>access</var>, <var class=Fa>ptr</var>, <var class=Fa>val</var>, <var class=Fa>descr</var>); <p class=Pp><code class=Fn>SYSCTL_VNET_PROC</code>(<var class=Fa>parent</var>, <var class=Fa>nbr</var>, <var class=Fa>name</var>, <var class=Fa>access</var>, <var class=Fa>ptr</var>, <var class=Fa>arg</var>, <var class=Fa>handler</var>, <var class=Fa>fmt</var>, <var class=Fa>descr</var>);</p><p class=Pp><code class=Fn>SYSCTL_VNET_STRING</code>(<var class=Fa>parent</var>, <var class=Fa>nbr</var>, <var class=Fa>name</var>, <var class=Fa>access</var>, <var class=Fa>arg</var>, <var class=Fa>len</var>, <var class=Fa>descr</var>);</p><p class=Pp><code class=Fn>SYSCTL_VNET_STRUCT</code>(<var class=Fa>parent</var>, <var class=Fa>nbr</var>, <var class=Fa>name</var>, <var class=Fa>access</var>, <var class=Fa>ptr</var>, <var class=Fa>type</var>, <var class=Fa>descr</var>);</p><p class=Pp><code class=Fn>SYSCTL_VNET_UINT</code>(<var class=Fa>parent</var>, <var class=Fa>nbr</var>, <var class=Fa>name</var>, <var class=Fa>access</var>, <var class=Fa>ptr</var>, <var class=Fa>val</var>, <var class=Fa>descr</var>);</p><p class=Pp><code class=Fn>VNET_SYSCTL_ARG</code>(<var class=Fa>req</var>, <var class=Fa>arg1</var>);</p></section></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2><code class=Nm>VNET</code> is the name of a technique to virtualize the network stack. The basic idea is to change global resources most notably variables into per network stack resources and have functions, sysctls, eventhandlers, etc. access and handle them in the context of the correct instance. Each (virtual) network stack is attached to a <i class=Em>prison</i>, with <var class=Vt>vnet0</var> being the unrestricted default network stack of the base system. <p class=Pp>The global defines for <code class=Dv>VNET_SETNAME</code> and <code class=Dv>VNET_SYMPREFIX</code> are shared with <a class=Xr href=kvm.3.html>kvm(3)</a> to access internals for debugging reasons.</p><section class=Ss><h2 class=Ss id=Variable_Declaration_2><a class=permalink href=#Variable_Declaration_2>Variable Declaration</a></h2> Variables are virtualized by using the <code class=Fn>VNET_DEFINE</code>() macro rather than writing them out as <i class=Em>type name</i>. One can still use static initialization, e.g., <p class=Pp></p><div class="Bd Bd-indent"><code class=Li><code class=Li>VNET_DEFINE(int, foo) = 1;</code></code></div><p class=Pp>Variables declared with the static keyword can use the <code class=Fn>VNET_DEFINE_STATIC</code>() macro, e.g.,</p><p class=Pp></p><div class="Bd Bd-indent"><code class=Li><code class=Li>VNET_DEFINE_STATIC(SLIST_HEAD(, bar), bars);</code></code></div><p class=Pp>Static initialization is not possible when the virtualized variable would need to be referenced, e.g., with “TAILQ_HEAD_INITIALIZER()”. In that case a <code class=Fn>VNET_SYSINIT</code>() based initialization function must be used.</p><p class=Pp>External variables have to be declared using the <code class=Fn>VNET_DECLARE</code>() macro. In either case the convention is to define another macro, that is then used throughout the implementation to access that variable. The variable name is usually prefixed by <i class=Em>V_</i> to express that it is virtualized. The <code class=Fn>VNET</code>() macro will then translate accesses to that variable to the copy of the currently selected instance (see the <a class=Sx href=#Virtual_instance_selection>Virtual instance selection</a> section):</p><p class=Pp></p><div class="Bd Bd-indent"><code class=Li><code class=Li>#define V_name VNET(name)</code></code></div><p class=Pp><i class=Em>NOTE:</i> Do not confuse this with the convention used by <a class=Xr href=VFS.9.html>VFS(9)</a>.</p><p class=Pp>The <code class=Fn>VNET_NAME</code>() macro returns the offset within the memory region of the virtual network stack instance. It is usually only used with <code class=Fn>SYSCTL_VNET_*</code>() macros.</p></section><section class=Ss><h2 class=Ss id=Virtual_Instance_Selection_2><a class=permalink href=#Virtual_Instance_Selection_2>Virtual Instance Selection</a></h2> There are three different places where the current virtual network stack pointer is stored and can be taken from: <ol class="Bl-enum Bd-indent"><li>a <i class=Em>prison</i>: <div class="Bd Bd-indent"><code class=Li>(struct prison *)-&gt;pr_vnet</code></div><p class=Pp>For convenience the following macros are provided:</p><div class="Bd Bd-indent"><pre>
<code class=Fn>CRED_TO_VNET</code>(<var class=Fa>struct ucred *</var>)
<code class=Fn>TD_TO_VNET</code>(<var class=Fa>struct thread *</var>)
<code class=Fn>P_TO_VNET</code>(<var class=Fa>struct proc *</var>)
    </pre></div></li><li>a <i class=Em>socket</i>: <div class="Bd Bd-indent"><code class=Li>(struct socket *)-&gt;so_vnet</code></div></li><li>an <i class=Em>interface</i>: <div class="Bd Bd-indent"><code class=Li>(struct ifnet *)-&gt;if_vnet</code></div></li></ol><p class=Pp>In addition the currently active instance is cached in “curthread-&gt;td_vnet” which is usually only accessed through the <code class=Dv>curvnet</code> macro.</p><p class=Pp>To set the correct context of the current virtual network instance, use the <code class=Fn>CURVNET_SET</code>() or <code class=Fn>CURVNET_SET_QUIET</code>() macros. The <code class=Fn>CURVNET_SET_QUIET</code>() version will not record vnet recursions in case the kernel was compiled with <code class=Cd>options VNET_DEBUG</code> and should thus only be used in well known cases, where recursion is unavoidable. Both macros will save the previous state on the stack and it must be restored with the <code class=Fn>CURVNET_RESTORE</code>() macro.</p><p class=Pp><i class=Em>NOTE:</i> As the previous state is saved on the stack, you cannot have multiple <code class=Fn>CURVNET_SET</code>() calls in the same block.</p><p class=Pp><i class=Em>NOTE:</i> As the previous state is saved on the stack, a <code class=Fn>CURVNET_RESTORE</code>() call has to be in the same block as the <code class=Fn>CURVNET_SET</code>() call or in a subblock with the same idea of the saved instances as the outer block.</p><p class=Pp><i class=Em>NOTE:</i> As each macro is a set of operations and, as previously explained, cannot be put into its own block when defined, one cannot conditionally set the current vnet context. The following will <i class=Em>not</i> work:</p><div class="Bd Pp Bd-indent"><pre>
if (condition)
	CURVNET_SET(vnet);
</pre></div><p class=Pp>nor would this work:</p><div class="Bd Pp Bd-indent"><pre>
if (condition) {
	CURVNET_SET(vnet);
}
CURVNET_RESTORE();
</pre></div><p class=Pp>Sometimes one needs to loop over all virtual instances, for example to update virtual from global state, to run a function from a <a class=Xr href=callout.9.html>callout(9)</a> for each instance, etc. For those cases the <code class=Fn>VNET_ITERATOR_DECL</code>() and <code class=Fn>VNET_FOREACH</code>() macros are provided. The former macro defines the variable that iterates over the loop, and the latter loops over all of the virtual network stack instances. See <a class=Sx href=#Locking>Locking</a> for how to savely traverse the list of all virtual instances.</p><p class=Pp>The <code class=Fn>IS_DEFAULT_VNET</code>() macro provides a safe way to check whether the currently active instance is the unrestricted default network stack of the base system (<var class=Vt>vnet0</var>).</p><p class=Pp>The <code class=Fn>VNET_ASSERT</code>() macro provides a way to conditionally add assertions that are only active with <code class=Cd>options VIMAGE</code> compiled in and either <code class=Cd>options VNET_DEBUG</code> or <code class=Cd>options INVARIANTS</code> enabled as well. It uses the same semantics as <a class=Xr href=KASSERT.9.html>KASSERT(9)</a>.</p></section><section class=Ss><h2 class=Ss id=Locking_2><a class=permalink href=#Locking_2>Locking</a></h2> For public access to the list of virtual network stack instances e.g., by the <code class=Fn>VNET_FOREACH</code>() macro, read locks are provided. Macros are used to abstract from the actual type of the locks. If a caller may sleep while traversing the list, it must use the <code class=Fn>VNET_LIST_RLOCK</code>() and <code class=Fn>VNET_LIST_RUNLOCK</code>() macros. Otherwise, the caller can use <code class=Fn>VNET_LIST_RLOCK_NOSLEEP</code>() and <code class=Fn>VNET_LIST_RUNLOCK_NOSLEEP</code>(). </section><section class=Ss><h2 class=Ss id=Startup_and_Teardown_Functions_2><a class=permalink href=#Startup_and_Teardown_Functions_2>Startup and Teardown Functions</a></h2> To start or tear down a virtual network stack instance the internal functions <code class=Fn>vnet_alloc</code>() and <code class=Fn>vnet_destroy</code>() are provided and called from the jail framework. They run the publicly provided methods to handle network stack startup and teardown. <p class=Pp>For public control, the system startup interface has been enhanced to not only handle a system boot but to also handle a virtual network stack startup and teardown. To the base system the <code class=Fn>VNET_SYSINIT</code>() and <code class=Fn>VNET_SYSUNINIT</code>() macros look exactly as if there were no virtual network stack. In fact, if <code class=Cd>options VIMAGE</code> is not compiled in they are compiled to the standard <code class=Fn>SYSINIT</code>() macros. In addition to that they are run for each virtual network stack when starting or, in reverse order, when shutting down.</p></section><section class=Ss><h2 class=Ss id=Eventhandlers_2><a class=permalink href=#Eventhandlers_2>Eventhandlers</a></h2> Eventhandlers can be handled in two ways: <p class=Pp></p><ol class="Bl-enum Bd-indent Bl-compact"><li>save the <i class=Em>tags</i> returned in each virtual instance and properly free the eventhandlers on teardown using those, or</li><li>use one eventhandler that will iterate over all virtual network stack instances.</li></ol><p class=Pp>For the first case one can just use the normal <a class=Xr href=EVENTHANDLER.9.html>EVENTHANDLER(9)</a> functions, while for the second case the <code class=Fn>VNET_GLOBAL_EVENTHANDLER_REGISTER</code>() and <code class=Fn>VNET_GLOBAL_EVENTHANDLER_REGISTER_TAG</code>() macros are provided. These differ in that <code class=Fn>VNET_GLOBAL_EVENTHANDLER_REGISTER_TAG</code>() takes an extra first argument that will carry the <var class=Fa>tag</var> upon return. Eventhandlers registered with either of these will not run <var class=Fa>func</var> directly but <var class=Fa>func</var> will be called from an internal iterator function for each vnet. Both macros can only be used for eventhandlers that do not take additional arguments, as the variadic arguments from an <a class=Xr href=EVENTHANDLER_INVOKE.9.html>EVENTHANDLER_INVOKE(9)</a> call will be ignored.</p></section><section class=Ss><h2 class=Ss id=Sysctl_Handling_2><a class=permalink href=#Sysctl_Handling_2>Sysctl Handling</a></h2> A <a class=Xr href=sysctl.9.html>sysctl(9)</a> can be virtualized by using one of the <code class=Fn>SYSCTL_VNET_*</code>() macros. <p class=Pp>They take the same arguments as the standard <a class=Xr href=sysctl.9.html>sysctl(9)</a> functions, with the only difference, that the <var class=Fa>ptr</var> argument has to be passed as ‘<code class=Li>&amp;VNET_NAME(foo)</code>’ instead of ‘<code class=Li>&amp;foo</code>’ so that the variable can be selected from the correct memory region of the virtual network stack instance of the caller.</p><p class=Pp>For the very rare case a sysctl handler function would want to handle <var class=Fa>arg1</var> itself the <code class=Fn>VNET_SYSCTL_ARG</code>(<var class=Fa>req</var>, <var class=Fa>arg1</var>) is provided that will translate the <var class=Fa>arg1</var> argument to the correct memory address in the virtual network stack context of the caller.</p></section></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=jail.2.html>jail(2)</a>, <a class=Xr href=kvm.3.html>kvm(3)</a>, <a class=Xr href=EVENTHANDLER.9.html>EVENTHANDLER(9)</a>, <a class=Xr href=KASSERT.9.html>KASSERT(9)</a>, <a class=Xr href=sysctl.9.html>sysctl(9)</a><p class=Pp>Marko Zec, Implementing a Clonable Network Stack in the FreeBSD Kernel, USENIX ATC'03, June 2003, Boston</p></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The virtual network stack implementation first appeared in <span class=Ux>FreeBSD 8.0</span>. </section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2> The <code class=Nm>VNET</code> framework has been designed and implemented at the University of Zagreb by <span class=An>Marko Zec</span>, and later extended and refined by <span class=An>Bjoern A. Zeeb</span> and <span class=An>Robert Watson</span>, under contract to the FreeBSD Foundation. <p class=Pp>This manual page was written by <span class=An>Bjoern A. Zeeb, CK Software GmbH,</span> under sponsorship from the FreeBSD Foundation.</p></section></div><table class=foot><tr><td class=foot-date>July 24, 2018</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>