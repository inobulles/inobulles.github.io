<!DOCTYPE html>
<html><head><meta charset=utf-8><title>authpf(8)</title><keywords content=man,authpf></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>authpf(8)</h1><table class=head><tr><td class=head-ltitle>AUTHPF(8)</td><td class=head-vol>FreeBSD System Manager's Manual</td><td class=head-rtitle>AUTHPF(8)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>authpf</code>, <code class=Nm>authpf-noip</code> — <div class=Nd>authenticating gateway user shell</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><table class=Nm><tr><td><code class=Nm>authpf</code></td><td></td></tr></table><br><table class=Nm><tr><td><code class=Nm>authpf-noip</code></td><td></td></tr></table></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2><code class=Nm>authpf</code> is a user shell for authenticating gateways. It is used to change <a class=Xr href=pf.4.html>pf(4)</a> rules when a user authenticates and starts a session with <a class=Xr href=sshd.8.html>sshd(8)</a> and to undo these changes when the user's session exits. Typical use would be for a gateway that authenticates users before allowing them Internet use, or a gateway that allows different users into different places. Combined with properly set up filter rules and secure switches, <code class=Nm>authpf</code> can be used to ensure users are held accountable for their network traffic. It is meant to be used with users who can connect via <a class=Xr href=ssh.1.html>ssh(1)</a> only, and requires the <a class=Xr href=pf.4.html>pf(4)</a> subsystem and an <a class=Xr href=fdescfs.5.html>fdescfs(5)</a> file system mounted at <span class=Pa>/dev/fd</span> to be enabled. <p class=Pp><code class=Nm>authpf-noip</code> is a user shell which allows multiple connections to take place from the same IP address. It is useful primarily in cases where connections are tunneled via the gateway system, and can be directly associated with the user name. It cannot ensure accountability when classifying connections by IP address; in this case the client's IP address is not provided to the packet filter via the <var class=Ar>client_ip</var> macro or the <var class=Ar>authpf_users</var> table. Additionally, states associated with the client IP address are not purged when the session is ended.</p><p class=Pp>To use either <code class=Nm>authpf</code> or <code class=Nm>authpf-noip</code>, the user's shell needs to be set to <span class=Pa>/usr/sbin/authpf</span> or <span class=Pa>/usr/sbin/authpf-noip</span>.</p><p class=Pp><code class=Nm>authpf</code> uses the <a class=Xr href=pf.conf.5.html>pf.conf(5)</a> syntax to change filter and translation rules for an individual user or client IP address as long as a user maintains an active <a class=Xr href=ssh.1.html>ssh(1)</a> session, and logs the successful start and end of a session to <a class=Xr href=syslogd.8.html>syslogd(8)</a>. <code class=Nm>authpf</code> retrieves the client's connecting IP address via the <code class=Ev>SSH_CLIENT</code> environment variable and, after performing additional access checks, reads a template file to determine what filter and translation rules (if any) to add, and maintains the list of IP addresses of connected users in the <var class=Ar>authpf_users</var> table. On session exit the same rules and table entries that were added at startup are removed, and all states associated with the client's IP address are purged.</p><p class=Pp>Each <code class=Nm>authpf</code> process stores its rules in a separate ruleset inside a <a class=Xr href=pf.4.html>pf(4)</a><span class=Pa>anchor</span> shared by all <code class=Nm>authpf</code> processes. By default, the <span class=Pa>anchor</span> name "authpf" is used, and the ruleset names equal the username and PID of the <code class=Nm>authpf</code> processes as "username(pid)". The following rules need to be added to the main ruleset <span class=Pa>/etc/pf.conf</span> in order to cause evaluation of any <code class=Nm>authpf</code> rules:</p><div class="Bd Pp Bd-indent"><pre>
nat-anchor "authpf/*"
rdr-anchor "authpf/*"
binat-anchor "authpf/*"
anchor "authpf/*"
</pre></div><p class=Pp>The "/*" at the end of the anchor name is required for <a class=Xr href=pf.4.html>pf(4)</a> to process the rulesets attached to the anchor by <code class=Nm>authpf</code>.</p></section><section class=Sh><h2 class=Sh id=FILTER_AND_TRANSLATION_RULES><a class=permalink href=#FILTER_AND_TRANSLATION_RULES>FILTER AND TRANSLATION RULES</a></h2> Filter and translation rules for <code class=Nm>authpf</code> use the same format described in <a class=Xr href=pf.conf.5.html>pf.conf(5)</a>. The only difference is that these rules may (and probably should) use the macro <i class=Em>user_ip</i>, which is assigned the connecting IP address whenever <code class=Nm>authpf</code> is run. Additionally, the macro <i class=Em>user_id</i> is assigned the user name. <p class=Pp>Filter and translation rules are stored in a file called <span class=Pa>authpf.rules</span>. This file will first be searched for in <span class=Pa>/etc/authpf/users/$USER/</span> and then in <span class=Pa>/etc/authpf/</span>. Only one of these files will be used if both are present.</p><p class=Pp>Per-user rules from the <span class=Pa>/etc/authpf/users/$USER/</span> directory are intended to be used when non-default rules are needed on an individual user basis. It is important to ensure that a user can not write or change these configuration files.</p><p class=Pp>The <span class=Pa>authpf.rules</span> file must exist in one of the above locations for <code class=Nm>authpf</code> to run.</p></section><section class=Sh><h2 class=Sh id=CONFIGURATION><a class=permalink href=#CONFIGURATION>CONFIGURATION</a></h2> Options are controlled by the <span class=Pa>/etc/authpf/authpf.conf</span> file. If the file is empty, defaults are used for all configuration options. The file consists of pairs of the form <code class=Li>name=value</code>, one per line. Currently, the allowed values are as follows: <dl class=Bl-tag><dt>anchor=name</dt><dd>Use the specified <span class=Pa>anchor</span> name instead of "authpf".</dd><dt>table=name</dt><dd>Use the specified <span class=Pa>table</span> name instead of "authpf_users".</dd></dl></section><section class=Sh><h2 class=Sh id=USER_MESSAGES><a class=permalink href=#USER_MESSAGES>USER MESSAGES</a></h2> On successful invocation, <code class=Nm>authpf</code> displays a message telling the user he or she has been authenticated. It will additionally display the contents of the file <span class=Pa>/etc/authpf/authpf.message</span> if the file exists and is readable. <p class=Pp>There exist two methods for providing additional granularity to the control offered by <code class=Nm>authpf</code> - it is possible to set the gateway to explicitly allow users who have authenticated to <a class=Xr href=ssh.1.html>ssh(1)</a> and deny access to only a few troublesome individuals. This is done by creating a file with the banned user's login name as the filename in <span class=Pa>/etc/authpf/banned/</span>. The contents of this file will be displayed to a banned user, thus providing a method for informing the user that they have been banned, and where they can go and how to get there if they want to have their service restored. This is the default behaviour.</p><p class=Pp>It is also possible to configure <code class=Nm>authpf</code> to only allow specific users access. This is done by listing their login names, one per line, in <span class=Pa>/etc/authpf/authpf.allow</span>. A group of users can also be indicated by prepending "%" to the group name, and all members of a login class can be indicated by prepending "@" to the login class name. If "*" is found on a line, then all usernames match. If <code class=Nm>authpf</code> is unable to verify the user's permission to use the gateway, it will print a brief message and die. It should be noted that a ban takes precedence over an allow.</p><p class=Pp>On failure, messages will be logged to <a class=Xr href=syslogd.8.html>syslogd(8)</a> for the system administrator. The user does not see these, but will be told the system is unavailable due to technical difficulties. The contents of the file <span class=Pa>/etc/authpf/authpf.problem</span> will also be displayed if the file exists and is readable.</p></section><section class=Sh><h2 class=Sh id=CONFIGURATION_ISSUES><a class=permalink href=#CONFIGURATION_ISSUES>CONFIGURATION ISSUES</a></h2><code class=Nm>authpf</code> maintains the changed filter rules as long as the user maintains an active session. It is important to remember however, that the existence of this session means the user is authenticated. Because of this, it is important to configure <a class=Xr href=sshd.8.html>sshd(8)</a> to ensure the security of the session, and to ensure that the network through which users connect is secure. <a class=Xr href=sshd.8.html>sshd(8)</a> should be configured to use the <var class=Ar>ClientAliveInterval</var> and <var class=Ar>ClientAliveCountMax</var> parameters to ensure that a ssh session is terminated quickly if it becomes unresponsive, or if arp or address spoofing is used to hijack the session. Note that TCP keepalives are not sufficient for this, since they are not secure. Also note that the various SSH tunnelling mechanisms, such as <var class=Ar>AllowTcpForwarding</var> and <var class=Ar>PermitTunnel</var>, should be disabled for <code class=Nm>authpf</code> users to prevent them from circumventing restrictions imposed by the packet filter ruleset. <p class=Pp><code class=Nm>authpf</code> will remove state table entries that were created during a user's session. This ensures that there will be no unauthenticated traffic allowed to pass after the controlling <a class=Xr href=ssh.1.html>ssh(1)</a> session has been closed.</p><p class=Pp><code class=Nm>authpf</code> is designed for gateway machines which typically do not have regular (non-administrative) users using the machine. An administrator must remember that <code class=Nm>authpf</code> can be used to modify the filter rules through the environment in which it is run, and as such could be used to modify the filter rules (based on the contents of the configuration files) by regular users. In the case where a machine has regular users using it, as well as users with <code class=Nm>authpf</code> as their shell, the regular users should be prevented from running <code class=Nm>authpf</code> by using the <span class=Pa>/etc/authpf/authpf.allow</span> or <span class=Pa>/etc/authpf/banned/</span> facilities.</p><p class=Pp><code class=Nm>authpf</code> modifies the packet filter and address translation rules, and because of this it needs to be configured carefully. <code class=Nm>authpf</code> will not run and will exit silently if the <span class=Pa>/etc/authpf/authpf.conf</span> file does not exist. After considering the effect <code class=Nm>authpf</code> may have on the main packet filter rules, the system administrator may enable <code class=Nm>authpf</code> by creating an appropriate <span class=Pa>/etc/authpf/authpf.conf</span> file.</p></section><section class=Sh><h2 class=Sh id=EXAMPLES><a class=permalink href=#EXAMPLES>EXAMPLES</a></h2><b class=Sy>Control Files</b> - To illustrate the user-specific access control mechanisms, let us consider a typical user named bob. Normally, as long as bob can authenticate himself, the <code class=Nm>authpf</code> program will load the appropriate rules. Enter the <span class=Pa>/etc/authpf/banned/</span> directory. If bob has somehow fallen from grace in the eyes of the powers-that-be, they can prohibit him from using the gateway by creating the file <span class=Pa>/etc/authpf/banned/bob</span> containing a message about why he has been banned from using the network. Once bob has done suitable penance, his access may be restored by moving or removing the file <span class=Pa>/etc/authpf/banned/bob</span>. <p class=Pp>Now consider a workgroup containing alice, bob, carol and dave. They have a wireless network which they would like to protect from unauthorized use. To accomplish this, they create the file <span class=Pa>/etc/authpf/authpf.allow</span> which lists their login ids, group prepended with "%", or login class prepended with "@", one per line. At this point, even if eve could authenticate to <a class=Xr href=sshd.8.html>sshd(8)</a>, she would not be allowed to use the gateway. Adding and removing users from the work group is a simple matter of maintaining a list of allowed userids. If bob once again manages to annoy the powers-that-be, they can ban him from using the gateway by creating the familiar <span class=Pa>/etc/authpf/banned/bob</span> file. Though bob is listed in the allow file, he is prevented from using this gateway due to the existence of a ban file.</p><p class=Pp><b class=Sy>Distributed Authentication</b> - It is often desirable to interface with a distributed password system rather than forcing the sysadmins to keep a large number of local password files in sync. The <a class=Xr href=login.conf.5.html>login.conf(5)</a> mechanism in <span class=Ux>OpenBSD</span> can be used to fork the right shell. To make that happen, <a class=Xr href=login.conf.5.html>login.conf(5)</a> should have entries that look something like this:</p><div class="Bd Pp Bd-indent"><pre>
shell-default:shell=/bin/csh

default:\
	...
	:shell=/usr/sbin/authpf

daemon:\
	...
	:shell=/bin/csh:\
	:tc=default:

staff:\
	...
	:shell=/bin/csh:\
	:tc=default:
</pre></div><p class=Pp>Using a default password file, all users will get <code class=Nm>authpf</code> as their shell except for root who will get <span class=Pa>/bin/csh</span>.</p><p class=Pp><b class=Sy>SSH Configuration</b> - As stated earlier, <a class=Xr href=sshd.8.html>sshd(8)</a> must be properly configured to detect and defeat network attacks. To that end, the following options should be added to <a class=Xr href=sshd_config.5.html>sshd_config(5)</a>:</p><div class="Bd Pp Bd-indent"><pre>
Protocol 2
ClientAliveInterval 15
ClientAliveCountMax 3
</pre></div><p class=Pp>This ensures that unresponsive or spoofed sessions are terminated within a minute, since a hijacker should not be able to spoof ssh keepalive messages.</p><p class=Pp><b class=Sy>Banners</b> - Once authenticated, the user is shown the contents of <span class=Pa>/etc/authpf/authpf.message</span>. This message may be a screen-full of the appropriate use policy, the contents of <span class=Pa>/etc/motd</span> or something as simple as the following:</p><div class="Bd Pp Bd-indent"><pre>
This means you will be held accountable by the powers that be
for traffic originating from your machine, so please play nice.
</pre></div><p class=Pp>To tell the user where to go when the system is broken, <span class=Pa>/etc/authpf/authpf.problem</span> could contain something like this:</p><div class="Bd Pp Bd-indent"><pre>
Sorry, there appears to be some system problem. To report this
problem so we can fix it, please phone 1-900-314-1597 or send
an email to remove@bulkmailerz.net.
</pre></div><p class=Pp><b class=Sy>Packet Filter Rules</b> - In areas where this gateway is used to protect a wireless network (a hub with several hundred ports), the default rule set as well as the per-user rules should probably allow very few things beyond encrypted protocols like <a class=Xr href=ssh.1.html>ssh(1)</a>, <a class=Xr href=ssl.8.html>ssl(8)</a>, or <a class=Xr href=ipsec.4.html>ipsec(4)</a>. On a securely switched network, with plug-in jacks for visitors who are given authentication accounts, you might want to allow out everything. In this context, a secure switch is one that tries to prevent address table overflow attacks.</p><p class=Pp>Example <span class=Pa>/etc/pf.conf</span>:</p><div class="Bd Pp"><pre>
# by default we allow internal clients to talk to us using
# ssh and use us as a dns server.
internal_if="fxp1"
gateway_addr="10.0.1.1"
nat-anchor "authpf/*"
rdr-anchor "authpf/*"
binat-anchor "authpf/*"
block in on $internal_if from any to any
pass in quick on $internal_if proto tcp from any to $gateway_addr \
      port = ssh
pass in quick on $internal_if proto udp from any to $gateway_addr \
      port = domain
anchor "authpf/*"
</pre></div><p class=Pp><b class=Sy>For a switched, wired net</b> - This example <span class=Pa>/etc/authpf/authpf.rules</span> makes no real restrictions; it turns the IP address on and off, logging TCP connections.</p><div class="Bd Pp"><pre>
external_if = "xl0"
internal_if = "fxp0"

pass in log quick on $internal_if proto tcp from $user_ip to any
pass in quick on $internal_if from $user_ip to any
</pre></div><p class=Pp><b class=Sy>For a wireless or shared net</b> - This example <span class=Pa>/etc/authpf/authpf.rules</span> could be used for an insecure network (such as a public wireless network) where we might need to be a bit more restrictive.</p><div class="Bd Pp"><pre>
internal_if="fxp1"
ipsec_gw="10.2.3.4"

# rdr ftp for proxying by ftp-proxy(8)
rdr on $internal_if proto tcp from $user_ip to any port 21 \
      -&gt; 127.0.0.1 port 8021

# allow out ftp, ssh, www and https only, and allow user to negotiate
# ipsec with the ipsec server.
pass in log quick on $internal_if proto tcp from $user_ip to any \
      port { 21, 22, 80, 443 }
pass in quick on $internal_if proto tcp from $user_ip to any \
      port { 21, 22, 80, 443 }
pass in quick proto udp from $user_ip to $ipsec_gw port = isakmp
pass in quick proto esp from $user_ip to $ipsec_gw
</pre></div><p class=Pp><b class=Sy>Dealing with NAT</b> - The following <span class=Pa>/etc/authpf/authpf.rules</span> shows how to deal with NAT, using tags:</p><div class="Bd Pp"><pre>
ext_if = "fxp1"
ext_addr = 129.128.11.10
int_if = "fxp0"
# nat and tag connections...
nat on $ext_if from $user_ip to any tag $user_ip -&gt; $ext_addr
pass in quick on $int_if from $user_ip to any
pass out log quick on $ext_if tagged $user_ip
</pre></div><p class=Pp>With the above rules added by <code class=Nm>authpf</code>, outbound connections corresponding to each users NAT'ed connections will be logged as in the example below, where the user may be identified from the ruleset name.</p><div class="Bd Pp"><pre>
# tcpdump -n -e -ttt -i pflog0
Oct 31 19:42:30.296553 rule 0.bbeck(20267).1/0(match): pass out on fxp1: \
129.128.11.10.60539 &gt; 198.137.240.92.22: S 2131494121:2131494121(0) win \
16384 &lt;mss 1460,nop,nop,sackOK&gt; (DF)
</pre></div><p class=Pp><b class=Sy>Using the authpf_users table</b> - Simple <code class=Nm>authpf</code> settings can be implemented without an anchor by just using the "authpf_users" <span class=Pa>table</span>. For example, the following <a class=Xr href=pf.conf.5.html>pf.conf(5)</a> lines will give SMTP and IMAP access to logged in users:</p><div class="Bd Pp"><pre>
table &lt;authpf_users&gt; persist
pass in on $ext_if proto tcp from &lt;authpf_users&gt; \
        to port { smtp imap }
</pre></div><p class=Pp>It is also possible to use the "authpf_users" <span class=Pa>table</span> in combination with anchors. For example, <a class=Xr href=pf.4.html>pf(4)</a> processing can be sped up by looking up the anchor only for packets coming from logged in users:</p><div class="Bd Pp"><pre>
table &lt;authpf_users&gt; persist
anchor "authpf/*" from &lt;authpf_users&gt;
rdr-anchor "authpf/*" from &lt;authpf_users&gt;
</pre></div><p class=Pp><b class=Sy>Tunneled users</b> - normally <code class=Nm>authpf</code> allows only one session per client IP address. However in some cases, such as when connections are tunneled via <a class=Xr href=ssh.1.html>ssh(1)</a> or <a class=Xr href=ipsec.4.html>ipsec(4)</a>, the connections can be authorized based on the userid of the user instead of the client IP address. In this case it is appropriate to use <code class=Nm>authpf-noip</code> to allow multiple users behind a NAT gateway to connect. In the <span class=Pa>/etc/authpf/authpf.rules</span> example below, the remote user could tunnel a remote desktop session to their workstation:</p><div class="Bd Pp"><pre>
internal_if="bge0"
workstation_ip="10.2.3.4"

pass out on $internal_if from (self) to $workstation_ip port 3389 \
       user $user_id
</pre></div></section><section class=Sh><h2 class=Sh id=FILES><a class=permalink href=#FILES>FILES</a></h2><dl class="Bl-tag Bl-compact"><dt><span class=Pa>/etc/authpf/authpf.conf</span></dt><dd style="width: auto;"> </dd><dt><span class=Pa>/etc/authpf/authpf.allow</span></dt><dd style="width: auto;"> </dd><dt><span class=Pa>/etc/authpf/authpf.rules</span></dt><dd style="width: auto;"> </dd><dt><span class=Pa>/etc/authpf/authpf.message</span></dt><dd style="width: auto;"> </dd><dt><span class=Pa>/etc/authpf/authpf.problem</span></dt><dd style="width: auto;"> </dd></dl></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=pf.4.html>pf(4)</a>, <a class=Xr href=fdescfs.5.html>fdescfs(5)</a>, <a class=Xr href=pf.conf.5.html>pf.conf(5)</a>, <a class=Xr href=securelevel.7.html>securelevel(7)</a>, <a class=Xr href=ftp-proxy.8.html>ftp-proxy(8)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The <code class=Nm>authpf</code> program first appeared in <span class=Ux>OpenBSD 3.1</span>. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> Configuration issues are tricky. The authenticating <a class=Xr href=ssh.1.html>ssh(1)</a> connection may be secured, but if the network is not secured the user may expose insecure protocols to attackers on the same network, or enable other attackers on the network to pretend to be the user by spoofing their IP address. <p class=Pp><code class=Nm>authpf</code> is not designed to prevent users from denying service to other users.</p></section></div><table class=foot><tr><td class=foot-date>January 29 2014</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>