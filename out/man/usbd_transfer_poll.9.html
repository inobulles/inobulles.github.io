<!DOCTYPE html>
<html><head><meta charset=utf-8><title>usbd_transfer_poll(9)</title><keywords content=man,usbd_transfer_poll></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>usbd_transfer_poll(9)</h1><table class=head><tr><td class=head-ltitle>USBDI(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>USBDI(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>usb_fifo_alloc_buffer</code>, <code class=Nm>usb_fifo_attach</code>, <code class=Nm>usb_fifo_detach</code>, <code class=Nm>usb_fifo_free_buffer</code>, <code class=Nm>usb_fifo_get_data</code>, <code class=Nm>usb_fifo_get_data_buffer</code>, <code class=Nm>usb_fifo_get_data_error</code>, <code class=Nm>usb_fifo_get_data_linear</code>, <code class=Nm>usb_fifo_put_bytes_max</code>, <code class=Nm>usb_fifo_put_data</code>, <code class=Nm>usb_fifo_put_data_buffer</code>, <code class=Nm>usb_fifo_put_data_error</code>, <code class=Nm>usb_fifo_put_data_linear</code>, <code class=Nm>usb_fifo_reset</code>, <code class=Nm>usb_fifo_softc</code>, <code class=Nm>usb_fifo_wakeup</code>, <code class=Nm>usbd_do_request</code>, <code class=Nm>usbd_do_request_flags</code>, <code class=Nm>usbd_errstr</code>, <code class=Nm>usbd_lookup_id_by_info</code>, <code class=Nm>usbd_lookup_id_by_uaa</code>, <code class=Nm>usbd_transfer_clear_stall</code>, <code class=Nm>usbd_transfer_drain</code>, <code class=Nm>usbd_transfer_pending</code>, <code class=Nm>usbd_transfer_poll</code>, <code class=Nm>usbd_transfer_setup</code>, <code class=Nm>usbd_transfer_start</code>, <code class=Nm>usbd_transfer_stop</code>, <code class=Nm>usbd_transfer_submit</code>, <code class=Nm>usbd_transfer_unsetup</code>, <code class=Nm>usbd_xfer_clr_flag</code>, <code class=Nm>usbd_xfer_frame_data</code>, <code class=Nm>usbd_xfer_frame_len</code>, <code class=Nm>usbd_xfer_get_frame</code>, <code class=Nm>usbd_xfer_get_priv</code>, <code class=Nm>usbd_xfer_is_stalled</code>, <code class=Nm>usbd_xfer_max_framelen</code>, <code class=Nm>usbd_xfer_max_frames</code>, <code class=Nm>usbd_xfer_max_len</code>, <code class=Nm>usbd_xfer_set_flag</code>, <code class=Nm>usbd_xfer_set_frame_data</code>, <code class=Nm>usbd_xfer_set_frame_len</code>, <code class=Nm>usbd_xfer_set_frame_offset</code>, <code class=Nm>usbd_xfer_set_frames</code>, <code class=Nm>usbd_xfer_set_interval</code>, <code class=Nm>usbd_xfer_set_priv</code>, <code class=Nm>usbd_xfer_set_stall</code>, <code class=Nm>usbd_xfer_set_timeout</code>, <code class=Nm>usbd_xfer_softc</code>, <code class=Nm>usbd_xfer_state</code>, <code class=Nm>usbd_xfer_status</code> — <div class=Nd>Universal Serial Bus driver programming interface</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/dev/usb/usb.h.html>dev/usb/usb.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/dev/usb/usbdi.h.html>dev/usb/usbdi.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/dev/usb/usbdi_util.h.html>dev/usb/usbdi_util.h</a>&gt;</code><p class=Pp><var class=Ft>usb_error_t</var><br><code class=Fn>usbd_transfer_setup</code>(<var class=Fa>struct usb_device *udev</var>, <var class=Fa>const uint8_t *ifaces</var>, <var class=Fa>struct usb_xfer **pxfer</var>, <var class=Fa>const struct usb_config *setup_start</var>, <var class=Fa>uint16_t n_setup</var>, <var class=Fa>void *priv_sc</var>, <var class=Fa>struct mtx *priv_mtx</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>usbd_transfer_unsetup</code>(<var class=Fa>struct usb_xfer **pxfer</var>, <var class=Fa>uint16_t n_setup</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>usbd_transfer_start</code>(<var class=Fa>struct usb_xfer *xfer</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>usbd_transfer_stop</code>(<var class=Fa>struct usb_xfer *xfer</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>usbd_transfer_drain</code>(<var class=Fa>struct usb_xfer *xfer</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The Universal Serial Bus (USB) driver programming interface provides USB peripheral drivers with a host controller independent API for controlling and communicating with USB peripherals. The <code class=Nm>usb</code> module supports both USB Host and USB Device side mode. </section><section class=Sh><h2 class=Sh id=USB_TRANSFER_MANAGEMENT_FUNCTIONS><a class=permalink href=#USB_TRANSFER_MANAGEMENT_FUNCTIONS>USB TRANSFER MANAGEMENT FUNCTIONS</a></h2> The USB standard defines four types of USB transfers. Control transfers, Bulk transfers, Interrupt transfers and Isochronous transfers. All the transfer types are managed using the following five functions: <p class=Pp><code class=Fn>usbd_transfer_setup</code>() This function will allocate memory for and initialise an array of USB transfers and all required DMA memory. This function can sleep or block waiting for resources to become available. <var class=Fa>udev</var> is a pointer to "struct usb_device". <var class=Fa>ifaces</var> is an array of interface index numbers to use. See "if_index". <var class=Fa>pxfer</var> is a pointer to an array of USB transfer pointers that are initialized to NULL, and then pointed to allocated USB transfers. <var class=Fa>setup_start</var> is a pointer to an array of USB config structures. <var class=Fa>n_setup</var> is a number telling the USB system how many USB transfers should be setup. <var class=Fa>priv_sc</var> is the private softc pointer, which will be used to initialize "xfer-&gt;priv_sc". <var class=Fa>priv_mtx</var> is the private mutex protecting the transfer structure and the softc. This pointer is used to initialize "xfer-&gt;priv_mtx". This function returns zero upon success. A non-zero return value indicates failure.</p><p class=Pp><code class=Fn>usbd_transfer_unsetup</code>() This function will release the given USB transfers and all allocated resources associated with these USB transfers. <var class=Fa>pxfer</var> is a pointer to an array of USB transfer pointers, that may be NULL, that should be freed by the USB system. <var class=Fa>n_setup</var> is a number telling the USB system how many USB transfers should be unsetup. This function can sleep waiting for USB transfers to complete. This function is NULL safe with regard to the USB transfer structure pointer. It is not allowed to call this function from the USB transfer callback.</p><p class=Pp><code class=Fn>usbd_transfer_start</code>() This function will start the USB transfer pointed to by <var class=Fa>xfer</var>, if not already started. This function is always non-blocking and must be called with the so-called private USB mutex locked. This function is NULL safe with regard to the USB transfer structure pointer.</p><p class=Pp><code class=Fn>usbd_transfer_stop</code>() This function will stop the USB transfer pointed to by <var class=Fa>xfer</var>, if not already stopped. This function is always non-blocking and must be called with the so-called private USB mutex locked. This function can return before the USB callback has been called. This function is NULL safe with regard to the USB transfer structure pointer. If the transfer was in progress, the callback will called with "USB_ST_ERROR" and "error = USB_ERR_CANCELLED".</p><p class=Pp><code class=Fn>usbd_transfer_drain</code>() This function will stop an USB transfer, if not already stopped and wait for any additional USB hardware operations to complete. Buffers that are loaded into DMA using "usbd_xfer_set_frame_data()" can safely be freed after that this function has returned. This function can block the caller and will not return before the USB callback has been called. This function is NULL safe with regard to the USB transfer structure pointer.</p></section><section class=Sh><h2 class=Sh id=USB_TRANSFER_CALLBACK><a class=permalink href=#USB_TRANSFER_CALLBACK>USB TRANSFER CALLBACK</a></h2> The USB callback has three states. USB_ST_SETUP, USB_ST_TRANSFERRED and USB_ST_ERROR. USB_ST_SETUP is the initial state. After the callback has been called with this state it will always be called back at a later stage in one of the other two states. The USB callback should not restart the USB transfer in case the error cause is USB_ERR_CANCELLED. The USB callback is protected from recursion. That means one can start and stop whatever transfer from the callback of another transfer one desires. Also the transfer that is currently called back. Recursion is handled like this that when the callback that wants to recurse returns it is called one more time. <p class=Pp><code class=Fn>usbd_transfer_submit</code>() This function should only be called from within the USB callback and is used to start the USB hardware. An USB transfer can have multiple frames consisting of one or more USB packets making up an I/O vector for all USB transfer types.</p><div class="Bd Pp Bd-indent"><pre>
void
usb_default_callback(struct usb_xfer *xfer, usb_error_t error)
{
	int actlen;

	usbd_xfer_status(xfer, &amp;actlen, NULL, NULL, NULL);

	switch (USB_GET_STATE(xfer)) {
	case USB_ST_SETUP:
		/*
		 * Setup xfer frame lengths/count and data
		 */
		usbd_transfer_submit(xfer);
		break;

	case USB_ST_TRANSFERRED:
		/*
		 * Read	usb frame data, if any.
		 * "actlen" has the total length for all frames
		 * transferred.
		 */
		break;

	default: /* Error */
		/*
		 * Print error message and clear stall
		 * for example.
		 */
		break;
	}
	/*
	 * Here it is safe to do something without the private
	 * USB mutex locked.
	 */
	return;
}
</pre></div></section><section class=Sh><h2 class=Sh id=USB_CONTROL_TRANSFERS><a class=permalink href=#USB_CONTROL_TRANSFERS>USB CONTROL TRANSFERS</a></h2> An USB control transfer has three parts. First the SETUP packet, then DATA packet(s) and then a STATUS packet. The SETUP packet is always pointed to by frame 0 and the length is set by <code class=Fn>usbd_xfer_frame_len</code>() also if there should not be sent any SETUP packet! If an USB control transfer has no DATA stage, then the number of frames should be set to 1. Else the default number of frames is 2. <div class="Bd Pp Bd-indent"><pre>

Example1: SETUP + STATUS
 usbd_xfer_set_frames(xfer, 1);
 usbd_xfer_set_frame_len(xfer, 0, 8);
 usbd_transfer_submit(xfer);

Example2: SETUP + DATA + STATUS
 usbd_xfer_set_frames(xfer, 2);
 usbd_xfer_set_frame_len(xfer, 0, 8);
 usbd_xfer_set_frame_len(xfer, 1, 1);
 usbd_transfer_submit(xfer);

Example3: SETUP + DATA + STATUS - split
1st callback:
 usbd_xfer_set_frames(xfer, 1);
 usbd_xfer_set_frame_len(xfer, 0, 8);
 usbd_transfer_submit(xfer);

2nd callback:
 /* IMPORTANT: frbuffers[0] must still point at the setup packet! */
 usbd_xfer_set_frames(xfer, 2);
 usbd_xfer_set_frame_len(xfer, 0, 0);
 usbd_xfer_set_frame_len(xfer, 1, 1);
 usbd_transfer_submit(xfer);

Example4: SETUP + STATUS - split
1st callback:
 usbd_xfer_set_frames(xfer, 1);
 usbd_xfer_set_frame_len(xfer, 0, 8);
 usbd_xfer_set_flag(xfer, USB_MANUAL_STATUS);
 usbd_transfer_submit(xfer);

2nd callback:
 usbd_xfer_set_frames(xfer, 1);
 usbd_xfer_set_frame_len(xfer, 0, 0);
 usbd_xfer_clr_flag(xfer, USB_MANUAL_STATUS);
 usbd_transfer_submit(xfer);

</pre></div></section><section class=Sh><h2 class=Sh id=USB_TRANSFER_CONFIG><a class=permalink href=#USB_TRANSFER_CONFIG>USB TRANSFER CONFIG</a></h2> To simply the search for endpoints the <code class=Nm>usb</code> module defines a USB config structure where it is possible to specify the characteristics of the wanted endpoint. <div class="Bd Pp Bd-indent"><pre>

struct usb_config {
	bufsize,
	callback
	direction,
	endpoint,
	frames,
	index flags,
	interval,
	timeout,
	type,
};

</pre></div><p class=Pp><var class=Fa>type</var> field selects the USB pipe type. Valid values are: UE_INTERRUPT, UE_CONTROL, UE_BULK, UE_ISOCHRONOUS. The special value UE_BULK_INTR will select BULK and INTERRUPT pipes. This field is mandatory.</p><p class=Pp><var class=Fa>endpoint</var> field selects the USB endpoint number. A value of 0xFF, "-1" or "UE_ADDR_ANY" will select the first matching endpoint. This field is mandatory.</p><p class=Pp><var class=Fa>direction</var> field selects the USB endpoint direction. A value of "UE_DIR_ANY" will select the first matching endpoint. Else valid values are: "UE_DIR_IN" and "UE_DIR_OUT". "UE_DIR_IN" and "UE_DIR_OUT" can be binary OR'ed by "UE_DIR_SID" which means that the direction will be swapped in case of USB_MODE_DEVICE. Note that "UE_DIR_IN" refers to the data transfer direction of the "IN" tokens and "UE_DIR_OUT" refers to the data transfer direction of the "OUT" tokens. This field is mandatory.</p><p class=Pp><var class=Fa>interval</var> field selects the interrupt interval. The value of this field is given in milliseconds and is independent of device speed. Depending on the endpoint type, this field has different meaning:</p><dl class=Bl-tag><dt>UE_INTERRUPT</dt><dd>"0" use the default interrupt interval based on endpoint descriptor. "Else" use the given value for polling rate.</dd><dt>UE_ISOCHRONOUS</dt><dd>"0" use default. "Else" the value is ignored.</dd><dt>UE_BULK</dt><dd style="width: auto;"> </dd><dt>UE_CONTROL</dt><dd>"0" no transfer pre-delay. "Else" a delay as given by this field in milliseconds is inserted before the hardware is started when "usbd_transfer_submit()" is called. <p class=Pp>NOTE: The transfer timeout, if any, is started after that the pre-delay has elapsed!</p></dd></dl><p class=Pp><var class=Fa>timeout</var> field, if non-zero, will set the transfer timeout in milliseconds. If the "timeout" field is zero and the transfer type is ISOCHRONOUS a timeout of 250ms will be used.</p><p class=Pp><var class=Fa>frames</var> field sets the maximum number of frames. If zero is specified it will yield the following results:</p><dl class=Bl-tag><dt>UE_BULK</dt><dd>xfer-&gt;nframes = 1;</dd><dt>UE_INTERRUPT</dt><dd>xfer-&gt;nframes = 1;</dd><dt>UE_CONTROL</dt><dd>xfer-&gt;nframes = 2;</dd><dt>UE_ISOCHRONOUS</dt><dd>Not allowed. Will cause an error.</dd></dl><p class=Pp><var class=Fa>ep_index</var> field allows you to give a number, in case more endpoints match the description, that selects which matching "ep_index" should be used.</p><p class=Pp><var class=Fa>if_index</var> field allows you to select which of the interface numbers in the "ifaces" array parameter passed to "usbd_transfer_setup" that should be used when setting up the given USB transfer.</p><p class=Pp><var class=Fa>flags</var> field has type "struct usb_xfer_flags" and allows one to set initial flags an USB transfer. Valid flags are:</p><dl class=Bl-tag><dt>force_short_xfer</dt><dd>This flag forces the last transmitted USB packet to be short. A short packet has a length of less than "xfer-&gt;max_packet_size", which derives from "wMaxPacketSize". This flag can be changed during operation.</dd><dt>short_xfer_ok</dt><dd>This flag allows the received transfer length, "xfer-&gt;actlen" to be less than "xfer-&gt;sumlen" upon completion of a transfer. This flag can be changed during operation.</dd><dt>short_frames_ok</dt><dd>This flag allows the reception of multiple short USB frames. This flag only has effect for BULK and INTERRUPT endpoints and if the number of frames received is greater than 1. This flag can be changed during operation.</dd><dt>pipe_bof</dt><dd>This flag causes a failing USB transfer to remain first in the PIPE queue except in the case of "xfer-&gt;error" equal to "USB_ERR_CANCELLED". No other USB transfers in the affected PIPE queue will be started until either: <dl class=Bl-tag><dt>1</dt><dd>The failing USB transfer is stopped using "usbd_transfer_stop()".</dd><dt>2</dt><dd>The failing USB transfer performs a successful transfer.</dd></dl> The purpose of this flag is to avoid races when multiple transfers are queued for execution on an USB endpoint, and the first executing transfer fails leading to the need for clearing of stall for example. In this case this flag is used to prevent the following USB transfers from being executed at the same time the clear-stall command is executed on the USB control endpoint. This flag can be changed during operation. <p class=Pp>"BOF" is short for "Block On Failure".</p><p class=Pp>NOTE: This flag should be set on all BULK and INTERRUPT USB transfers which use an endpoint that can be shared between userland and kernel.</p></dd><dt>proxy_buffer</dt><dd>Setting this flag will cause that the total buffer size will be rounded up to the nearest atomic hardware transfer size. The maximum data length of any USB transfer is always stored in the "xfer-&gt;max_data_length". For control transfers the USB kernel will allocate additional space for the 8-bytes of SETUP header. These 8-bytes are not counted by the "xfer-&gt;max_data_length" variable. This flag cannot be changed during operation.</dd><dt>ext_buffer</dt><dd>Setting this flag will cause that no data buffer will be allocated. Instead the USB client must supply a data buffer. This flag cannot be changed during operation.</dd><dt>manual_status</dt><dd>Setting this flag prevents an USB STATUS stage to be appended to the end of the USB control transfer. If no control data is transferred this flag must be cleared. Else an error will be returned to the USB callback. This flag is mostly useful for the USB device side. This flag can be changed during operation.</dd><dt>no_pipe_ok</dt><dd>Setting this flag causes the USB_ERR_NO_PIPE error to be ignored. This flag cannot be changed during operation.</dd><dt>stall_pipe</dt><dd><dl class=Bl-tag><dt>Device Side Mode</dt><dd>Setting this flag will cause STALL pids to be sent to the endpoint belonging to this transfer before the transfer is started. The transfer is started at the moment the host issues a clear-stall command on the STALL'ed endpoint. This flag can be changed during operation.</dd><dt>Host Side Mode</dt><dd>Setting this flag will cause a clear-stall control request to be executed on the endpoint before the USB transfer is started.</dd></dl><p class=Pp>If this flag is changed outside the USB callback function you have to use the "usbd_xfer_set_stall()" and "usbd_transfer_clear_stall()" functions! This flag is automatically cleared after that the stall or clear stall has been executed.</p></dd><dt>pre_scale_frames</dt><dd>If this flag is set the number of frames specified is assumed to give the buffering time in milliseconds instead of frames. During transfer setup the frames field is pre scaled with the corresponding value for the endpoint and rounded to the nearest number of frames greater than zero. This option only has effect for ISOCHRONOUS transfers.</dd></dl><p class=Pp><var class=Fa>bufsize</var> field sets the total buffer size in bytes. If this field is zero, "wMaxPacketSize" will be used, multiplied by the "frames" field if the transfer type is ISOCHRONOUS. This is useful for setting up interrupt pipes. This field is mandatory.</p><p class=Pp>NOTE: For control transfers "bufsize" includes the length of the request structure.</p><p class=Pp><var class=Fa>callback</var> pointer sets the USB callback. This field is mandatory.</p></section><section class=Sh><h2 class=Sh id=USB_LINUX_COMPAT_LAYER><a class=permalink href=#USB_LINUX_COMPAT_LAYER>USB LINUX COMPAT LAYER</a></h2> The <code class=Nm>usb</code> module supports the Linux USB API. </section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=libusb.3.html>libusb(3)</a>, <a class=Xr href=usb.4.html>usb(4)</a>, <a class=Xr href=usbconfig.8.html>usbconfig(8)</a></section><section class=Sh><h2 class=Sh id=STANDARDS><a class=permalink href=#STANDARDS>STANDARDS</a></h2> The <code class=Nm>usb</code> module complies with the USB 2.0 standard. </section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The <code class=Nm>usb</code> module has been inspired by the NetBSD USB stack initially written by Lennart Augustsson. The <code class=Nm>usb</code> module was written by <span class=An>Hans Petter Selasky</span> &lt;<a class=Mt href=mailto:hselasky@FreeBSD.org>hselasky@FreeBSD.org</a>&gt;. </section></div><table class=foot><tr><td class=foot-date>November 14, 2016</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>