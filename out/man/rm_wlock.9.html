<!DOCTYPE html>
<html><head><meta charset=utf-8><title>rm_wlock(9)</title><keywords content=man,rm_wlock></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>rm_wlock(9)</h1><table class=head><tr><td class=head-ltitle>RMLOCK(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>RMLOCK(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>rmlock</code>, <code class=Nm>rm_init</code>, <code class=Nm>rm_init_flags</code>, <code class=Nm>rm_destroy</code>, <code class=Nm>rm_rlock</code>, <code class=Nm>rm_try_rlock</code>, <code class=Nm>rm_wlock</code>, <code class=Nm>rm_runlock</code>, <code class=Nm>rm_wunlock</code>, <code class=Nm>rm_wowned</code>, <code class=Nm>rm_sleep</code>, <code class=Nm>rm_assert</code>, <code class=Nm>RM_SYSINIT</code>, <code class=Nm>RM_SYSINIT_FLAGS</code> — <div class=Nd>kernel reader/writer lock optimized for read-mostly access patterns</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/sys/param.h.html>sys/param.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/lock.h.html>sys/lock.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/rmlock.h.html>sys/rmlock.h</a>&gt;</code><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_init</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">const char *name</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_init_flags</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">const char *name</var>, <var class=Fa style="white-space: nowrap;">int opts</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_destroy</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_rlock</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">struct rm_priotracker* tracker</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>rm_try_rlock</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">struct rm_priotracker* tracker</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_wlock</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_runlock</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">struct rm_priotracker* tracker</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>rm_wunlock</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>rm_wowned</code>(<var class=Fa style="white-space: nowrap;">const struct rmlock *rm</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>rm_sleep</code>(<var class=Fa style="white-space: nowrap;">void *wchan</var>, <var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">int priority</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int timo</var>);</p><p class=Pp><br><code class=Cd>options INVARIANTS</code><br><code class=Cd>options INVARIANT_SUPPORT</code><br><var class=Ft>void</var><br><code class=Fn>rm_assert</code>(<var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">int what</var>);</p><p class=Pp><code class=In>#include &lt;<a class=In href=../src/sys/kernel.h.html>sys/kernel.h</a>&gt;</code></p><p class=Pp><code class=Fn>RM_SYSINIT</code>(<var class=Fa style="white-space: nowrap;">name</var>, <var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">const char *desc</var>);</p><p class=Pp><code class=Fn>RM_SYSINIT_FLAGS</code>(<var class=Fa style="white-space: nowrap;">name</var>, <var class=Fa style="white-space: nowrap;">struct rmlock *rm</var>, <var class=Fa style="white-space: nowrap;">const char *desc</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> Read-mostly locks allow shared access to protected data by multiple threads, or exclusive access by a single thread. The threads with shared access are known as <i class=Em>readers</i> since they only read the protected data. A thread with exclusive access is known as a <i class=Em>writer</i> since it can modify protected data. <p class=Pp>Read-mostly locks are designed to be efficient for locks almost exclusively used as reader locks and as such should be used for protecting data that rarely changes. Acquiring an exclusive lock after the lock has been locked for shared access is an expensive operation.</p><p class=Pp>Normal read-mostly locks are similar to <a class=Xr href=rwlock.9.html>rwlock(9)</a> locks and follow the same lock ordering rules as <a class=Xr href=rwlock.9.html>rwlock(9)</a> locks. Read-mostly locks have full priority propagation like mutexes. Unlike <a class=Xr href=rwlock.9.html>rwlock(9)</a>, read-mostly locks propagate priority to both readers and writers. This is implemented via the <var class=Va>rm_priotracker</var> structure argument supplied to <code class=Fn>rm_rlock</code>() and <code class=Fn>rm_runlock</code>(). Readers can recurse if the lock is initialized with the <code class=Dv>RM_RECURSE</code> option; however, writers are never allowed to recurse.</p><p class=Pp>Sleepable read-mostly locks are created by passing <code class=Dv>RM_SLEEPABLE</code> to <code class=Fn>rm_init_flags</code>(). Unlike normal read-mostly locks, sleepable read-mostly locks follow the same lock ordering rules as <a class=Xr href=sx.9.html>sx(9)</a> locks. Sleepable read-mostly locks do not propagate priority to writers, but they do propagate priority to readers. Writers are permitted to sleep while holding a read-mostly lock, but readers are not. Unlike other sleepable locks such as <a class=Xr href=sx.9.html>sx(9)</a> locks, readers must use try operations on other sleepable locks to avoid sleeping.</p><section class=Ss><h2 class=Ss id=Macros_and_Functions><a class=permalink href=#Macros_and_Functions>Macros and Functions</a></h2><dl class=Bl-tag><dt><code class=Fn>rm_init</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>const char *name</var>)</dt><dd>Initialize the read-mostly lock <var class=Fa>rm</var>. The <var class=Fa>name</var> description is used solely for debugging purposes. This function must be called before any other operations on the lock.</dd><dt><code class=Fn>rm_init_flags</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>const char *name</var>, <var class=Fa>int opts</var>)</dt><dd>Similar to <code class=Fn>rm_init</code>(), initialize the read-mostly lock <var class=Fa>rm</var> with a set of optional flags. The <var class=Fa>opts</var> arguments contains one or more of the following flags: <dl class=Bl-tag><dt><a class=permalink href=#RM_NOWITNESS><code class=Dv id=RM_NOWITNESS>RM_NOWITNESS</code></a></dt><dd>Instruct <a class=Xr href=witness.4.html>witness(4)</a> to ignore this lock.</dd><dt><a class=permalink href=#RM_RECURSE><code class=Dv id=RM_RECURSE>RM_RECURSE</code></a></dt><dd>Allow threads to recursively acquire shared locks for <var class=Fa>rm</var>.</dd><dt><a class=permalink href=#RM_SLEEPABLE><code class=Dv id=RM_SLEEPABLE>RM_SLEEPABLE</code></a></dt><dd>Create a sleepable read-mostly lock.</dd><dt><a class=permalink href=#RM_NEW><code class=Dv id=RM_NEW>RM_NEW</code></a></dt><dd>If the kernel has been compiled with <code class=Cd>option INVARIANTS</code>, <code class=Fn>rm_init_flags</code>() will assert that the <var class=Fa>rm</var> has not been initialized multiple times without intervening calls to <code class=Fn>rm_destroy</code>() unless this option is specified.</dd></dl></dd><dt><code class=Fn>rm_rlock</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>struct rm_priotracker* tracker</var>)</dt><dd>Lock <var class=Fa>rm</var> as a reader using <var class=Fa>tracker</var> to track read owners of a lock for priority propagation. This data structure is only used internally by <code class=Nm>rmlock</code> and must persist until <code class=Fn>rm_runlock</code>() has been called. This data structure can be allocated on the stack since readers cannot sleep. If any thread holds this lock exclusively, the current thread blocks, and its priority is propagated to the exclusive holder. If the lock was initialized with the <code class=Dv>RM_RECURSE</code> option the <code class=Fn>rm_rlock</code>() function can be called when the current thread has already acquired reader access on <var class=Fa>rm</var>.</dd><dt><code class=Fn>rm_try_rlock</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>struct rm_priotracker* tracker</var>)</dt><dd>Try to lock <var class=Fa>rm</var> as a reader. <code class=Fn>rm_try_rlock</code>() will return 0 if the lock cannot be acquired immediately; otherwise, the lock will be acquired and a non-zero value will be returned. Note that <code class=Fn>rm_try_rlock</code>() may fail even while the lock is not currently held by a writer. If the lock was initialized with the <code class=Dv>RM_RECURSE</code> option, <code class=Fn>rm_try_rlock</code>() will succeed if the current thread has already acquired reader access.</dd><dt><code class=Fn>rm_wlock</code>(<var class=Fa>struct rmlock *rm</var>)</dt><dd>Lock <var class=Fa>rm</var> as a writer. If there are any shared owners of the lock, the current thread blocks. The <code class=Fn>rm_wlock</code>() function cannot be called recursively.</dd><dt><code class=Fn>rm_runlock</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>struct rm_priotracker* tracker</var>)</dt><dd>This function releases a shared lock previously acquired by <code class=Fn>rm_rlock</code>(). The <var class=Fa>tracker</var> argument must match the <var class=Fa>tracker</var> argument used for acquiring the shared lock</dd><dt><code class=Fn>rm_wunlock</code>(<var class=Fa>struct rmlock *rm</var>)</dt><dd>This function releases an exclusive lock previously acquired by <code class=Fn>rm_wlock</code>().</dd><dt><code class=Fn>rm_destroy</code>(<var class=Fa>struct rmlock *rm</var>)</dt><dd>This functions destroys a lock previously initialized with <code class=Fn>rm_init</code>(). The <var class=Fa>rm</var> lock must be unlocked.</dd><dt><code class=Fn>rm_wowned</code>(<var class=Fa>const struct rmlock *rm</var>)</dt><dd>This function returns a non-zero value if the current thread owns an exclusive lock on <var class=Fa>rm</var>.</dd><dt><code class=Fn>rm_sleep</code>(<var class=Fa>void *wchan</var>, <var class=Fa>struct rmlock *rm</var>, <var class=Fa>int priority</var>, <var class=Fa>const char *wmesg</var>, <var class=Fa>int timo</var>)</dt><dd>This function atomically releases <var class=Fa>rm</var> while waiting for an event. The <var class=Fa>rm</var> lock must be exclusively locked. For more details on the parameters to this function, see <a class=Xr href=sleep.9.html>sleep(9)</a>.</dd><dt><code class=Fn>rm_assert</code>(<var class=Fa>struct rmlock *rm</var>, <var class=Fa>int what</var>)</dt><dd>This function asserts that the <var class=Fa>rm</var> lock is in the state specified by <var class=Fa>what</var>. If the assertions are not true and the kernel is compiled with <code class=Cd>options INVARIANTS</code> and <code class=Cd>options INVARIANT_SUPPORT</code>, the kernel will panic. Currently the following base assertions are supported: <dl class=Bl-tag><dt><a class=permalink href=#RA_LOCKED><code class=Dv id=RA_LOCKED>RA_LOCKED</code></a></dt><dd>Assert that current thread holds either a shared or exclusive lock of <var class=Fa>rm</var>.</dd><dt><a class=permalink href=#RA_RLOCKED><code class=Dv id=RA_RLOCKED>RA_RLOCKED</code></a></dt><dd>Assert that current thread holds a shared lock of <var class=Fa>rm</var>.</dd><dt><a class=permalink href=#RA_WLOCKED><code class=Dv id=RA_WLOCKED>RA_WLOCKED</code></a></dt><dd>Assert that current thread holds an exclusive lock of <var class=Fa>rm</var>.</dd><dt><a class=permalink href=#RA_UNLOCKED><code class=Dv id=RA_UNLOCKED>RA_UNLOCKED</code></a></dt><dd>Assert that current thread holds neither a shared nor exclusive lock of <var class=Fa>rm</var>.</dd></dl><p class=Pp>In addition, one of the following optional flags may be specified with <code class=Dv>RA_LOCKED</code>, <code class=Dv>RA_RLOCKED</code>, or <code class=Dv>RA_WLOCKED</code>:</p><dl class=Bl-tag><dt><a class=permalink href=#RA_RECURSED><code class=Dv id=RA_RECURSED>RA_RECURSED</code></a></dt><dd>Assert that the current thread holds a recursive lock of <var class=Fa>rm</var>.</dd><dt><a class=permalink href=#RA_NOTRECURSED><code class=Dv id=RA_NOTRECURSED>RA_NOTRECURSED</code></a></dt><dd>Assert that the current thread does not hold a recursive lock of <var class=Fa>rm</var>.</dd></dl></dd></dl></section></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=locking.9.html>locking(9)</a>, <a class=Xr href=mutex.9.html>mutex(9)</a>, <a class=Xr href=panic.9.html>panic(9)</a>, <a class=Xr href=rwlock.9.html>rwlock(9)</a>, <a class=Xr href=sema.9.html>sema(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=sx.9.html>sx(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> These functions appeared in <span class=Ux>FreeBSD 7.0</span>. </section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2> The <code class=Nm>rmlock</code> facility was written by <span class=An>Stephan Uphoff</span>. This manual page was written by <span class=An>Gleb Smirnoff</span> for rwlock and modified to reflect rmlock by <span class=An>Stephan Uphoff</span>. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> The <code class=Nm>rmlock</code> implementation is currently not optimized for single processor systems. <p class=Pp><code class=Fn>rm_try_rlock</code>() can fail transiently even when there is no writer, while another reader updates the state on the local CPU.</p><p class=Pp>The <code class=Nm>rmlock</code> implementation uses a single per CPU list shared by all rmlocks in the system. If rmlocks become popular, hashing to multiple per CPU queues may be needed to speed up the writer lock process.</p></section></div><table class=foot><tr><td class=foot-date>November 11, 2017</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>