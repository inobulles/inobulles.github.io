<!DOCTYPE html>
<html><head><meta charset=utf-8><title>lockmgr(9)</title><keywords content=man,lockmgr></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>lockmgr(9)</h1><table class=head><tr><td class=head-ltitle>LOCK(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>LOCK(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>lockinit</code>, <code class=Nm>lockdestroy</code>, <code class=Nm>lockmgr</code>, <code class=Nm>lockmgr_args</code>, <code class=Nm>lockmgr_args_rw</code>, <code class=Nm>lockmgr_disown</code>, <code class=Nm>lockmgr_printinfo</code>, <code class=Nm>lockmgr_recursed</code>, <code class=Nm>lockmgr_rw</code>, <code class=Nm>lockstatus</code>, <code class=Nm>lockmgr_assert</code> — <div class=Nd>lockmgr family of functions</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/sys/types.h.html>sys/types.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/lock.h.html>sys/lock.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/lockmgr.h.html>sys/lockmgr.h</a>&gt;</code><p class=Pp><var class=Ft>void</var><br><code class=Fn>lockinit</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">int prio</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int timo</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>lockdestroy</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockmgr</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">u_int flags</var>, <var class=Fa style="white-space: nowrap;">struct mtx *ilk</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockmgr_args</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">u_int flags</var>, <var class=Fa style="white-space: nowrap;">struct mtx *ilk</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int prio</var>, <var class=Fa style="white-space: nowrap;">int timo</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockmgr_args_rw</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">u_int flags</var>, <var class=Fa style="white-space: nowrap;">struct rwlock *ilk</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int prio</var>, <var class=Fa style="white-space: nowrap;">int timo</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>lockmgr_disown</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>lockmgr_printinfo</code>(<var class=Fa style="white-space: nowrap;">const struct lock *lkp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockmgr_recursed</code>(<var class=Fa style="white-space: nowrap;">const struct lock *lkp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockmgr_rw</code>(<var class=Fa style="white-space: nowrap;">struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">u_int flags</var>, <var class=Fa style="white-space: nowrap;">struct rwlock *ilk</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>lockstatus</code>(<var class=Fa style="white-space: nowrap;">const struct lock *lkp</var>);</p><p class=Pp><br><code class=Cd>options INVARIANTS</code><br><code class=Cd>options INVARIANT_SUPPORT</code><br><var class=Ft>void</var><br><code class=Fn>lockmgr_assert</code>(<var class=Fa style="white-space: nowrap;">const struct lock *lkp</var>, <var class=Fa style="white-space: nowrap;">int what</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <code class=Fn>lockinit</code>() function is used to initialize a lock. It must be called before any operation can be performed on a lock. Its arguments are: <dl class=Bl-tag><dt><var class=Fa>lkp</var></dt><dd>A pointer to the lock to initialize.</dd><dt><var class=Fa>prio</var></dt><dd>The priority passed to <a class=Xr href=sleep.9.html>sleep(9)</a>.</dd><dt><var class=Fa>wmesg</var></dt><dd>The lock message. This is used for both debugging output and <a class=Xr href=sleep.9.html>sleep(9)</a>.</dd><dt><var class=Fa>timo</var></dt><dd>The timeout value passed to <a class=Xr href=sleep.9.html>sleep(9)</a>.</dd><dt><var class=Fa>flags</var></dt><dd>The flags the lock is to be initialized with: <dl class=Bl-tag><dt><a class=permalink href=#LK_CANRECURSE><code class=Dv id=LK_CANRECURSE>LK_CANRECURSE</code></a></dt><dd>Allow recursive exclusive locks.</dd><dt><a class=permalink href=#LK_NOPROFILE><code class=Dv id=LK_NOPROFILE>LK_NOPROFILE</code></a></dt><dd>Disable lock profiling for this lock.</dd><dt><a class=permalink href=#LK_NOSHARE><code class=Dv id=LK_NOSHARE>LK_NOSHARE</code></a></dt><dd>Allow exclusive locks only.</dd><dt><a class=permalink href=#LK_NOWITNESS><code class=Dv id=LK_NOWITNESS>LK_NOWITNESS</code></a></dt><dd>Instruct <a class=Xr href=witness.4.html>witness(4)</a> to ignore this lock.</dd><dt><a class=permalink href=#LK_NODUP><code class=Dv id=LK_NODUP>LK_NODUP</code></a></dt><dd><a class=Xr href=witness.4.html>witness(4)</a> should log messages about duplicate locks being acquired.</dd><dt><a class=permalink href=#LK_QUIET><code class=Dv id=LK_QUIET>LK_QUIET</code></a></dt><dd>Disable <a class=Xr href=ktr.4.html>ktr(4)</a> logging for this lock.</dd><dt><a class=permalink href=#LK_TIMELOCK><code class=Dv id=LK_TIMELOCK>LK_TIMELOCK</code></a></dt><dd>Use <var class=Fa>timo</var> during a sleep; otherwise, 0 is used.</dd></dl></dd></dl><p class=Pp>The <code class=Fn>lockdestroy</code>() function is used to destroy a lock, and while it is called in a number of places in the kernel, it currently does nothing.</p><p class=Pp>The <code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() functions handle general locking functionality within the kernel, including support for shared and exclusive locks, and recursion. <code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() are also able to upgrade and downgrade locks.</p><p class=Pp>Their arguments are:</p><dl class=Bl-tag><dt><var class=Fa>lkp</var></dt><dd>A pointer to the lock to manipulate.</dd><dt><var class=Fa>flags</var></dt><dd>Flags indicating what action is to be taken. <dl class=Bl-tag><dt><a class=permalink href=#LK_SHARED><code class=Dv id=LK_SHARED>LK_SHARED</code></a></dt><dd>Acquire a shared lock. If an exclusive lock is currently held, <code class=Dv>EDEADLK</code> will be returned.</dd><dt><a class=permalink href=#LK_EXCLUSIVE><code class=Dv id=LK_EXCLUSIVE>LK_EXCLUSIVE</code></a></dt><dd>Acquire an exclusive lock. If an exclusive lock is already held, and <code class=Dv>LK_CANRECURSE</code> is not set, the system will <a class=Xr href=panic.9.html>panic(9)</a>.</dd><dt><a class=permalink href=#LK_DOWNGRADE><code class=Dv id=LK_DOWNGRADE>LK_DOWNGRADE</code></a></dt><dd>Downgrade exclusive lock to a shared lock. Downgrading a shared lock is not permitted. If an exclusive lock has been recursed, the system will <a class=Xr href=panic.9.html>panic(9)</a>.</dd><dt><a class=permalink href=#LK_UPGRADE><code class=Dv id=LK_UPGRADE>LK_UPGRADE</code></a></dt><dd>Upgrade a shared lock to an exclusive lock. If this call fails, the shared lock is lost, even if the <code class=Dv>LK_NOWAIT</code> flag is specified. During the upgrade, the shared lock could be temporarily dropped. Attempts to upgrade an exclusive lock will cause a <a class=Xr href=panic.9.html>panic(9)</a>.</dd><dt><a class=permalink href=#LK_TRYUPGRADE><code class=Dv id=LK_TRYUPGRADE>LK_TRYUPGRADE</code></a></dt><dd>Try to upgrade a shared lock to an exclusive lock. The failure to upgrade does not result in the dropping of the shared lock ownership.</dd><dt><a class=permalink href=#LK_RELEASE><code class=Dv id=LK_RELEASE>LK_RELEASE</code></a></dt><dd>Release the lock. Releasing a lock that is not held can cause a <a class=Xr href=panic.9.html>panic(9)</a>.</dd><dt><a class=permalink href=#LK_DRAIN><code class=Dv id=LK_DRAIN>LK_DRAIN</code></a></dt><dd>Wait for all activity on the lock to end, then mark it decommissioned. This is used before freeing a lock that is part of a piece of memory that is about to be freed. (As documented in <code class=In>&lt;<a class=In href=../src/sys/lockmgr.h.html>sys/lockmgr.h</a>&gt;</code>.)</dd><dt><a class=permalink href=#LK_SLEEPFAIL><code class=Dv id=LK_SLEEPFAIL>LK_SLEEPFAIL</code></a></dt><dd>Fail if operation has slept.</dd><dt><a class=permalink href=#LK_NOWAIT><code class=Dv id=LK_NOWAIT>LK_NOWAIT</code></a></dt><dd>Do not allow the call to sleep. This can be used to test the lock.</dd><dt><a class=permalink href=#LK_NOWITNESS_2><code class=Dv id=LK_NOWITNESS_2>LK_NOWITNESS</code></a></dt><dd>Skip the <a class=Xr href=witness.4.html>witness(4)</a> checks for this instance.</dd><dt><a class=permalink href=#LK_CANRECURSE_2><code class=Dv id=LK_CANRECURSE_2>LK_CANRECURSE</code></a></dt><dd>Allow recursion on an exclusive lock. For every lock there must be a release.</dd><dt><a class=permalink href=#LK_INTERLOCK><code class=Dv id=LK_INTERLOCK>LK_INTERLOCK</code></a></dt><dd>Unlock the interlock (which should be locked already).</dd><dt><a class=permalink href=#LK_NODDLKTREAT><code class=Dv id=LK_NODDLKTREAT>LK_NODDLKTREAT</code></a></dt><dd>Normally, <code class=Fn>lockmgr</code>() postpones serving further shared requests for shared-locked lock if there is exclusive waiter, to avoid exclusive lock starvation. But, if the thread requesting the shared lock already owns a shared lockmgr lock, the request is granted even in presence of the parallel exclusive lock request, which is done to avoid deadlocks with recursive shared acquisition. <p class=Pp>The <code class=Dv>LK_NODDLKTREAT</code> flag can only be used by code which requests shared non-recursive lock. The flag allows exclusive requests to preempt the current shared request even if the current thread owns shared locks. This is safe since shared lock is guaranteed to not recurse, and is used when thread is known to held unrelated shared locks, to not cause unnecessary starvation. An example is <code class=Dv>vp</code> locking in VFS <a class=Xr href=lookup.9.html>lookup(9)</a>, when <code class=Dv>dvp</code> is already locked.</p></dd></dl></dd><dt><var class=Fa>ilk</var></dt><dd>An interlock mutex for controlling group access to the lock. If <code class=Dv>LK_INTERLOCK</code> is specified, <code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() assume <var class=Fa>ilk</var> is currently owned and not recursed, and will return it unlocked. See <a class=Xr href=mtx_assert.9.html>mtx_assert(9)</a>.</dd></dl><p class=Pp>The <code class=Fn>lockmgr_args</code>() and <code class=Fn>lockmgr_args_rw</code>() function work like <code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() but accepting a <var class=Fa>wmesg</var>, <var class=Fa>timo</var> and <var class=Fa>prio</var> on a per-instance basis. The specified values will override the default ones, but this can still be used passing, respectively, <code class=Dv>LK_WMESG_DEFAULT</code>, <code class=Dv>LK_PRIO_DEFAULT</code> and <code class=Dv>LK_TIMO_DEFAULT</code>.</p><p class=Pp>The <code class=Fn>lockmgr_disown</code>() function switches the owner from the current thread to be <code class=Dv>LK_KERNPROC</code>, if the lock is already held.</p><p class=Pp>The <code class=Fn>lockmgr_printinfo</code>() function prints debugging information about the lock. It is used primarily by <a class=Xr href=VOP_PRINT.9.html>VOP_PRINT(9)</a> functions.</p><p class=Pp>The <code class=Fn>lockmgr_recursed</code>() function returns true if the lock is recursed, 0 otherwise.</p><p class=Pp>The <code class=Fn>lockstatus</code>() function returns the status of the lock in relation to the current thread.</p><p class=Pp>When compiled with <code class=Cd>options INVARIANTS</code> and <code class=Cd>options INVARIANT_SUPPORT</code>, the <code class=Fn>lockmgr_assert</code>() function tests <var class=Fa>lkp</var> for the assertions specified in <var class=Fa>what</var>, and panics if they are not met. One of the following assertions must be specified:</p><dl class=Bl-tag><dt><a class=permalink href=#KA_LOCKED><code class=Dv id=KA_LOCKED>KA_LOCKED</code></a></dt><dd>Assert that the current thread has either a shared or an exclusive lock on the <var class=Vt>lkp</var> lock pointed to by the first argument.</dd><dt><a class=permalink href=#KA_SLOCKED><code class=Dv id=KA_SLOCKED>KA_SLOCKED</code></a></dt><dd>Assert that the current thread has a shared lock on the <var class=Vt>lkp</var> lock pointed to by the first argument.</dd><dt><a class=permalink href=#KA_XLOCKED><code class=Dv id=KA_XLOCKED>KA_XLOCKED</code></a></dt><dd>Assert that the current thread has an exclusive lock on the <var class=Vt>lkp</var> lock pointed to by the first argument.</dd><dt><a class=permalink href=#KA_UNLOCKED><code class=Dv id=KA_UNLOCKED>KA_UNLOCKED</code></a></dt><dd>Assert that the current thread has no lock on the <var class=Vt>lkp</var> lock pointed to by the first argument.</dd></dl><p class=Pp>In addition, one of the following optional assertions can be used with either an <code class=Dv>KA_LOCKED</code>, <code class=Dv>KA_SLOCKED</code>, or <code class=Dv>KA_XLOCKED</code> assertion:</p><dl class=Bl-tag><dt><a class=permalink href=#KA_RECURSED><code class=Dv id=KA_RECURSED>KA_RECURSED</code></a></dt><dd>Assert that the current thread has a recursed lock on <var class=Fa>lkp</var>.</dd><dt><a class=permalink href=#KA_NOTRECURSED><code class=Dv id=KA_NOTRECURSED>KA_NOTRECURSED</code></a></dt><dd>Assert that the current thread does not have a recursed lock on <var class=Fa>lkp</var>.</dd></dl></section><section class=Sh><h2 class=Sh id=RETURN_VALUES><a class=permalink href=#RETURN_VALUES>RETURN VALUES</a></h2> The <code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() functions return 0 on success and non-zero on failure. <p class=Pp>The <code class=Fn>lockstatus</code>() function returns:</p><dl class=Bl-tag><dt><a class=permalink href=#LK_EXCLUSIVE_2><code class=Dv id=LK_EXCLUSIVE_2>LK_EXCLUSIVE</code></a></dt><dd>An exclusive lock is held by the current thread.</dd><dt><a class=permalink href=#LK_EXCLOTHER><code class=Dv id=LK_EXCLOTHER>LK_EXCLOTHER</code></a></dt><dd>An exclusive lock is held by someone other than the current thread.</dd><dt><a class=permalink href=#LK_SHARED_2><code class=Dv id=LK_SHARED_2>LK_SHARED</code></a></dt><dd>A shared lock is held.</dd><dt><a class=permalink href=#0><code class=Li id=0>0</code></a></dt><dd>The lock is not held by anyone.</dd></dl></section><section class=Sh><h2 class=Sh id=ERRORS><a class=permalink href=#ERRORS>ERRORS</a></h2><code class=Fn>lockmgr</code>() and <code class=Fn>lockmgr_rw</code>() fail if: <dl class=Bl-tag><dt>[<a class=permalink href=#EBUSY><code class=Er id=EBUSY>EBUSY</code></a>]</dt><dd><a class=permalink href=#LK_FORCEUPGRADE><code class=Dv id=LK_FORCEUPGRADE>LK_FORCEUPGRADE</code></a> was requested and another thread had already requested a lock upgrade.</dd><dt>[<a class=permalink href=#EBUSY_2><code class=Er id=EBUSY_2>EBUSY</code></a>]</dt><dd><a class=permalink href=#LK_NOWAIT_2><code class=Dv id=LK_NOWAIT_2>LK_NOWAIT</code></a> was set, and a sleep would have been required, or <code class=Dv>LK_TRYUPGRADE</code> operation was not able to upgrade the lock.</dd><dt>[<a class=permalink href=#ENOLCK><code class=Er id=ENOLCK>ENOLCK</code></a>]</dt><dd><a class=permalink href=#LK_SLEEPFAIL_2><code class=Dv id=LK_SLEEPFAIL_2>LK_SLEEPFAIL</code></a> was set and <code class=Fn>lockmgr</code>() or <code class=Fn>lockmgr_rw</code>() did sleep.</dd><dt>[<a class=permalink href=#EINTR><code class=Er id=EINTR>EINTR</code></a>]</dt><dd><a class=permalink href=#PCATCH><code class=Dv id=PCATCH>PCATCH</code></a> was set in the lock priority, and a signal was delivered during a sleep. Note the <a class=permalink href=#ERESTART><code class=Er id=ERESTART>ERESTART</code></a> error below.</dd><dt>[<a class=permalink href=#ERESTART_2><code class=Er id=ERESTART_2>ERESTART</code></a>]</dt><dd><a class=permalink href=#PCATCH_2><code class=Dv id=PCATCH_2>PCATCH</code></a> was set in the lock priority, a signal was delivered during a sleep, and the system call is to be restarted.</dd><dt>[<a class=permalink href=#EWOULDBLOCK><code class=Er id=EWOULDBLOCK>EWOULDBLOCK</code></a>]</dt><dd>a non-zero timeout was given, and the timeout expired.</dd></dl></section><section class=Sh><h2 class=Sh id=LOCKS><a class=permalink href=#LOCKS>LOCKS</a></h2> If <code class=Dv>LK_INTERLOCK</code> is passed in the <var class=Fa>flags</var> argument to <code class=Fn>lockmgr</code>() or <code class=Fn>lockmgr_rw</code>(), the <var class=Fa>ilk</var> must be held prior to calling <code class=Fn>lockmgr</code>() or <code class=Fn>lockmgr_rw</code>(), and will be returned unlocked. <p class=Pp>Upgrade attempts that fail result in the loss of the lock that is currently held. Also, it is invalid to upgrade an exclusive lock, and a <a class=Xr href=panic.9.html>panic(9)</a> will be the result of trying.</p></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=condvar.9.html>condvar(9)</a>, <a class=Xr href=locking.9.html>locking(9)</a>, <a class=Xr href=mtx_assert.9.html>mtx_assert(9)</a>, <a class=Xr href=mutex.9.html>mutex(9)</a>, <a class=Xr href=panic.9.html>panic(9)</a>, <a class=Xr href=rwlock.9.html>rwlock(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=sx.9.html>sx(9)</a>, <a class=Xr href=VOP_PRINT.9.html>VOP_PRINT(9)</a></section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2> This manual page was written by <span class=An>Chad David</span> &lt;<a class=Mt href=mailto:davidc@acns.ab.ca>davidc@acns.ab.ca</a>&gt;. </section></div><table class=foot><tr><td class=foot-date>November 17, 2017</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>