<!DOCTYPE html>
<html><head><meta charset=utf-8><title>mtx_sleep(9)</title><keywords content=man,mtx_sleep></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>mtx_sleep(9)</h1><table class=head><tr><td class=head-ltitle>MUTEX(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>MUTEX(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>mutex</code>, <code class=Nm>mtx_init</code>, <code class=Nm>mtx_destroy</code>, <code class=Nm>mtx_lock</code>, <code class=Nm>mtx_lock_spin</code>, <code class=Nm>mtx_lock_flags</code>, <code class=Nm>mtx_lock_spin_flags</code>, <code class=Nm>mtx_trylock</code>, <code class=Nm>mtx_trylock_flags</code>, <code class=Nm>mtx_trylock_spin</code>, <code class=Nm>mtx_trylock_spin_flags</code>, <code class=Nm>mtx_unlock</code>, <code class=Nm>mtx_unlock_spin</code>, <code class=Nm>mtx_unlock_flags</code>, <code class=Nm>mtx_unlock_spin_flags</code>, <code class=Nm>mtx_sleep</code>, <code class=Nm>mtx_initialized</code>, <code class=Nm>mtx_owned</code>, <code class=Nm>mtx_recursed</code>, <code class=Nm>mtx_assert</code>, <code class=Nm>MTX_SYSINIT</code> — <div class=Nd>kernel synchronization primitives</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/sys/param.h.html>sys/param.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/lock.h.html>sys/lock.h</a>&gt;</code><br><code class=In>#include &lt;<a class=In href=../src/sys/mutex.h.html>sys/mutex.h</a>&gt;</code><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_init</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">const char *name</var>, <var class=Fa style="white-space: nowrap;">const char *type</var>, <var class=Fa style="white-space: nowrap;">int opts</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_destroy</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_lock</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_lock_spin</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_lock_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_lock_spin_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_trylock</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_trylock_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_trylock_spin</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_trylock_spin_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_unlock</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_unlock_spin</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_unlock_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>mtx_unlock_spin_flags</code>(<var class=Fa style="white-space: nowrap;">struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_sleep</code>(<var class=Fa style="white-space: nowrap;">void *chan</var>, <var class=Fa style="white-space: nowrap;">struct mtx *mtx</var>, <var class=Fa style="white-space: nowrap;">int priority</var>, <var class=Fa style="white-space: nowrap;">const char *wmesg</var>, <var class=Fa style="white-space: nowrap;">int timo</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_initialized</code>(<var class=Fa style="white-space: nowrap;">const struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_owned</code>(<var class=Fa style="white-space: nowrap;">const struct mtx *mutex</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>mtx_recursed</code>(<var class=Fa style="white-space: nowrap;">const struct mtx *mutex</var>);</p><p class=Pp><br><code class=Cd>options INVARIANTS</code><br><code class=Cd>options INVARIANT_SUPPORT</code><br><var class=Ft>void</var><br><code class=Fn>mtx_assert</code>(<var class=Fa style="white-space: nowrap;">const struct mtx *mutex</var>, <var class=Fa style="white-space: nowrap;">int what</var>);</p><p class=Pp><code class=In>#include &lt;<a class=In href=../src/sys/kernel.h.html>sys/kernel.h</a>&gt;</code></p><p class=Pp><code class=Fn>MTX_SYSINIT</code>(<var class=Fa style="white-space: nowrap;">name</var>, <var class=Fa style="white-space: nowrap;">struct mtx *mtx</var>, <var class=Fa style="white-space: nowrap;">const char *description</var>, <var class=Fa style="white-space: nowrap;">int opts</var>);</p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> Mutexes are the most basic and primary method of thread synchronization. The major design considerations for mutexes are: <ol class=Bl-enum><li>Acquiring and releasing uncontested mutexes should be as cheap as possible.</li><li>They must have the information and storage space to support priority propagation.</li><li>A thread must be able to recursively acquire a mutex, provided that the mutex is initialized to support recursion.</li></ol><p class=Pp>There are currently two flavors of mutexes, those that context switch when they block and those that do not.</p><p class=Pp>By default, <code class=Dv>MTX_DEF</code> mutexes will context switch when they are already held. As an optimization, they may spin for some amount of time before context switching. It is important to remember that since a thread may be preempted at any time, the possible context switch introduced by acquiring a mutex is guaranteed to not break anything that is not already broken.</p><p class=Pp>Mutexes which do not context switch are <code class=Dv>MTX_SPIN</code> mutexes. These should only be used to protect data shared with primary interrupt code. This includes interrupt filters and low level scheduling code. In all architectures both acquiring and releasing of a uncontested spin mutex is more expensive than the same operation on a non-spin mutex. In order to protect an interrupt service routine from blocking against itself all interrupts are either blocked or deferred on a processor while holding a spin lock. It is permissible to hold multiple spin mutexes.</p><p class=Pp>Once a spin mutex has been acquired it is not permissible to acquire a blocking mutex.</p><p class=Pp>The storage needed to implement a mutex is provided by a <var class=Vt>struct mtx</var>. In general this should be treated as an opaque object and referenced only with the mutex primitives.</p><p class=Pp>The <code class=Fn>mtx_init</code>() function must be used to initialize a mutex before it can be passed to any of the other mutex functions. The <var class=Fa>name</var> option is used to identify the lock in debugging output etc. The <var class=Fa>type</var> option is used by the witness code to classify a mutex when doing checks of lock ordering. If <var class=Fa>type</var> is <code class=Dv>NULL</code>, <var class=Fa>name</var> is used in its place. The pointer passed in as <var class=Fa>name</var> and <var class=Fa>type</var> is saved rather than the data it points to. The data pointed to must remain stable until the mutex is destroyed. The <var class=Fa>opts</var> argument is used to set the type of mutex. It may contain either <code class=Dv>MTX_DEF</code> or <code class=Dv>MTX_SPIN</code> but not both. If the kernel has been compiled with <code class=Cd>option INVARIANTS</code>, <code class=Fn>mtx_init</code>() will assert that the <var class=Fa>mutex</var> has not been initialized multiple times without intervening calls to <code class=Fn>mtx_destroy</code>() unless the <code class=Dv>MTX_NEW</code> option is specified. See below for additional initialization options.</p><p class=Pp>The <code class=Fn>mtx_lock</code>() function acquires a <code class=Dv>MTX_DEF</code> mutual exclusion lock on behalf of the currently running kernel thread. If another kernel thread is holding the mutex, the caller will be disconnected from the CPU until the mutex is available (i.e., it will block).</p><p class=Pp>The <code class=Fn>mtx_lock_spin</code>() function acquires a <code class=Dv>MTX_SPIN</code> mutual exclusion lock on behalf of the currently running kernel thread. If another kernel thread is holding the mutex, the caller will spin until the mutex becomes available. Interrupts are disabled during the spin and remain disabled following the acquiring of the lock.</p><p class=Pp>It is possible for the same thread to recursively acquire a mutex with no ill effects, provided that the <code class=Dv>MTX_RECURSE</code> bit was passed to <code class=Fn>mtx_init</code>() during the initialization of the mutex.</p><p class=Pp>The <code class=Fn>mtx_lock_flags</code>() and <code class=Fn>mtx_lock_spin_flags</code>() functions acquire a <code class=Dv>MTX_DEF</code> or <code class=Dv>MTX_SPIN</code> lock, respectively, and also accept a <var class=Fa>flags</var> argument. In both cases, the only flags presently available for lock acquires are <code class=Dv>MTX_QUIET</code> and <code class=Dv>MTX_RECURSE</code>. If the <code class=Dv>MTX_QUIET</code> bit is turned on in the <var class=Fa>flags</var> argument, then if <code class=Dv>KTR_LOCK</code> tracing is being done, it will be silenced during the lock acquire. If the <code class=Dv>MTX_RECURSE</code> bit is turned on in the <var class=Fa>flags</var> argument, then the mutex can be acquired recursively.</p><p class=Pp>The <code class=Fn>mtx_trylock</code>() and <code class=Fn>mtx_trylock_spin</code>() functions attempt to acquire a <code class=Dv>MTX_DEF</code> or <code class=Dv>MTX_SPIN</code> mutex, respectively, pointed to by <var class=Fa>mutex</var>. If the mutex cannot be immediately acquired, the functions will return 0, otherwise the mutex will be acquired and a non-zero value will be returned.</p><p class=Pp>The <code class=Fn>mtx_trylock_flags</code>() and <code class=Fn>mtx_trylock_spin_flags</code>() functions have the same behavior as <code class=Fn>mtx_trylock</code>() and <code class=Fn>mtx_trylock_spin</code>() respectively, but should be used when the caller desires to pass in a <var class=Fa>flags</var> value. Presently, the only valid value in the <code class=Fn>mtx_trylock</code>() and <code class=Fn>mtx_trylock_spin</code>() cases is <code class=Dv>MTX_QUIET</code>, and its effects are identical to those described for <code class=Fn>mtx_lock</code>() above.</p><p class=Pp>The <code class=Fn>mtx_unlock</code>() function releases a <code class=Dv>MTX_DEF</code> mutual exclusion lock. The current thread may be preempted if a higher priority thread is waiting for the mutex.</p><p class=Pp>The <code class=Fn>mtx_unlock_spin</code>() function releases a <code class=Dv>MTX_SPIN</code> mutual exclusion lock.</p><p class=Pp>The <code class=Fn>mtx_unlock_flags</code>() and <code class=Fn>mtx_unlock_spin_flags</code>() functions behave in exactly the same way as do the standard mutex unlock routines above, while also allowing a <var class=Fa>flags</var> argument which may specify <code class=Dv>MTX_QUIET</code>. The behavior of <code class=Dv>MTX_QUIET</code> is identical to its behavior in the mutex lock routines.</p><p class=Pp>The <code class=Fn>mtx_destroy</code>() function is used to destroy <var class=Fa>mutex</var> so the data associated with it may be freed or otherwise overwritten. Any mutex which is destroyed must previously have been initialized with <code class=Fn>mtx_init</code>(). It is permissible to have a single hold count on a mutex when it is destroyed. It is not permissible to hold the mutex recursively, or have another thread blocked on the mutex when it is destroyed.</p><p class=Pp>The <code class=Fn>mtx_sleep</code>() function is used to atomically release <var class=Fa>mtx</var> while waiting for an event. For more details on the parameters to this function, see <a class=Xr href=sleep.9.html>sleep(9)</a>.</p><p class=Pp>The <code class=Fn>mtx_initialized</code>() function returns non-zero if <var class=Fa>mutex</var> has been initialized and zero otherwise.</p><p class=Pp>The <code class=Fn>mtx_owned</code>() function returns non-zero if the current thread holds <var class=Fa>mutex</var>. If the current thread does not hold <var class=Fa>mutex</var> zero is returned.</p><p class=Pp>The <code class=Fn>mtx_recursed</code>() function returns non-zero if the <var class=Fa>mutex</var> is recursed. This check should only be made if the running thread already owns <var class=Fa>mutex</var>.</p><p class=Pp>The <code class=Fn>mtx_assert</code>() function allows assertions specified in <var class=Fa>what</var> to be made about <var class=Fa>mutex</var>. If the assertions are not true and the kernel is compiled with <code class=Cd>options INVARIANTS</code> and <code class=Cd>options INVARIANT_SUPPORT</code>, the kernel will panic. Currently the following assertions are supported:</p><dl class=Bl-tag><dt><a class=permalink href=#MA_OWNED><code class=Dv id=MA_OWNED>MA_OWNED</code></a></dt><dd>Assert that the current thread holds the mutex pointed to by the first argument.</dd><dt><a class=permalink href=#MA_NOTOWNED><code class=Dv id=MA_NOTOWNED>MA_NOTOWNED</code></a></dt><dd>Assert that the current thread does not hold the mutex pointed to by the first argument.</dd><dt><a class=permalink href=#MA_RECURSED><code class=Dv id=MA_RECURSED>MA_RECURSED</code></a></dt><dd>Assert that the current thread has recursed on the mutex pointed to by the first argument. This assertion is only valid in conjunction with <code class=Dv>MA_OWNED</code>.</dd><dt><a class=permalink href=#MA_NOTRECURSED><code class=Dv id=MA_NOTRECURSED>MA_NOTRECURSED</code></a></dt><dd>Assert that the current thread has not recursed on the mutex pointed to by the first argument. This assertion is only valid in conjunction with <code class=Dv>MA_OWNED</code>.</dd></dl><p class=Pp>The <code class=Fn>MTX_SYSINIT</code>() macro is used to generate a call to the <code class=Fn>mtx_sysinit</code>() routine at system startup in order to initialize a given mutex lock. The parameters are the same as <code class=Fn>mtx_init</code>() but with an additional argument, <var class=Fa>name</var>, that is used in generating unique variable names for the related structures associated with the lock and the sysinit routine.</p><section class=Ss><h2 class=Ss id=The_Default_Mutex_Type><a class=permalink href=#The_Default_Mutex_Type>The Default Mutex Type</a></h2> Most kernel code should use the default lock type, <code class=Dv>MTX_DEF</code>. The default lock type will allow the thread to be disconnected from the CPU if the lock is already held by another thread. The implementation may treat the lock as a short term spin lock under some circumstances. However, it is always safe to use these forms of locks in an interrupt thread without fear of deadlock against an interrupted thread on the same CPU. </section><section class=Ss><h2 class=Ss id=The_Spin_Mutex_Type><a class=permalink href=#The_Spin_Mutex_Type>The Spin Mutex Type</a></h2> A <code class=Dv>MTX_SPIN</code> mutex will not relinquish the CPU when it cannot immediately get the requested lock, but will loop, waiting for the mutex to be released by another CPU. This could result in deadlock if another thread interrupted the thread which held a mutex and then tried to acquire the mutex. For this reason spin locks disable all interrupts on the local CPU. <p class=Pp>Spin locks are fairly specialized locks that are intended to be held for very short periods of time. Their primary purpose is to protect portions of the code that implement other synchronization primitives such as default mutexes, thread scheduling, and interrupt threads.</p></section><section class=Ss><h2 class=Ss id=Initialization_Options><a class=permalink href=#Initialization_Options>Initialization Options</a></h2> The options passed in the <var class=Fa>opts</var> argument of <code class=Fn>mtx_init</code>() specify the mutex type. One of the <code class=Dv>MTX_DEF</code> or <code class=Dv>MTX_SPIN</code> options is required and only one of those two options may be specified. The possibilities are: <dl class=Bl-tag><dt><a class=permalink href=#MTX_DEF><code class=Dv id=MTX_DEF>MTX_DEF</code></a></dt><dd>Default mutexes will always allow the current thread to be suspended to avoid deadlock conditions against interrupt threads. The implementation of this lock type may spin for a while before suspending the current thread.</dd><dt><a class=permalink href=#MTX_SPIN><code class=Dv id=MTX_SPIN>MTX_SPIN</code></a></dt><dd>Spin mutexes will never relinquish the CPU. All interrupts are disabled on the local CPU while any spin lock is held.</dd><dt><a class=permalink href=#MTX_RECURSE><code class=Dv id=MTX_RECURSE>MTX_RECURSE</code></a></dt><dd>Specifies that the initialized mutex is allowed to recurse. This bit must be present if the mutex is permitted to recurse. <p class=Pp>Note that neither <code class=Fn>mtx_trylock</code>() nor <code class=Fn>mtx_trylock_spin</code>() support recursion; that is, attempting to acquire an already-owned mutex fails.</p></dd><dt><a class=permalink href=#MTX_QUIET><code class=Dv id=MTX_QUIET>MTX_QUIET</code></a></dt><dd>Do not log any mutex operations for this lock.</dd><dt><a class=permalink href=#MTX_NOWITNESS><code class=Dv id=MTX_NOWITNESS>MTX_NOWITNESS</code></a></dt><dd>Instruct <a class=Xr href=witness.4.html>witness(4)</a> to ignore this lock.</dd><dt><a class=permalink href=#MTX_DUPOK><code class=Dv id=MTX_DUPOK>MTX_DUPOK</code></a></dt><dd>Witness should not log messages about duplicate locks being acquired.</dd><dt><a class=permalink href=#MTX_NOPROFILE><code class=Dv id=MTX_NOPROFILE>MTX_NOPROFILE</code></a></dt><dd>Do not profile this lock.</dd><dt><a class=permalink href=#MTX_NEW><code class=Dv id=MTX_NEW>MTX_NEW</code></a></dt><dd>Do not check for double-init.</dd></dl></section><section class=Ss><h2 class=Ss id=Lock_and_Unlock_Flags><a class=permalink href=#Lock_and_Unlock_Flags>Lock and Unlock Flags</a></h2> The flags passed to the <code class=Fn>mtx_lock_flags</code>(), <code class=Fn>mtx_lock_spin_flags</code>(), <code class=Fn>mtx_unlock_flags</code>(), and <code class=Fn>mtx_unlock_spin_flags</code>() functions provide some basic options to the caller, and are often used only under special circumstances to modify lock or unlock behavior. Standard locking and unlocking should be performed with the <code class=Fn>mtx_lock</code>(), <code class=Fn>mtx_lock_spin</code>(), <code class=Fn>mtx_unlock</code>(), and <code class=Fn>mtx_unlock_spin</code>() functions. Only if a flag is required should the corresponding flags-accepting routines be used. <p class=Pp>Options that modify mutex behavior:</p><dl class=Bl-tag><dt><a class=permalink href=#MTX_QUIET_2><code class=Dv id=MTX_QUIET_2>MTX_QUIET</code></a></dt><dd>This option is used to quiet logging messages during individual mutex operations. This can be used to trim superfluous logging messages for debugging purposes.</dd></dl></section><section class=Ss><h2 class=Ss id=Giant><a class=permalink href=#Giant>Giant</a></h2> If <var class=Va>Giant</var> must be acquired, it must be acquired prior to acquiring other mutexes. Put another way: it is impossible to acquire <var class=Va>Giant</var> non-recursively while holding another mutex. It is possible to acquire other mutexes while holding <var class=Va>Giant</var>, and it is possible to acquire <var class=Va>Giant</var> recursively while holding other mutexes. </section><section class=Ss><h2 class=Ss id=Sleeping><a class=permalink href=#Sleeping>Sleeping</a></h2> Sleeping while holding a mutex (except for <var class=Va>Giant</var>) is never safe and should be avoided. There are numerous assertions which will fail if this is attempted. </section><section class=Ss><h2 class=Ss id=Functions_Which_Access_Memory_in_Userspace><a class=permalink href=#Functions_Which_Access_Memory_in_Userspace>Functions Which Access Memory in Userspace</a></h2> No mutexes should be held (except for <var class=Va>Giant</var>) across functions which access memory in userspace, such as <a class=Xr href=copyin.9.html>copyin(9)</a>, <a class=Xr href=copyout.9.html>copyout(9)</a>, <a class=Xr href=uiomove.9.html>uiomove(9)</a>, <a class=Xr href=fuword.9.html>fuword(9)</a>, etc. No locks are needed when calling these functions. </section></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=condvar.9.html>condvar(9)</a>, <a class=Xr href=LOCK_PROFILING.9.html>LOCK_PROFILING(9)</a>, <a class=Xr href=locking.9.html>locking(9)</a>, <a class=Xr href=mtx_pool.9.html>mtx_pool(9)</a>, <a class=Xr href=panic.9.html>panic(9)</a>, <a class=Xr href=rwlock.9.html>rwlock(9)</a>, <a class=Xr href=sema.9.html>sema(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a>, <a class=Xr href=sx.9.html>sx(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> These functions appeared in <span class=Ux>BSD/OS 4.1</span> and <span class=Ux>FreeBSD 5.0</span>. The <code class=Fn>mtx_trylock_spin</code>() function was added in <span class=Ux>FreeBSD 11.1</span>. </section></div><table class=foot><tr><td class=foot-date>May 24, 2017</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>