<!DOCTYPE html>
<html><head><meta charset=utf-8><title>geom(4)</title><keywords content=man,geom></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>geom(4)</h1><table class=head><tr><td class=head-ltitle>GEOM(4)</td><td class=head-vol>FreeBSD Kernel Interfaces Manual</td><td class=head-rtitle>GEOM(4)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>GEOM</code> — <div class=Nd>modular disk I/O request transformation framework</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=Cd>options GEOM_BDE</code><br><code class=Cd>options GEOM_CACHE</code><br><code class=Cd>options GEOM_CONCAT</code><br><code class=Cd>options GEOM_ELI</code><br><code class=Cd>options GEOM_GATE</code><br><code class=Cd>options GEOM_JOURNAL</code><br><code class=Cd>options GEOM_LABEL</code><br><code class=Cd>options GEOM_LINUX_LVM</code><br><code class=Cd>options GEOM_MAP</code><br><code class=Cd>options GEOM_MIRROR</code><br><code class=Cd>options GEOM_MOUNTVER</code><br><code class=Cd>options GEOM_MULTIPATH</code><br><code class=Cd>options GEOM_NOP</code><br><code class=Cd>options GEOM_PART_APM</code><br><code class=Cd>options GEOM_PART_BSD</code><br><code class=Cd>options GEOM_PART_BSD64</code><br><code class=Cd>options GEOM_PART_EBR</code><br><code class=Cd>options GEOM_PART_EBR_COMPAT</code><br><code class=Cd>options GEOM_PART_GPT</code><br><code class=Cd>options GEOM_PART_LDM</code><br><code class=Cd>options GEOM_PART_MBR</code><br><code class=Cd>options GEOM_PART_VTOC8</code><br><code class=Cd>options GEOM_RAID</code><br><code class=Cd>options GEOM_RAID3</code><br><code class=Cd>options GEOM_SHSEC</code><br><code class=Cd>options GEOM_STRIPE</code><br><code class=Cd>options GEOM_UZIP</code><br><code class=Cd>options GEOM_VIRSTOR</code><br><code class=Cd>options GEOM_ZERO</code></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <code class=Nm>GEOM</code> framework provides an infrastructure in which “classes” can perform transformations on disk I/O requests on their path from the upper kernel to the device drivers and back. <p class=Pp>Transformations in a <code class=Nm>GEOM</code> context range from the simple geometric displacement performed in typical disk partitioning modules over RAID algorithms and device multipath resolution to full blown cryptographic protection of the stored data.</p><p class=Pp>Compared to traditional “volume management”, <code class=Nm>GEOM</code> differs from most and in some cases all previous implementations in the following ways:</p><ul class=Bl-bullet><li><code class=Nm>GEOM</code> is extensible. It is trivially simple to write a new class of transformation and it will not be given stepchild treatment. If someone for some reason wanted to mount IBM MVS diskpacks, a class recognizing and configuring their VTOC information would be a trivial matter.</li><li><code class=Nm>GEOM</code> is topologically agnostic. Most volume management implementations have very strict notions of how classes can fit together, very often one fixed hierarchy is provided, for instance, subdisk - plex - volume.</li></ul><p class=Pp>Being extensible means that new transformations are treated no differently than existing transformations.</p><p class=Pp>Fixed hierarchies are bad because they make it impossible to express the intent efficiently. In the fixed hierarchy above, it is not possible to mirror two physical disks and then partition the mirror into subdisks, instead one is forced to make subdisks on the physical volumes and to mirror these two and two, resulting in a much more complex configuration. <code class=Nm>GEOM</code> on the other hand does not care in which order things are done, the only restriction is that cycles in the graph will not be allowed.</p></section><section class=Sh><h2 class=Sh id=TERMINOLOGY_AND_TOPOLOGY><a class=permalink href=#TERMINOLOGY_AND_TOPOLOGY>TERMINOLOGY AND TOPOLOGY</a></h2><code class=Nm>GEOM</code> is quite object oriented and consequently the terminology borrows a lot of context and semantics from the OO vocabulary: <p class=Pp>A “class”, represented by the data structure <var class=Vt>g_class</var> implements one particular kind of transformation. Typical examples are MBR disk partition, BSD disklabel, and RAID5 classes.</p><p class=Pp>An instance of a class is called a “geom” and represented by the data structure <var class=Vt>g_geom</var>. In a typical i386 <span class=Ux>FreeBSD</span> system, there will be one geom of class MBR for each disk.</p><p class=Pp>A “provider”, represented by the data structure <var class=Vt>g_provider</var>, is the front gate at which a geom offers service. A provider is “a disk-like thing which appears in <span class=Pa>/dev</span>” - a logical disk in other words. All providers have three main properties: “name”, “sectorsize” and “size”.</p><p class=Pp>A “consumer” is the backdoor through which a geom connects to another geom provider and through which I/O requests are sent.</p><p class=Pp>The topological relationship between these entities are as follows:</p><ul class=Bl-bullet><li>A class has zero or more geom instances.</li><li>A geom has exactly one class it is derived from.</li><li>A geom has zero or more consumers.</li><li>A geom has zero or more providers.</li><li>A consumer can be attached to zero or one providers.</li><li>A provider can have zero or more consumers attached.</li></ul><p class=Pp>All geoms have a rank-number assigned, which is used to detect and prevent loops in the acyclic directed graph. This rank number is assigned as follows:</p><ol class=Bl-enum><li>A geom with no attached consumers has rank=1.</li><li>A geom with attached consumers has a rank one higher than the highest rank of the geoms of the providers its consumers are attached to.</li></ol></section><section class=Sh><h2 class=Sh id=SPECIAL_TOPOLOGICAL_MANEUVERS><a class=permalink href=#SPECIAL_TOPOLOGICAL_MANEUVERS>SPECIAL TOPOLOGICAL MANEUVERS</a></h2> In addition to the straightforward attach, which attaches a consumer to a provider, and detach, which breaks the bond, a number of special topological maneuvers exists to facilitate configuration and to improve the overall flexibility. <dl class=Bl-inset><dt><i class=Em>TASTING</i></dt><dd>is a process that happens whenever a new class or new provider is created, and it provides the class a chance to automatically configure an instance on providers which it recognizes as its own. A typical example is the MBR disk-partition class which will look for the MBR table in the first sector and, if found and validated, will instantiate a geom to multiplex according to the contents of the MBR. <p class=Pp>A new class will be offered to all existing providers in turn and a new provider will be offered to all classes in turn.</p><p class=Pp>Exactly what a class does to recognize if it should accept the offered provider is not defined by <code class=Nm>GEOM</code>, but the sensible set of options are:</p><ul class=Bl-bullet><li>Examine specific data structures on the disk.</li><li>Examine properties like “sectorsize” or “mediasize” for the provider.</li><li>Examine the rank number of the provider's geom.</li><li>Examine the method name of the provider's geom.</li></ul></dd><dt><i class=Em>ORPHANIZATION</i></dt><dd>is the process by which a provider is removed while it potentially is still being used. <p class=Pp>When a geom orphans a provider, all future I/O requests will “bounce” on the provider with an error code set by the geom. Any consumers attached to the provider will receive notification about the orphanization when the event loop gets around to it, and they can take appropriate action at that time.</p><p class=Pp>A geom which came into being as a result of a normal taste operation should self-destruct unless it has a way to keep functioning whilst lacking the orphaned provider. Geoms like disk slicers should therefore self-destruct whereas RAID5 or mirror geoms will be able to continue as long as they do not lose quorum.</p><p class=Pp>When a provider is orphaned, this does not necessarily result in any immediate change in the topology: any attached consumers are still attached, any opened paths are still open, any outstanding I/O requests are still outstanding.</p><p class=Pp>The typical scenario is:</p><p class=Pp></p><ul class="Bl-bullet Bd-indent Bl-compact"><li>A device driver detects a disk has departed and orphans the provider for it.</li><li>The geoms on top of the disk receive the orphanization event and orphan all their providers in turn. Providers which are not attached to will typically self-destruct right away. This process continues in a quasi-recursive fashion until all relevant pieces of the tree have heard the bad news.</li><li>Eventually the buck stops when it reaches geom_dev at the top of the stack.</li><li>Geom_dev will call <a class=Xr href=destroy_dev.9.html>destroy_dev(9)</a> to stop any more requests from coming in. It will sleep until any and all outstanding I/O requests have been returned. It will explicitly close (i.e.: zero the access counts), a change which will propagate all the way down through the mesh. It will then detach and destroy its geom.</li><li>The geom whose provider is now detached will destroy the provider, detach and destroy its consumer and destroy its geom.</li><li>This process percolates all the way down through the mesh, until the cleanup is complete.</li></ul><p class=Pp>While this approach seems byzantine, it does provide the maximum flexibility and robustness in handling disappearing devices.</p><p class=Pp>The one absolutely crucial detail to be aware of is that if the device driver does not return all I/O requests, the tree will not unravel.</p></dd><dt><i class=Em>SPOILING</i></dt><dd>is a special case of orphanization used to protect against stale metadata. It is probably easiest to understand spoiling by going through an example. <p class=Pp>Imagine a disk, <span class=Pa>da0</span>, on top of which an MBR geom provides <span class=Pa>da0s1</span> and <span class=Pa>da0s2</span>, and on top of <span class=Pa>da0s1</span> a BSD geom provides <span class=Pa>da0s1a</span> through <span class=Pa>da0s1e</span>, and that both the MBR and BSD geoms have autoconfigured based on data structures on the disk media. Now imagine the case where <span class=Pa>da0</span> is opened for writing and those data structures are modified or overwritten: now the geoms would be operating on stale metadata unless some notification system can inform them otherwise.</p><p class=Pp>To avoid this situation, when the open of <span class=Pa>da0</span> for write happens, all attached consumers are told about this and geoms like MBR and BSD will self-destruct as a result. When <span class=Pa>da0</span> is closed, it will be offered for tasting again and, if the data structures for MBR and BSD are still there, new geoms will instantiate themselves anew.</p><p class=Pp>Now for the fine print:</p><p class=Pp>If any of the paths through the MBR or BSD module were open, they would have opened downwards with an exclusive bit thus rendering it impossible to open <span class=Pa>da0</span> for writing in that case. Conversely, the requested exclusive bit would render it impossible to open a path through the MBR geom while <span class=Pa>da0</span> is open for writing.</p><p class=Pp>From this it also follows that changing the size of open geoms can only be done with their cooperation.</p><p class=Pp>Finally: the spoiling only happens when the write count goes from zero to non-zero and the retasting happens only when the write count goes from non-zero to zero.</p></dd><dt><i class=Em>CONFIGURE</i></dt><dd>is the process where the administrator issues instructions for a particular class to instantiate itself. There are multiple ways to express intent in this case - a particular provider may be specified with a level of override forcing, for instance, a BSD disklabel module to attach to a provider which was not found palatable during the TASTE operation. <p class=Pp>Finally, I/O is the reason we even do this: it concerns itself with sending I/O requests through the graph.</p></dd><dt><i class=Em>I/O REQUESTS</i>,</dt><dd>represented by <var class=Vt>struct bio</var>, originate at a consumer, are scheduled on its attached provider and, when processed, are returned to the consumer. It is important to realize that the <var class=Vt>struct bio</var> which enters through the provider of a particular geom does not “come out on the other side”. Even simple transformations like MBR and BSD will clone the <var class=Vt>struct bio</var>, modify the clone, and schedule the clone on their own consumer. Note that cloning the <var class=Vt>struct bio</var> does not involve cloning the actual data area specified in the I/O request. <p class=Pp>In total, four different I/O requests exist in <code class=Nm>GEOM</code>: read, write, delete, and “get attribute”.</p><p class=Pp>Read and write are self explanatory.</p><p class=Pp>Delete indicates that a certain range of data is no longer used and that it can be erased or freed as the underlying technology supports. Technologies like flash adaptation layers can arrange to erase the relevant blocks before they will become reassigned and cryptographic devices may want to fill random bits into the range to reduce the amount of data available for attack.</p><p class=Pp>It is important to recognize that a delete indication is not a request and consequently there is no guarantee that the data actually will be erased or made unavailable unless guaranteed by specific geoms in the graph. If “secure delete” semantics are required, a geom should be pushed which converts delete indications into (a sequence of) write requests.</p><p class=Pp>“Get attribute” supports inspection and manipulation of out-of-band attributes on a particular provider or path. Attributes are named by ASCII strings and they will be discussed in a separate section below.</p></dd></dl><p class=Pp>(Stay tuned while the author rests his brain and fingers: more to come.)</p></section><section class=Sh><h2 class=Sh id=DIAGNOSTICS><a class=permalink href=#DIAGNOSTICS>DIAGNOSTICS</a></h2> Several flags are provided for tracing <code class=Nm>GEOM</code> operations and unlocking protection mechanisms via the <var class=Va>kern.geom.debugflags</var> sysctl. All of these flags are off by default, and great care should be taken in turning them on. <dl class=Bl-tag><dt>0x01 (<code class=Dv>G_T_TOPOLOGY</code>)</dt><dd>Provide tracing of topology change events.</dd><dt>0x02 (<code class=Dv>G_T_BIO</code>)</dt><dd>Provide tracing of buffer I/O requests.</dd><dt>0x04 (<code class=Dv>G_T_ACCESS</code>)</dt><dd>Provide tracing of access check controls.</dd><dt>0x08 (unused)</dt><dd style="width: auto;"> </dd><dt>0x10 (allow foot shooting)</dt><dd>Allow writing to Rank 1 providers. This would, for example, allow the super-user to overwrite the MBR on the root disk or write random sectors elsewhere to a mounted disk. The implications are obvious.</dd><dt>0x40 (<code class=Dv>G_F_DISKIOCTL</code>)</dt><dd>This is unused at this time.</dd><dt>0x80 (<code class=Dv>G_F_CTLDUMP</code>)</dt><dd>Dump contents of gctl requests.</dd></dl></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=libgeom.3.html>libgeom(3)</a>, <a class=Xr href=DECLARE_GEOM_CLASS.9.html>DECLARE_GEOM_CLASS(9)</a>, <a class=Xr href=disk.9.html>disk(9)</a>, <a class=Xr href=g_access.9.html>g_access(9)</a>, <a class=Xr href=g_attach.9.html>g_attach(9)</a>, <a class=Xr href=g_bio.9.html>g_bio(9)</a>, <a class=Xr href=g_consumer.9.html>g_consumer(9)</a>, <a class=Xr href=g_data.9.html>g_data(9)</a>, <a class=Xr href=g_event.9.html>g_event(9)</a>, <a class=Xr href=g_geom.9.html>g_geom(9)</a>, <a class=Xr href=g_provider.9.html>g_provider(9)</a>, <a class=Xr href=g_provider_by_name.9.html>g_provider_by_name(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> This software was initially developed for the <span class=Ux>FreeBSD</span> Project by <span class=An>Poul-Henning Kamp</span> and NAI Labs, the Security Research Division of Network Associates, Inc. under DARPA/SPAWAR contract N66001-01-C-8035 (“CBOSS”), as part of the DARPA CHATS research program. <p class=Pp>The following obsolete <code class=Nm>GEOM</code> components were removed in <span class=Ux>FreeBSD 13.0</span>:</p><ul class="Bl-bullet Bd-indent Bl-compact"><li><code class=Cd>GEOM_BSD</code>,</li><li><code class=Cd>GEOM_FOX</code>,</li><li><code class=Cd>GEOM_MBR</code>,</li><li><code class=Cd>GEOM_SUNLABEL</code>, and</li><li><code class=Cd>GEOM_VOL</code>.</li></ul><p class=Pp>Use</p><ul class="Bl-bullet Bd-indent Bl-compact"><li><code class=Cd>GEOM_PART_BSD</code>,</li><li><code class=Cd>GEOM_MULTIPATH</code>,</li><li><code class=Cd>GEOM_PART_MBR</code>,</li><li><code class=Cd>GEOM_PART_VTOC8</code>, and</li><li><code class=Cd>GEOM_LABEL</code></li></ul> options, respectively, instead. </section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2><span class=An>Poul-Henning Kamp</span> &lt;<a class=Mt href=mailto:phk@FreeBSD.org>phk@FreeBSD.org</a>&gt; </section></div><table class=foot><tr><td class=foot-date>August 13, 2019</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>