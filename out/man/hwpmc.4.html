<!DOCTYPE html>
<html><head><meta charset=utf-8><title>hwpmc(4)</title><keywords content=man,hwpmc></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>hwpmc(4)</h1><table class=head><tr><td class=head-ltitle>HWPMC(4)</td><td class=head-vol>FreeBSD Kernel Interfaces Manual</td><td class=head-rtitle>HWPMC(4)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>hwpmc</code> — <div class=Nd>Hardware Performance Monitoring Counter support</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=Cd>options HWPMC_HOOKS</code><br><code class=Cd>device hwpmc</code><p class=Pp>Additionally, for i386 systems: <br><code class=Cd>device apic</code></p></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2> The <code class=Nm>hwpmc</code> driver virtualizes the hardware performance monitoring facilities in modern CPUs and provides support for using these facilities from user level processes. <p class=Pp>The driver supports multi-processor systems.</p><p class=Pp>PMCs are allocated using the <code class=Dv>PMC_OP_PMCALLOCATE</code> request. A successful <code class=Dv>PMC_OP_PMCALLOCATE</code> request will return a handle to the requesting process. Subsequent operations on the allocated PMC use this handle to denote the specific PMC. A process that has successfully allocated a PMC is termed an “owner process”.</p><p class=Pp>PMCs may be allocated with process or system scope.</p><dl class=Bl-tag><dt><i class=Em>Process-scope</i></dt><dd>The PMC is active only when a thread belonging to a process it is attached to is scheduled on a CPU.</dd><dt><i class=Em>System-scope</i></dt><dd>The PMC operates independently of processes and measures hardware events for the system as a whole.</dd></dl><p class=Pp>PMCs may be allocated for counting or for sampling:</p><dl class=Bl-tag><dt><i class=Em>Counting</i></dt><dd>In counting modes, the PMCs count hardware events. These counts are retrievable using the <code class=Dv>PMC_OP_PMCREAD</code> system call on all architectures. Some architectures offer faster methods of reading these counts.</dd><dt><i class=Em>Sampling</i></dt><dd>In sampling modes, the PMCs are configured to sample the CPU instruction pointer (and optionally to capture the call chain leading up to the sampled instruction pointer) after a configurable number of hardware events have been observed. Instruction pointer samples and call chain records are usually directed to a log file for subsequent analysis.</dd></dl><p class=Pp>Scope and operational mode are orthogonal; a PMC may thus be configured to operate in one of the following four modes:</p><dl class=Bl-tag><dt>Process-scope, counting</dt><dd>These PMCs count hardware events whenever a thread in their attached process is scheduled on a CPU. These PMCs normally count from zero, but the initial count may be set using the <code class=Dv>PMC_OP_SETCOUNT</code> operation. Applications can read the value of the PMC anytime using the <code class=Dv>PMC_OP_PMCRW</code> operation.</dd><dt>Process-scope, sampling</dt><dd>These PMCs sample the target processes instruction pointer after they have seen the configured number of hardware events. The PMCs only count events when a thread belonging to their attached process is active. The desired frequency of sampling is set using the <code class=Dv>PMC_OP_SETCOUNT</code> operation prior to starting the PMC. Log files are configured using the <code class=Dv>PMC_OP_CONFIGURELOG</code> operation.</dd><dt>System-scope, counting</dt><dd>These PMCs count hardware events seen by them independent of the processes that are executing. The current count on these PMCs can be read using the <code class=Dv>PMC_OP_PMCRW</code> request. These PMCs normally count from zero, but the initial count may be set using the <code class=Dv>PMC_OP_SETCOUNT</code> operation.</dd><dt>System-scope, sampling</dt><dd>These PMCs will periodically sample the instruction pointer of the CPU they are allocated on, and will write the sample to a log for further processing. The desired frequency of sampling is set using the <code class=Dv>PMC_OP_SETCOUNT</code> operation prior to starting the PMC. Log files are configured using the <code class=Dv>PMC_OP_CONFIGURELOG</code> operation. <p class=Pp>System-wide statistical sampling can only be enabled by a process with super-user privileges.</p></dd></dl><p class=Pp>Processes are allowed to allocate as many PMCs as the hardware and current operating conditions permit. Processes may mix allocations of system-wide and process-private PMCs. Multiple processes may be using PMCs simultaneously.</p><p class=Pp>Allocated PMCs are started using the <code class=Dv>PMC_OP_PMCSTART</code> operation, and stopped using the <code class=Dv>PMC_OP_PMCSTOP</code> operation. Stopping and starting a PMC is permitted at any time the owner process has a valid handle to the PMC.</p><p class=Pp>Process-private PMCs need to be attached to a target process before they can be used. Attaching a process to a PMC is done using the <code class=Dv>PMC_OP_PMCATTACH</code> operation. An already attached PMC may be detached from its target process using the converse <code class=Dv>PMC_OP_PMCDETACH</code> operation. Issuing a <code class=Dv>PMC_OP_PMCSTART</code> operation on an as yet unattached PMC will cause it to be attached to its owner process. The following rules determine whether a given process may attach a PMC to another target process:</p><ul class="Bl-bullet Bl-compact"><li>A non-jailed process with super-user privileges is allowed to attach to any other process in the system.</li><li>Other processes are only allowed to attach to targets that they would be able to attach to for debugging (as determined by <a class=Xr href=p_candebug.9.html>p_candebug(9)</a>).</li></ul><p class=Pp>PMCs are released using <code class=Dv>PMC_OP_PMCRELEASE</code>. After a successful <code class=Dv>PMC_OP_PMCRELEASE</code> operation the handle to the PMC will become invalid.</p><section class=Ss><h2 class=Ss id=Modifier_Flags><a class=permalink href=#Modifier_Flags>Modifier Flags</a></h2> The <code class=Dv>PMC_OP_PMCALLOCATE</code> operation supports the following flags that modify the behavior of an allocated PMC: <dl class=Bl-tag><dt><a class=permalink href=#PMC_F_CALLCHAIN><code class=Dv id=PMC_F_CALLCHAIN>PMC_F_CALLCHAIN</code></a></dt><dd>This modifier informs sampling PMCs to record a callchain when capturing a sample. The maximum depth to which call chains are recorded is specified by the <var class=Va>kern.hwpmc.callchaindepth</var> kernel tunable.</dd><dt><a class=permalink href=#PMC_F_DESCENDANTS><code class=Dv id=PMC_F_DESCENDANTS>PMC_F_DESCENDANTS</code></a></dt><dd>This modifier is valid only for a PMC being allocated in process-private mode. It signifies that the PMC will track hardware events for its target process and the target's current and future descendants.</dd><dt><a class=permalink href=#PMC_F_LOG_PROCCSW><code class=Dv id=PMC_F_LOG_PROCCSW>PMC_F_LOG_PROCCSW</code></a></dt><dd>This modifier is valid only for a PMC being allocated in process-private mode. When this modifier is present, at every context switch, <code class=Nm>hwpmc</code> will log a record containing the number of hardware events seen by the target process when it was scheduled on the CPU.</dd><dt><a class=permalink href=#PMC_F_LOG_PROCEXIT><code class=Dv id=PMC_F_LOG_PROCEXIT>PMC_F_LOG_PROCEXIT</code></a></dt><dd>This modifier is valid only for a PMC being allocated in process-private mode. With this modifier present, <code class=Nm>hwpmc</code> will maintain per-process counts for each target process attached to a PMC. At process exit time, a record containing the target process' PID and the accumulated per-process count for that process will be written to the configured log file.</dd></dl><p class=Pp>Modifiers <code class=Dv>PMC_F_LOG_PROCEXIT</code> and <code class=Dv>PMC_F_LOG_PROCCSW</code> may be used in combination with modifier <code class=Dv>PMC_F_DESCENDANTS</code> to track the behavior of complex pipelines of processes. PMCs with modifiers <code class=Dv>PMC_F_LOG_PROCEXIT</code> and <code class=Dv>PMC_F_LOG_PROCCSW</code> cannot be started until their owner process has configured a log file.</p></section><section class=Ss><h2 class=Ss id=Signals><a class=permalink href=#Signals>Signals</a></h2> The <code class=Nm>hwpmc</code> driver may deliver signals to processes that have allocated PMCs: <dl class=Bl-tag><dt><a class=permalink href=#SIGIO><code class=Dv id=SIGIO>SIGIO</code></a></dt><dd>A <code class=Dv>PMC_OP_PMCRW</code> operation was attempted on a process-private PMC that does not have attached target processes.</dd><dt><a class=permalink href=#SIGBUS><code class=Dv id=SIGBUS>SIGBUS</code></a></dt><dd>The <code class=Nm>hwpmc</code> driver is being unloaded from the kernel.</dd></dl></section><section class=Ss><h2 class=Ss id=PMC_ROW_DISPOSITIONS><a class=permalink href=#PMC_ROW_DISPOSITIONS>PMC ROW DISPOSITIONS</a></h2> A PMC row is defined as the set of PMC resources at the same hardware address in the CPUs in a system. Since process scope PMCs need to move between CPUs following their target threads, allocation of a process scope PMC reserves all PMCs in a PMC row for use only with process scope PMCs. Accordingly a PMC row will be in one of the following dispositions: <dl class="Bl-tag Bl-compact"><dt><a class=permalink href=#PMC_DISP_FREE><code class=Dv id=PMC_DISP_FREE>PMC_DISP_FREE</code></a></dt><dd>Hardware counters in this row are free and may be use to satisfy either of system scope or process scope allocation requests.</dd><dt><a class=permalink href=#PMC_DISP_THREAD><code class=Dv id=PMC_DISP_THREAD>PMC_DISP_THREAD</code></a></dt><dd>Hardware counters in this row are in use by process scope PMCs and are only available for process scope allocation requests.</dd><dt><a class=permalink href=#PMC_DISP_STANDALONE><code class=Dv id=PMC_DISP_STANDALONE>PMC_DISP_STANDALONE</code></a></dt><dd>Some hardware counters in this row have been administratively disabled or are in use by system scope PMCs. Non-disabled hardware counters in such a row may be used for satisfying system scope allocation requests. No process scope PMCs will use hardware counters in this row.</dd></dl></section></section><section class=Sh><h2 class=Sh id=PROGRAMMING_API><a class=permalink href=#PROGRAMMING_API>PROGRAMMING API</a></h2> The recommended way for application programs to use the facilities of the <code class=Nm>hwpmc</code> driver is using the API provided by the <a class=Xr href=pmc.3.html>pmc(3)</a> library. <p class=Pp>The <code class=Nm>hwpmc</code> driver operates using a system call number that is dynamically allotted to it when it is loaded into the kernel.</p><p class=Pp>The <code class=Nm>hwpmc</code> driver supports the following operations:</p><dl class=Bl-tag><dt><a class=permalink href=#PMC_OP_CONFIGURELOG><code class=Dv id=PMC_OP_CONFIGURELOG>PMC_OP_CONFIGURELOG</code></a></dt><dd>Configure a log file for PMCs that require a log file. The <code class=Nm>hwpmc</code> driver will write log data to this file asynchronously. If it encounters an error, logging will be stopped and the error code encountered will be saved for subsequent retrieval by a <code class=Dv>PMC_OP_FLUSHLOG</code> request.</dd><dt><a class=permalink href=#PMC_OP_FLUSHLOG><code class=Dv id=PMC_OP_FLUSHLOG>PMC_OP_FLUSHLOG</code></a></dt><dd>Transfer buffered log data inside <code class=Nm>hwpmc</code> to a configured output file. This operation returns to the caller after the write operation has returned. The returned error code reflects any pending error state inside <code class=Nm>hwpmc</code>.</dd><dt><a class=permalink href=#PMC_OP_GETCPUINFO><code class=Dv id=PMC_OP_GETCPUINFO>PMC_OP_GETCPUINFO</code></a></dt><dd>Retrieve information about the highest possible CPU number for the system, and the number of hardware performance monitoring counters available per CPU.</dd><dt><a class=permalink href=#PMC_OP_GETDRIVERSTATS><code class=Dv id=PMC_OP_GETDRIVERSTATS>PMC_OP_GETDRIVERSTATS</code></a></dt><dd>Retrieve module statistics (for analyzing the behavior of <code class=Nm>hwpmc</code> itself).</dd><dt><a class=permalink href=#PMC_OP_GETMODULEVERSION><code class=Dv id=PMC_OP_GETMODULEVERSION>PMC_OP_GETMODULEVERSION</code></a></dt><dd>Retrieve the version number of API.</dd><dt><a class=permalink href=#PMC_OP_GETPMCINFO><code class=Dv id=PMC_OP_GETPMCINFO>PMC_OP_GETPMCINFO</code></a></dt><dd>Retrieve information about the current state of the PMCs on a given CPU.</dd><dt><a class=permalink href=#PMC_OP_PMCADMIN><code class=Dv id=PMC_OP_PMCADMIN>PMC_OP_PMCADMIN</code></a></dt><dd>Set the administrative state (i.e., whether enabled or disabled) for the hardware PMCs managed by the <code class=Nm>hwpmc</code> driver. The invoking process needs to possess the <code class=Dv>PRIV_PMC_MANAGE</code> privilege.</dd><dt><a class=permalink href=#PMC_OP_PMCALLOCATE><code class=Dv id=PMC_OP_PMCALLOCATE>PMC_OP_PMCALLOCATE</code></a></dt><dd>Allocate and configure a PMC. On successful allocation, a handle to the PMC (a 32 bit value) is returned.</dd><dt><a class=permalink href=#PMC_OP_PMCATTACH><code class=Dv id=PMC_OP_PMCATTACH>PMC_OP_PMCATTACH</code></a></dt><dd>Attach a process mode PMC to a target process. The PMC will be active whenever a thread in the target process is scheduled on a CPU. <p class=Pp>If the <code class=Dv>PMC_F_DESCENDANTS</code> flag had been specified at PMC allocation time, then the PMC is attached to all current and future descendants of the target process.</p></dd><dt><a class=permalink href=#PMC_OP_PMCDETACH><code class=Dv id=PMC_OP_PMCDETACH>PMC_OP_PMCDETACH</code></a></dt><dd>Detach a PMC from its target process.</dd><dt><a class=permalink href=#PMC_OP_PMCRELEASE><code class=Dv id=PMC_OP_PMCRELEASE>PMC_OP_PMCRELEASE</code></a></dt><dd>Release a PMC.</dd><dt><a class=permalink href=#PMC_OP_PMCRW><code class=Dv id=PMC_OP_PMCRW>PMC_OP_PMCRW</code></a></dt><dd>Read and write a PMC. This operation is valid only for PMCs configured in counting modes.</dd><dt><a class=permalink href=#PMC_OP_SETCOUNT><code class=Dv id=PMC_OP_SETCOUNT>PMC_OP_SETCOUNT</code></a></dt><dd>Set the initial count (for counting mode PMCs) or the desired sampling rate (for sampling mode PMCs).</dd><dt><a class=permalink href=#PMC_OP_PMCSTART><code class=Dv id=PMC_OP_PMCSTART>PMC_OP_PMCSTART</code></a></dt><dd>Start a PMC.</dd><dt><a class=permalink href=#PMC_OP_PMCSTOP><code class=Dv id=PMC_OP_PMCSTOP>PMC_OP_PMCSTOP</code></a></dt><dd>Stop a PMC.</dd><dt><a class=permalink href=#PMC_OP_WRITELOG><code class=Dv id=PMC_OP_WRITELOG>PMC_OP_WRITELOG</code></a></dt><dd>Insert a timestamped user record into the log file.</dd></dl><section class=Ss><h2 class=Ss id=i386_Specific_API><a class=permalink href=#i386_Specific_API>i386 Specific API</a></h2> Some i386 family CPUs support the RDPMC instruction which allows a user process to read a PMC value without needing to invoke a <code class=Dv>PMC_OP_PMCRW</code> operation. On such CPUs, the machine address associated with an allocated PMC is retrievable using the <code class=Dv>PMC_OP_PMCX86GETMSR</code> system call. <dl class=Bl-tag><dt><a class=permalink href=#PMC_OP_PMCX86GETMSR><code class=Dv id=PMC_OP_PMCX86GETMSR>PMC_OP_PMCX86GETMSR</code></a></dt><dd>Retrieve the MSR (machine specific register) number associated with the given PMC handle. <p class=Pp>The PMC needs to be in process-private mode and allocated without the <code class=Dv>PMC_F_DESCENDANTS</code> modifier flag, and should be attached only to its owner process at the time of the call.</p></dd></dl></section><section class=Ss><h2 class=Ss id=amd64_Specific_API><a class=permalink href=#amd64_Specific_API>amd64 Specific API</a></h2> AMD64 CPUs support the RDPMC instruction which allows a user process to read a PMC value without needing to invoke a <code class=Dv>PMC_OP_PMCRW</code> operation. The machine address associated with an allocated PMC is retrievable using the <code class=Dv>PMC_OP_PMCX86GETMSR</code> system call. <dl class=Bl-tag><dt><a class=permalink href=#PMC_OP_PMCX86GETMSR_2><code class=Dv id=PMC_OP_PMCX86GETMSR_2>PMC_OP_PMCX86GETMSR</code></a></dt><dd>Retrieve the MSR (machine specific register) number associated with the given PMC handle. <p class=Pp>The PMC needs to be in process-private mode and allocated without the <code class=Dv>PMC_F_DESCENDANTS</code> modifier flag, and should be attached only to its owner process at the time of the call.</p></dd></dl></section></section><section class=Sh><h2 class=Sh id=SYSCTL_VARIABLES_AND_LOADER_TUNABLES><a class=permalink href=#SYSCTL_VARIABLES_AND_LOADER_TUNABLES>SYSCTL VARIABLES AND LOADER TUNABLES</a></h2> The behavior of <code class=Nm>hwpmc</code> is influenced by the following <a class=Xr href=sysctl.8.html>sysctl(8)</a> and <a class=Xr href=loader.8.html>loader(8)</a> tunables: <dl class=Bl-tag><dt><var class=Va>kern.hwpmc.callchaindepth</var> (integer, read-only)</dt><dd>The maximum number of call chain records to capture per sample. The default is 8.</dd><dt><var class=Va>kern.hwpmc.debugflags</var> (string, read-write)</dt><dd>(Only available if the <code class=Nm>hwpmc</code> driver was compiled with <code class=Fl>-DDEBUG</code>.) Control the verbosity of debug messages from the <code class=Nm>hwpmc</code> driver.</dd><dt><var class=Va>kern.hwpmc.hashsize</var> (integer, read-only)</dt><dd>The number of rows in the hash tables used to keep track of owner and target processes. The default is 16.</dd><dt><var class=Va>kern.hwpmc.logbuffersize</var> (integer, read-only)</dt><dd>The size in kilobytes of each log buffer used by <code class=Nm>hwpmc</code>'s logging function. The default buffer size is 4KB.</dd><dt><var class=Va>kern.hwpmc.mincount</var> (integer, read-write)</dt><dd>The minimum sampling rate for sampling mode PMCs. The default count is 1000 events.</dd><dt><var class=Va>kern.hwpmc.mtxpoolsize</var> (integer, read-only)</dt><dd>The size of the spin mutex pool used by the PMC driver. The default is 32.</dd><dt><var class=Va>kern.hwpmc.nbuffers_pcpu</var> (integer, read-only)</dt><dd>The number of log buffers used by <code class=Nm>hwpmc</code> for logging. The default is 64.</dd><dt><var class=Va>kern.hwpmc.nsamples</var> (integer, read-only)</dt><dd>The number of entries in the per-CPU ring buffer used during sampling. The default is 512.</dd><dt><var class=Va>security.bsd.unprivileged_syspmcs</var> (boolean, read-write)</dt><dd>If set to non-zero, allow unprivileged processes to allocate system-wide PMCs. The default value is 0.</dd><dt><var class=Va>security.bsd.unprivileged_proc_debug</var> (boolean, read-write)</dt><dd>If set to 0, the <code class=Nm>hwpmc</code> driver will only allow privileged processes to attach PMCs to other processes.</dd></dl><p class=Pp>These variables may be set in the kernel environment using <a class=Xr href=kenv.1.html>kenv(1)</a> before <code class=Nm>hwpmc</code> is loaded.</p></section><section class=Sh><h2 class=Sh id=IMPLEMENTATION_NOTES><a class=permalink href=#IMPLEMENTATION_NOTES>IMPLEMENTATION NOTES</a></h2><section class=Ss><h2 class=Ss id=SMP_Symmetry><a class=permalink href=#SMP_Symmetry>SMP Symmetry</a></h2> The kernel driver requires all physical CPUs in an SMP system to have identical performance monitoring counter hardware. </section><section class=Ss><h2 class=Ss id=Sparse_CPU_Numbering><a class=permalink href=#Sparse_CPU_Numbering>Sparse CPU Numbering</a></h2> On platforms that sparsely number CPUs and which support hot-plugging of CPUs, requests that specify non-existent or disabled CPUs will fail with an error. Applications allocating system-scope PMCs need to be aware of the possibility of such transient failures. </section><section class=Ss><h2 class=Ss id=x86_TSC_Handling><a class=permalink href=#x86_TSC_Handling>x86 TSC Handling</a></h2> Historically, on the x86 architecture, <span class=Ux>FreeBSD</span> has permitted user processes running at a processor CPL of 3 to read the TSC using the RDTSC instruction. The <code class=Nm>hwpmc</code> driver preserves this behavior. </section><section class=Ss><h2 class=Ss id=Intel_P4/HTT_Handling><a class=permalink href=#Intel_P4/HTT_Handling>Intel P4/HTT Handling</a></h2> On CPUs with HTT support, Intel P4 PMCs are capable of qualifying only a subset of hardware events on a per-logical CPU basis. Consequently, if HTT is enabled on a system with Intel Pentium P4 PMCs, then the <code class=Nm>hwpmc</code> driver will reject allocation requests for process-private PMCs that request counting of hardware events that cannot be counted separately for each logical CPU. </section><section class=Ss><h2 class=Ss id=Intel_Pentium_Pro_Handling><a class=permalink href=#Intel_Pentium_Pro_Handling>Intel Pentium-Pro Handling</a></h2> Writing a value to the PMC MSRs found in Intel Pentium-Pro style PMCs (found in Intel Pentium Pro, Pentium II, Pentium III, Pentium M and Celeron processors) will replicate bit 31 of the value being written into the upper 8 bits of the MSR, bringing down the usable width of these PMCs to 31 bits. For process-virtual PMCs, the <code class=Nm>hwpmc</code> driver implements a workaround in software and makes the corrected 64 bit count available via the <code class=Dv>PMC_OP_RW</code> operation. Processes that intend to use RDPMC instructions directly or that intend to write values larger than 2^31 into these PMCs with <code class=Dv>PMC_OP_RW</code> need to be aware of this hardware limitation. </section></section><section class=Sh><h2 class=Sh id=DIAGNOSTICS><a class=permalink href=#DIAGNOSTICS>DIAGNOSTICS</a></h2><dl class=Bl-diag><dt>hwpmc: [class/npmc/capabilities]...</dt><dd>Announce the presence of <var class=Va>npmc</var> PMCs of class <var class=Va>class</var>, with capabilities described by bit string <var class=Va>capabilities</var>.</dd><dt>hwpmc: kernel version (0x%x) does not match module version (0x%x).</dt><dd>The module loading process failed because a version mismatch was detected between the currently executing kernel and the module being loaded.</dd><dt>hwpmc: this kernel has not been compiled with 'options HWPMC_HOOKS'.</dt><dd>The module loading process failed because the currently executing kernel was not configured with the required configuration option <code class=Dv>HWPMC_HOOKS</code>.</dd><dt>hwpmc: tunable hashsize=%d must be greater than zero.</dt><dd>A negative value was supplied for tunable <var class=Va>kern.hwpmc.hashsize</var>.</dd><dt>hwpmc: tunable logbuffersize=%d must be greater than zero.</dt><dd>A negative value was supplied for tunable <var class=Va>kern.hwpmc.logbuffersize</var>.</dd><dt>hwpmc: tunable nlogbuffers=%d must be greater than zero.</dt><dd>A negative value was supplied for tunable <var class=Va>kern.hwpmc.nlogbuffers</var>.</dd><dt>hwpmc: tunable nsamples=%d out of range.</dt><dd>The value for tunable <var class=Va>kern.hwpmc.nsamples</var> was negative or greater than 65535.</dd></dl></section><section class=Sh><h2 class=Sh id=COMPATIBILITY><a class=permalink href=#COMPATIBILITY>COMPATIBILITY</a></h2> The <code class=Nm>hwpmc</code> driver is currently under development. The API and ABI documented in this manual page may change in the future. The recommended method of accessing this driver is using the <a class=Xr href=pmc.3.html>pmc(3)</a> API. </section><section class=Sh><h2 class=Sh id=ERRORS><a class=permalink href=#ERRORS>ERRORS</a></h2> A command issued to the <code class=Nm>hwpmc</code> driver may fail with the following errors: <dl class=Bl-tag><dt>[<a class=permalink href=#EAGAIN><code class=Er id=EAGAIN>EAGAIN</code></a>]</dt><dd>Helper process creation failed for a <code class=Dv>PMC_OP_CONFIGURELOG</code> request due to a temporary resource shortage in the kernel.</dd><dt>[<a class=permalink href=#EBUSY><code class=Er id=EBUSY>EBUSY</code></a>]</dt><dd>A <code class=Dv>PMC_OP_CONFIGURELOG</code> operation was requested while an existing log was active.</dd><dt>[<a class=permalink href=#EBUSY_2><code class=Er id=EBUSY_2>EBUSY</code></a>]</dt><dd>A DISABLE operation was requested using the <code class=Dv>PMC_OP_PMCADMIN</code> request for a set of hardware resources currently in use for process-private PMCs.</dd><dt>[<a class=permalink href=#EBUSY_3><code class=Er id=EBUSY_3>EBUSY</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCADMIN</code> operation was requested on an active system mode PMC.</dd><dt>[<a class=permalink href=#EBUSY_4><code class=Er id=EBUSY_4>EBUSY</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCATTACH</code> operation was requested for a target process that already had another PMC using the same hardware resources attached to it.</dd><dt>[<a class=permalink href=#EBUSY_5><code class=Er id=EBUSY_5>EBUSY</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCRW</code> request writing a new value was issued on a PMC that was active.</dd><dt>[<a class=permalink href=#EBUSY_6><code class=Er id=EBUSY_6>EBUSY</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCSETCOUNT</code> request was issued on a PMC that was active.</dd><dt>[<a class=permalink href=#EDOOFUS><code class=Er id=EDOOFUS>EDOOFUS</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCSTART</code> operation was requested without a log file being configured for a PMC allocated with <code class=Dv>PMC_F_LOG_PROCCSW</code> and <code class=Dv>PMC_F_LOG_PROCEXIT</code> modifiers.</dd><dt>[<a class=permalink href=#EDOOFUS_2><code class=Er id=EDOOFUS_2>EDOOFUS</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCSTART</code> operation was requested on a system-wide sampling PMC without a log file being configured.</dd><dt>[<a class=permalink href=#EEXIST><code class=Er id=EEXIST>EEXIST</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCATTACH</code> request was reissued for a target process that already is the target of this PMC.</dd><dt>[<a class=permalink href=#EFAULT><code class=Er id=EFAULT>EFAULT</code></a>]</dt><dd>A bad address was passed in to the driver.</dd><dt>[<a class=permalink href=#EINVAL><code class=Er id=EINVAL>EINVAL</code></a>]</dt><dd>An invalid PMC handle was specified.</dd><dt>[<a class=permalink href=#EINVAL_2><code class=Er id=EINVAL_2>EINVAL</code></a>]</dt><dd>An invalid CPU number was passed in for a <code class=Dv>PMC_OP_GETPMCINFO</code> operation.</dd><dt>[<a class=permalink href=#EINVAL_3><code class=Er id=EINVAL_3>EINVAL</code></a>]</dt><dd>A <code class=Dv>PMC_OP_CONFIGURELOG</code> request to de-configure a log file was issued without a log file being configured.</dd><dt>[<a class=permalink href=#EINVAL_4><code class=Er id=EINVAL_4>EINVAL</code></a>]</dt><dd>A <code class=Dv>PMC_OP_FLUSHLOG</code> request was issued without a log file being configured.</dd><dt>[<a class=permalink href=#EINVAL_5><code class=Er id=EINVAL_5>EINVAL</code></a>]</dt><dd>An invalid CPU number was passed in for a <code class=Dv>PMC_OP_PMCADMIN</code> operation.</dd><dt>[<a class=permalink href=#EINVAL_6><code class=Er id=EINVAL_6>EINVAL</code></a>]</dt><dd>An invalid operation request was passed in for a <code class=Dv>PMC_OP_PMCADMIN</code> operation.</dd><dt>[<a class=permalink href=#EINVAL_7><code class=Er id=EINVAL_7>EINVAL</code></a>]</dt><dd>An invalid PMC ID was passed in for a <code class=Dv>PMC_OP_PMCADMIN</code> operation.</dd><dt>[<a class=permalink href=#EINVAL_8><code class=Er id=EINVAL_8>EINVAL</code></a>]</dt><dd>A suitable PMC matching the parameters passed in to a <code class=Dv>PMC_OP_PMCALLOCATE</code> request could not be allocated.</dd><dt>[<a class=permalink href=#EINVAL_9><code class=Er id=EINVAL_9>EINVAL</code></a>]</dt><dd>An invalid PMC mode was requested during a <code class=Dv>PMC_OP_PMCALLOCATE</code> request.</dd><dt>[<a class=permalink href=#EINVAL_10><code class=Er id=EINVAL_10>EINVAL</code></a>]</dt><dd>An invalid CPU number was specified during a <code class=Dv>PMC_OP_PMCALLOCATE</code> request.</dd><dt>[<a class=permalink href=#EINVAL_11><code class=Er id=EINVAL_11>EINVAL</code></a>]</dt><dd>A CPU other than <code class=Dv>PMC_CPU_ANY</code> was specified in a <code class=Dv>PMC_OP_PMCALLOCATE</code> request for a process-private PMC.</dd><dt>[<a class=permalink href=#EINVAL_12><code class=Er id=EINVAL_12>EINVAL</code></a>]</dt><dd>A CPU number of <code class=Dv>PMC_CPU_ANY</code> was specified in a <code class=Dv>PMC_OP_PMCALLOCATE</code> request for a system-wide PMC.</dd><dt>[<a class=permalink href=#EINVAL_13><code class=Er id=EINVAL_13>EINVAL</code></a>]</dt><dd>The <var class=Ar>pm_flags</var> argument to an <code class=Dv>PMC_OP_PMCALLOCATE</code> request contained unknown flags.</dd><dt>[<a class=permalink href=#EINVAL_14><code class=Er id=EINVAL_14>EINVAL</code></a>]</dt><dd>(On Intel Pentium 4 CPUs with HTT support) A <code class=Dv>PMC_OP_PMCALLOCATE</code> request for a process-private PMC was issued for an event that does not support counting on a per-logical CPU basis.</dd><dt>[<a class=permalink href=#EINVAL_15><code class=Er id=EINVAL_15>EINVAL</code></a>]</dt><dd>A PMC allocated for system-wide operation was specified with a <code class=Dv>PMC_OP_PMCATTACH</code> or <code class=Dv>PMC_OP_PMCDETACH</code> request.</dd><dt>[<a class=permalink href=#EINVAL_16><code class=Er id=EINVAL_16>EINVAL</code></a>]</dt><dd>The <var class=Ar>pm_pid</var> argument to a <code class=Dv>PMC_OP_PMCATTACH</code> or <code class=Dv>PMC_OP_PMCDETACH</code> request specified an illegal process ID.</dd><dt>[<a class=permalink href=#EINVAL_17><code class=Er id=EINVAL_17>EINVAL</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCDETACH</code> request was issued for a PMC not attached to the target process.</dd><dt>[<a class=permalink href=#EINVAL_18><code class=Er id=EINVAL_18>EINVAL</code></a>]</dt><dd>Argument <var class=Ar>pm_flags</var> to a <code class=Dv>PMC_OP_PMCRW</code> request contained illegal flags.</dd><dt>[<a class=permalink href=#EINVAL_19><code class=Er id=EINVAL_19>EINVAL</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCX86GETMSR</code> operation was requested for a PMC not in process-virtual mode, or for a PMC that is not solely attached to its owner process, or for a PMC that was allocated with flag <code class=Dv>PMC_F_DESCENDANTS</code>.</dd><dt>[<a class=permalink href=#EINVAL_20><code class=Er id=EINVAL_20>EINVAL</code></a>]</dt><dd>A <code class=Dv>PMC_OP_WRITELOG</code> request was issued for an owner process without a log file configured.</dd><dt>[<a class=permalink href=#ENOMEM><code class=Er id=ENOMEM>ENOMEM</code></a>]</dt><dd>The system was not able to allocate kernel memory.</dd><dt>[<a class=permalink href=#ENOSYS><code class=Er id=ENOSYS>ENOSYS</code></a>]</dt><dd>(On i386 and amd64 architectures) A <code class=Dv>PMC_OP_PMCX86GETMSR</code> operation was requested for hardware that does not support reading PMCs directly with the RDPMC instruction.</dd><dt>[<a class=permalink href=#ENXIO><code class=Er id=ENXIO>ENXIO</code></a>]</dt><dd>A <code class=Dv>PMC_OP_GETPMCINFO</code> operation was requested for an absent or disabled CPU.</dd><dt>[<a class=permalink href=#ENXIO_2><code class=Er id=ENXIO_2>ENXIO</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCALLOCATE</code> operation specified allocation of a system-wide PMC on an absent or disabled CPU.</dd><dt>[<a class=permalink href=#ENXIO_3><code class=Er id=ENXIO_3>ENXIO</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCSTART</code> or <code class=Dv>PMC_OP_PMCSTOP</code> request was issued for a system-wide PMC that was allocated on a CPU that is currently absent or disabled.</dd><dt>[<a class=permalink href=#EOPNOTSUPP><code class=Er id=EOPNOTSUPP>EOPNOTSUPP</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCALLOCATE</code> request was issued for PMC capabilities not supported by the specified PMC class.</dd><dt>[<a class=permalink href=#EOPNOTSUPP_2><code class=Er id=EOPNOTSUPP_2>EOPNOTSUPP</code></a>]</dt><dd>(i386 architectures) A sampling mode PMC was requested on a CPU lacking an APIC.</dd><dt>[<a class=permalink href=#EPERM><code class=Er id=EPERM>EPERM</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCADMIN</code> request was issued by a process without super-user privilege or by a jailed super-user process.</dd><dt>[<a class=permalink href=#EPERM_2><code class=Er id=EPERM_2>EPERM</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCATTACH</code> operation was issued for a target process that the current process does not have permission to attach to.</dd><dt>[<a class=permalink href=#EPERM_3><code class=Er id=EPERM_3>EPERM</code></a>]</dt><dd>(i386 and amd64 architectures) A <code class=Dv>PMC_OP_PMCATTACH</code> operation was issued on a PMC whose MSR has been retrieved using <code class=Dv>PMC_OP_PMCX86GETMSR</code>.</dd><dt>[<a class=permalink href=#ESRCH><code class=Er id=ESRCH>ESRCH</code></a>]</dt><dd>A process issued a PMC operation request without having allocated any PMCs.</dd><dt>[<a class=permalink href=#ESRCH_2><code class=Er id=ESRCH_2>ESRCH</code></a>]</dt><dd>A process issued a PMC operation request after the PMC was detached from all of its target processes.</dd><dt>[<a class=permalink href=#ESRCH_3><code class=Er id=ESRCH_3>ESRCH</code></a>]</dt><dd>A <code class=Dv>PMC_OP_PMCATTACH</code> or <code class=Dv>PMC_OP_PMCDETACH</code> request specified a non-existent process ID.</dd><dt>[<a class=permalink href=#ESRCH_4><code class=Er id=ESRCH_4>ESRCH</code></a>]</dt><dd>The target process for a <code class=Dv>PMC_OP_PMCDETACH</code> operation is not being monitored by <code class=Nm>hwpmc</code>.</dd></dl></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=kenv.1.html>kenv(1)</a>, <a class=Xr href=pmc.3.html>pmc(3)</a>, <a class=Xr href=pmclog.3.html>pmclog(3)</a>, <a class=Xr href=kldload.8.html>kldload(8)</a>, <a class=Xr href=pmccontrol.8.html>pmccontrol(8)</a>, <a class=Xr href=pmcstat.8.html>pmcstat(8)</a>, <a class=Xr href=sysctl.8.html>sysctl(8)</a>, <a class=Xr href=kproc_create.9.html>kproc_create(9)</a>, <a class=Xr href=p_candebug.9.html>p_candebug(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The <code class=Nm>hwpmc</code> driver first appeared in <span class=Ux>FreeBSD 6.0</span>. </section><section class=Sh><h2 class=Sh id=AUTHORS><a class=permalink href=#AUTHORS>AUTHORS</a></h2> The <code class=Nm>hwpmc</code> driver was written by <span class=An>Joseph Koshy</span> &lt;<a class=Mt href=mailto:jkoshy@FreeBSD.org>jkoshy@FreeBSD.org</a>&gt;. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> The driver samples the state of the kernel's logical processor support at the time of initialization (i.e., at module load time). On CPUs supporting logical processors, the driver could misbehave if logical processors are subsequently enabled or disabled while the driver is active. <p class=Pp>On the i386 architecture, the driver requires that the local APIC on the CPU be enabled for sampling mode to be supported. Many single-processor motherboards keep the APIC disabled in BIOS; on such systems <code class=Nm>hwpmc</code> will not support sampling PMCs.</p></section><section class=Sh><h2 class=Sh id=SECURITY_CONSIDERATIONS><a class=permalink href=#SECURITY_CONSIDERATIONS>SECURITY CONSIDERATIONS</a></h2> PMCs may be used to monitor the actual behavior of the system on hardware. In situations where this constitutes an undesirable information leak, the following options are available: <ol class=Bl-enum><li>Set the <a class=Xr href=sysctl.8.html>sysctl(8)</a> tunable <var class=Va>security.bsd.unprivileged_syspmcs</var> to 0. This ensures that unprivileged processes cannot allocate system-wide PMCs and thus cannot observe the hardware behavior of the system as a whole. This tunable may also be set at boot time using <a class=Xr href=loader.8.html>loader(8)</a>, or with <a class=Xr href=kenv.1.html>kenv(1)</a> prior to loading the <code class=Nm>hwpmc</code> driver into the kernel.</li><li>Set the <a class=Xr href=sysctl.8.html>sysctl(8)</a> tunable <var class=Va>security.bsd.unprivileged_proc_debug</var> to 0. This will ensure that an unprivileged process cannot attach a PMC to any process other than itself and thus cannot observe the hardware behavior of other processes with the same credentials.</li></ol><p class=Pp>System administrators should note that on IA-32 platforms <span class=Ux>FreeBSD</span> makes the content of the IA-32 TSC counter available to all processes via the RDTSC instruction.</p></section></div><table class=foot><tr><td class=foot-date>April 3, 2021</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>