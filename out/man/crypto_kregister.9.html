<!DOCTYPE html>
<html><head><meta charset=utf-8><title>crypto_kregister(9)</title><keywords content=man,crypto_kregister></keywords><style>:root { --monitor-bleed: rgba(183, 0, 255, 0.46); --gradient: -webkit-linear-gradient(50deg, rgb(126, 119, 255), rgb(255, 34, 137)); --background-colour: #fff; --title-colour: #000; --text-colour: #000; --article-colour: #fff; --accent-colour: #4385f5; --muted-colour: #555; --shadow-colour: rgba(183, 0, 255, 0.487); --border-radius: 12px; --blur-radius: 0px; --navbar-colour: #fffc; --navbar-shadow: rgba(183, 0, 255, 0.1) 0 8px 32px; --code-background: #ddd; } .dark { visibility: hidden; } @media (prefers-color-scheme: light) { } @media (prefers-color-scheme: dark) { :root { --monitor-bleed: rgba(183, 0, 255, 0.172); --gradient: -webkit-linear-gradient(50deg, rgb(255, 79, 79), rgb(255, 52, 221)); --background-colour: #000; --title-colour: #fff; --text-colour: #ddd; --article-colour: #00000033; --accent-colour: #98beff; --muted-colour: #999; --shadow-colour: #ff00cc29; --blur-radius: 96px; --navbar-colour: #000a; --navbar-shadow: rgba(183, 0, 255, 0.05) 0 8px 32px; --code-background: #111; } .dark { visibility: visible; } .light { visibility: hidden; } } html, body { overflow-x: hidden; } body { background-image: url(bg.svg); background-size: cover; margin: 0; background-color: var(--background-colour); color: var(--text-colour); font-size: 22px; font-display: optional; font-family: "Montserrat", sans-serif; overflow-y: hidden; } h1 { color: var(--title-colour); font-size: 70px; font-display: optional; font-family: "Montserrat", sans-serif; } h2 { color: var(--title-colour); font-size: 40px; font-display: optional; font-family: "Montserrat", sans-serif; } h3 { color: var(--title-colour); font-size: 24px; font-display: optional; font-family: "Roboto Slab", serif; } q, blockquote { font-style: italic; white-space: pre-wrap; padding-left: 42px; } pre { margin: 32px; white-space: pre-wrap; white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; word-wrap: break-word; } strong { background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; } code { border-radius: 8px; background-color: var(--code-background); } pre { white-space: pre-wrap; } .info-container { max-width: 400px; margin: 32px; } .info-container p { margin-inline: 16px; margin-block: 32px; text-align: justify; font-size: 18px; } .labeled-img { max-width: 100%; position: relative; } .labeled-img div { position: absolute; bottom: 0; width: 100%; height: 70%; background: linear-gradient(to bottom, transparent, black); border-radius: var(--border-radius); } .labeled-img div h2 { color: white; position: absolute; bottom: 0; left: 32px; } .labeled-img img { width: 100%; border-radius: var(--border-radius); } a { background: var(--gradient); background-clip: none; color: var(--background-colour); font-weight: bold; text-decoration: none; border-radius: 3px; } a:hover { background: var(--text-colour); } .link, .link:hover { background: none; } button { background: var(--gradient); color: var(--background-colour); box-shadow: none; border: none; border-radius: 48px; padding: 8px; padding-left: 32px; padding-right: 32px; margin: 24px; font-size: 24px; font-display: optional; font-family: "Montserrat", sans-serif; font-weight: bold; cursor: pointer; transition: background .2s, color .2s, opacity .2s, box-shadow .2s, transform .2s; } button:hover { box-shadow: var(--shadow-colour) 0 8px 32px; transform: translateY(-4px); } button:active { transform: none; opacity: 50%; } .clickable { padding: 2px; transition: background-color 0.05s ease-out; border-radius: var(--border-radius); } .clickable:hover { background-color: var(--shadow-colour); } .docs-container { margin: auto; margin-top: 64px; max-width: 1200px; display: grid; justify-content: center; grid-template-columns: 1fr 3fr; } .docs { max-width: 900px; } .sidebar { min-width: 250px; position: fixed; padding: 16px; display: grid; justify-content: center; grid-auto-flow: row; grid-gap: 32px; padding-top: 64px; } .sidebar * { margin: auto; display: grid; justify-content: left; grid-auto-flow: column; grid-gap: 8px; } .sidebar p { font-size: 18px; } .sidebar-item { color: var(--text-colour); background: none; padding-inline: 8px; width: 100%; height: 100%; } .sidebar-item div svg { fill: var(--text-colour); } .navbar-container { width: 100vw; height: 48px; } .navbar { position: fixed; z-index: 100; width: 100vw; background-color: var(--navbar-colour); backdrop-filter: blur(20px); display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 32px; padding: 12px; } .navbar * { margin: auto; display: grid; justify-content: center; grid-auto-flow: column; grid-gap: 8px; } .navbar p { font-size: 18px; } .navbar-logo { height: 100%; max-height: 32px; stroke: var(--text-colour); } .navbar-icon { fill: var(--text-colour); } .navbar-item { color: var(--text-colour); background-color: transparent; padding-inline: 8px; width: 100%; height: 100%; border-radius: 8px; } @media only screen and (max-width: 800px) { .navbar-item { position: absolute; visibility: hidden; } } footer { text-align: center; padding: 64px; border-radius: 64px 64px 0 0; background: -webkit-linear-gradient(50deg, transparent, var(--monitor-bleed)); } footer p { margin: auto; } .permalink { color: var(--text-colour); background: none; } .permalink:hover { background: none; } </style></head><body><html><body><div class=navbar-container><div class=navbar><a class="navbar-item clickable link" href=https://inobulles.github.io><div><svg class=navbar-logo fill=none height=24px viewbox="0 0 144 144" width=24px xmlns=http://www.w3.org/2000/svg><path d=m22,115l50,-88l50,88l-100,0z stroke-width=20 transform="rotate(180 72 72)"></path></svg><p><strong>aquaBSD</strong></p></div></a><a class="navbar-item clickable link" href=https://inobulles.github.io/docs><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg><p>Develop</p></div></a><a class="navbar-item clickable link" href=mailto:inobulles@gmail.com><div><svg class=navbar-icon fill=none height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"></path></svg><p>Contact</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><path d="M12,2C6.48,2,2,6.48,2,12c0,5.52,4.48,10,10,10s10-4.48,10-10C22,6.48,17.52,2,12,2z M19.46,9.12l-2.78,1.15 c-0.51-1.36-1.58-2.44-2.95-2.94l1.15-2.78C16.98,5.35,18.65,7.02,19.46,9.12z M12,15c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,15,12,15z M9.13,4.54l1.17,2.78c-1.38,0.5-2.47,1.59-2.98,2.97L4.54,9.13C5.35,7.02,7.02,5.35,9.13,4.54z M4.54,14.87 l2.78-1.15c0.51,1.38,1.59,2.46,2.97,2.96l-1.17,2.78C7.02,18.65,5.35,16.98,4.54,14.87z M14.88,19.46l-1.15-2.78 c1.37-0.51,2.45-1.59,2.95-2.97l2.78,1.17C18.65,16.98,16.98,18.65,14.88,19.46z"></path></g></svg><p>Support</p></div></a><a class="navbar-item clickable link" href=#><div><svg class=navbar-icon fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 12 7.4l3.38 4.6L17 10.83 14.92 8H20v6z"></path></svg><p>Log in</p></div></a></div></div></body></html><div class=docs-container><html><body><div class=sidebar-container><div class=sidebar><a class="sidebar-item clickable" href=https://inobulles.github.io/docs><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M12.36 6l.4 2H18v6h-3.36l-.4-2H7V6h5.36M14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6L14 4z"></path></svg><p>Introduction</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/struct><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><rect fill=none height=24 width=24></rect><path d="M22,11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3H22z M7,9H4V5h3V9z M17,15h3v4h-3V15z M17,5h3v4h-3V5z"></path></svg><p>OS Components</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/dev-tools><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><rect height=8.48 transform="matrix(0.7071 -0.7071 0.7071 0.7071 -6.8717 17.6255)" width=3 x=16.34 y=12.87></rect><path d="M17.5,10c1.93,0,3.5-1.57,3.5-3.5c0-0.58-0.16-1.12-0.41-1.6l-2.7,2.7L16.4,6.11l2.7-2.7C18.62,3.16,18.08,3,17.5,3 C15.57,3,14,4.57,14,6.5c0,0.41,0.08,0.8,0.21,1.16l-1.85,1.85l-1.78-1.78l0.71-0.71L9.88,5.61L12,3.49 c-1.17-1.17-3.07-1.17-4.24,0L4.22,7.03l1.41,1.41H2.81L2.1,9.15l3.54,3.54l0.71-0.71V9.15l1.41,1.41l0.71-0.71l1.78,1.78 l-7.41,7.41l2.12,2.12L16.34,9.79C16.7,9.92,17.09,10,17.5,10z"></path></g></g></svg><p>Developer Tools</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/create-app><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24 x=0></rect></g><g><g><polygon points="19,9 20.25,6.25 23,5 20.25,3.75 19,1 17.75,3.75 15,5 17.75,6.25"></polygon><polygon points="19,15 17.75,17.75 15,19 17.75,20.25 19,23 20.25,20.25 23,19 20.25,17.75"></polygon><path d="M11.5,9.5L9,4L6.5,9.5L1,12l5.5,2.5L9,20l2.5-5.5L17,12L11.5,9.5z M9.99,12.99L9,15.17l-0.99-2.18L5.83,12l2.18-0.99 L9,8.83l0.99,2.18L12.17,12L9.99,12.99z"></path></g></g></svg><p>Creating an App</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/packaging><div><svg enable-background="new 0 0 24 24" fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><g><rect fill=none height=24 width=24></rect></g><g><g><path d="M20,2H4C3,2,2,2.9,2,4v3.01C2,7.73,2.43,8.35,3,8.7V20c0,1.1,1.1,2,2,2h14c0.9,0,2-0.9,2-2V8.7c0.57-0.35,1-0.97,1-1.69V4 C22,2.9,21,2,20,2z M19,20H5V9h14V20z M20,7H4V4h16V7z"></path><rect height=2 width=6 x=9 y=12></rect></g></g></svg><p>Packaging Apps</p></div></a><a class="sidebar-item clickable" href=https://inobulles.github.io/docs/publishing><div><svg fill=#000000 height=24px viewbox="0 0 24 24" width=24px xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0V0z" fill=none></path><path d="M13 3v1h-2V3h2m-1 7.11l5.38 1.77 2.39.78-1.12 3.97c-.54-.3-.94-.71-1.14-.94L16 13.96l-1.51 1.72c-.34.4-1.28 1.32-2.49 1.32s-2.15-.92-2.49-1.32L8 13.96l-1.51 1.72c-.2.23-.6.63-1.14.93l-1.13-3.96 2.4-.79L12 10.11M15 1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1zM6 9.97V6h12v3.97L12 8 6 9.97zm10 9.71c-1.22.85-2.61 1.28-4 1.28s-2.78-.43-4-1.28C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 1.26.64 2.63.97 4 .97s2.74-.32 4-.97c1.26.65 2.62.99 4 .99h2v-2h-2c-1.39 0-2.78-.47-4-1.32z"></path></svg><p>Publishing Apps</p></div></a></div></div></body></html><div class=docs><h1>crypto_kregister(9)</h1><table class=head><tr><td class=head-ltitle>CRYPTO(9)</td><td class=head-vol>FreeBSD Kernel Developer's Manual</td><td class=head-rtitle>CRYPTO(9)</td></tr></table><div class=manual-text><section class=Sh><h2 class=Sh id=NAME><a class=permalink href=#NAME>NAME</a></h2><code class=Nm>crypto</code> — <div class=Nd>API for cryptographic services in the kernel</div></section><section class=Sh><h2 class=Sh id=SYNOPSIS><a class=permalink href=#SYNOPSIS>SYNOPSIS</a></h2><code class=In>#include &lt;<a class=In href=../src/opencrypto/cryptodev.h.html>opencrypto/cryptodev.h</a>&gt;</code><p class=Pp><var class=Ft>int32_t</var><br><code class=Fn>crypto_get_driverid</code>(<var class=Fa style="white-space: nowrap;">device_t dev</var>, <var class=Fa style="white-space: nowrap;">size_t session_size</var>, <var class=Fa style="white-space: nowrap;">int flags</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_register</code>(<var class=Fa style="white-space: nowrap;">uint32_t driverid</var>, <var class=Fa style="white-space: nowrap;">int alg</var>, <var class=Fa style="white-space: nowrap;">uint16_t maxoplen</var>, <var class=Fa style="white-space: nowrap;">uint32_t flags</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_kregister</code>(<var class=Fa style="white-space: nowrap;">uint32_t driverid</var>, <var class=Fa style="white-space: nowrap;">int kalg</var>, <var class=Fa style="white-space: nowrap;">uint32_t flags</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_unregister</code>(<var class=Fa style="white-space: nowrap;">uint32_t driverid</var>, <var class=Fa style="white-space: nowrap;">int alg</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_unregister_all</code>(<var class=Fa style="white-space: nowrap;">uint32_t driverid</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_done</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_kdone</code>(<var class=Fa style="white-space: nowrap;">struct cryptkop *krp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_find_driver</code>(<var class=Fa style="white-space: nowrap;">const char *match</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_newsession</code>(<var class=Fa style="white-space: nowrap;">crypto_session_t *cses</var>, <var class=Fa style="white-space: nowrap;">struct cryptoini *cri</var>, <var class=Fa style="white-space: nowrap;">int crid</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_freesession</code>(<var class=Fa style="white-space: nowrap;">crypto_session_t cses</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_dispatch</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_kdispatch</code>(<var class=Fa style="white-space: nowrap;">struct cryptkop *krp</var>);</p><p class=Pp><var class=Ft>int</var><br><code class=Fn>crypto_unblock</code>(<var class=Fa style="white-space: nowrap;">uint32_t driverid</var>, <var class=Fa style="white-space: nowrap;">int what</var>);</p><p class=Pp><var class=Ft>struct cryptop *</var><br><code class=Fn>crypto_getreq</code>(<var class=Fa style="white-space: nowrap;">int num</var>);</p><p class=Pp><var class=Ft>void</var><br><code class=Fn>crypto_freereq</code>(<var class=Fa style="white-space: nowrap;">struct cryptop *crp</var>);</p><div class="Bd Pp"><pre>
#define	CRYPTO_SYMQ	0x1
#define	CRYPTO_ASYMQ	0x2

#define EALG_MAX_BLOCK_LEN      16

struct cryptoini {
	int                cri_alg;
	int                cri_klen;
	int                cri_mlen;
	caddr_t            cri_key;
	uint8_t            cri_iv[EALG_MAX_BLOCK_LEN];
	struct cryptoini  *cri_next;
};

struct cryptodesc {
	int                crd_skip;
	int                crd_len;
	int                crd_inject;
	int                crd_flags;
	struct cryptoini   CRD_INI;
#define crd_iv          CRD_INI.cri_iv
#define crd_key         CRD_INI.cri_key
#define crd_alg         CRD_INI.cri_alg
#define crd_klen        CRD_INI.cri_klen
	struct cryptodesc *crd_next;
};

struct cryptop {
	TAILQ_ENTRY(cryptop) crp_next;
	crypto_session_t   crp_session;
	int                crp_ilen;
	int                crp_olen;
	int                crp_etype;
	int                crp_flags;
	caddr_t            crp_buf;
	caddr_t            crp_opaque;
	struct cryptodesc *crp_desc;
	int              (*crp_callback) (struct cryptop *);
	caddr_t            crp_mac;
};

struct crparam {
        caddr_t         crp_p;
        u_int           crp_nbits;
};

#define CRK_MAXPARAM    8

struct cryptkop {
        TAILQ_ENTRY(cryptkop) krp_next;
        u_int              krp_op;         /* ie. CRK_MOD_EXP or other */
        u_int              krp_status;     /* return status */
        u_short            krp_iparams;    /* # of input parameters */
        u_short            krp_oparams;    /* # of output parameters */
        uint32_t           krp_hid;
        struct crparam     krp_param[CRK_MAXPARAM];
        int               (*krp_callback)(struct cryptkop *);
};
</pre></div></section><section class=Sh><h2 class=Sh id=DESCRIPTION><a class=permalink href=#DESCRIPTION>DESCRIPTION</a></h2><code class=Nm>crypto</code> is a framework for drivers of cryptographic hardware to register with the kernel so “consumers” (other kernel subsystems, and users through the <span class=Pa>/dev/crypto</span> device) are able to make use of it. Drivers register with the framework the algorithms they support, and provide entry points (functions) the framework may call to establish, use, and tear down sessions. Sessions are used to cache cryptographic information in a particular driver (or associated hardware), so initialization is not needed with every request. Consumers of cryptographic services pass a set of descriptors that instruct the framework (and the drivers registered with it) of the operations that should be applied on the data (more than one cryptographic operation can be requested). <p class=Pp>Keying operations are supported as well. Unlike the symmetric operators described above, these sessionless commands perform mathematical operations using input and output parameters.</p><p class=Pp>Since the consumers may not be associated with a process, drivers may not <a class=Xr href=sleep.9.html>sleep(9)</a>. The same holds for the framework. Thus, a callback mechanism is used to notify a consumer that a request has been completed (the callback is specified by the consumer on a per-request basis). The callback is invoked by the framework whether the request was successfully completed or not. An error indication is provided in the latter case. A specific error code, <code class=Er>EAGAIN</code>, is used to indicate that a session handle has changed and that the request may be re-submitted immediately with the new session. Errors are only returned to the invoking function if not enough information to call the callback is available (meaning, there was a fatal error in verifying the arguments). For session initialization and teardown no callback mechanism is used.</p><p class=Pp>The <code class=Fn>crypto_find_driver</code>() returns the driver id of the device whose name matches <var class=Fa>match</var>. <var class=Fa>match</var> can either be the exact name of a device including the unit or the driver name without a unit. In the latter case, the id of the first device with the matching driver name is returned. If no matching device is found, the value -1 is returned.</p><p class=Pp>The <code class=Fn>crypto_newsession</code>() routine is called by consumers of cryptographic services (such as the <a class=Xr href=ipsec.4.html>ipsec(4)</a> stack) that wish to establish a new session with the framework. The <var class=Fa>cri</var> argument points to a <var class=Vt>cryptoini</var> structure containing all the necessary information for the driver to establish the session. The <var class=Fa>crid</var> argument is either a specific driver id or a bitmask of flags. The flags are <code class=Dv>CRYPTOCAP_F_HARDWARE</code>, to select hardware devices, or <code class=Dv>CRYPTOCAP_F_SOFTWARE</code>, to select software devices. If both are specified, hardware devices are preferred over software devices. On success, the opaque session handle of the new session will be stored in <var class=Fa>*cses</var>. The <var class=Vt>cryptoini</var> structure pointed to by <var class=Fa>cri</var> contains these fields:</p><dl class=Bl-tag><dt><var class=Va>cri_alg</var></dt><dd>An algorithm identifier. Currently supported algorithms are: <p class=Pp></p><dl class="Bl-tag Bl-compact"><dt><a class=permalink href=#CRYPTO_AES_128_NIST_GMAC><code class=Dv id=CRYPTO_AES_128_NIST_GMAC>CRYPTO_AES_128_NIST_GMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_192_NIST_GMAC><code class=Dv id=CRYPTO_AES_192_NIST_GMAC>CRYPTO_AES_192_NIST_GMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_256_NIST_GMAC><code class=Dv id=CRYPTO_AES_256_NIST_GMAC>CRYPTO_AES_256_NIST_GMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_CBC><code class=Dv id=CRYPTO_AES_CBC>CRYPTO_AES_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_CCM_16><code class=Dv id=CRYPTO_AES_CCM_16>CRYPTO_AES_CCM_16</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_CCM_CBC_MAC><code class=Dv id=CRYPTO_AES_CCM_CBC_MAC>CRYPTO_AES_CCM_CBC_MAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_ICM><code class=Dv id=CRYPTO_AES_ICM>CRYPTO_AES_ICM</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_NIST_GCM_16><code class=Dv id=CRYPTO_AES_NIST_GCM_16>CRYPTO_AES_NIST_GCM_16</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_NIST_GMAC><code class=Dv id=CRYPTO_AES_NIST_GMAC>CRYPTO_AES_NIST_GMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_AES_XTS><code class=Dv id=CRYPTO_AES_XTS>CRYPTO_AES_XTS</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_ARC4><code class=Dv id=CRYPTO_ARC4>CRYPTO_ARC4</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_BLAKE2B><code class=Dv id=CRYPTO_BLAKE2B>CRYPTO_BLAKE2B</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_BLAKE2S><code class=Dv id=CRYPTO_BLAKE2S>CRYPTO_BLAKE2S</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_BLF_CBC><code class=Dv id=CRYPTO_BLF_CBC>CRYPTO_BLF_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_CAMELLIA_CBC><code class=Dv id=CRYPTO_CAMELLIA_CBC>CRYPTO_CAMELLIA_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_CAST_CBC><code class=Dv id=CRYPTO_CAST_CBC>CRYPTO_CAST_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_CHACHA20><code class=Dv id=CRYPTO_CHACHA20>CRYPTO_CHACHA20</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_DEFLATE_COMP><code class=Dv id=CRYPTO_DEFLATE_COMP>CRYPTO_DEFLATE_COMP</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_DES_CBC><code class=Dv id=CRYPTO_DES_CBC>CRYPTO_DES_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_3DES_CBC><code class=Dv id=CRYPTO_3DES_CBC>CRYPTO_3DES_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_MD5><code class=Dv id=CRYPTO_MD5>CRYPTO_MD5</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_MD5_HMAC><code class=Dv id=CRYPTO_MD5_HMAC>CRYPTO_MD5_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_MD5_KPDK><code class=Dv id=CRYPTO_MD5_KPDK>CRYPTO_MD5_KPDK</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_NULL_HMAC><code class=Dv id=CRYPTO_NULL_HMAC>CRYPTO_NULL_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_NULL_CBC><code class=Dv id=CRYPTO_NULL_CBC>CRYPTO_NULL_CBC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_POLY1305><code class=Dv id=CRYPTO_POLY1305>CRYPTO_POLY1305</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_RIPEMD160><code class=Dv id=CRYPTO_RIPEMD160>CRYPTO_RIPEMD160</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_RIPEMD160_HMAC><code class=Dv id=CRYPTO_RIPEMD160_HMAC>CRYPTO_RIPEMD160_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA1><code class=Dv id=CRYPTO_SHA1>CRYPTO_SHA1</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA1_HMAC><code class=Dv id=CRYPTO_SHA1_HMAC>CRYPTO_SHA1_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA1_KPDK><code class=Dv id=CRYPTO_SHA1_KPDK>CRYPTO_SHA1_KPDK</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_224><code class=Dv id=CRYPTO_SHA2_224>CRYPTO_SHA2_224</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_224_HMAC><code class=Dv id=CRYPTO_SHA2_224_HMAC>CRYPTO_SHA2_224_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_256><code class=Dv id=CRYPTO_SHA2_256>CRYPTO_SHA2_256</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_256_HMAC><code class=Dv id=CRYPTO_SHA2_256_HMAC>CRYPTO_SHA2_256_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_384><code class=Dv id=CRYPTO_SHA2_384>CRYPTO_SHA2_384</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_384_HMAC><code class=Dv id=CRYPTO_SHA2_384_HMAC>CRYPTO_SHA2_384_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_512><code class=Dv id=CRYPTO_SHA2_512>CRYPTO_SHA2_512</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SHA2_512_HMAC><code class=Dv id=CRYPTO_SHA2_512_HMAC>CRYPTO_SHA2_512_HMAC</code></a></dt><dd style="width: auto;"> </dd><dt><a class=permalink href=#CRYPTO_SKIPJACK_CBC><code class=Dv id=CRYPTO_SKIPJACK_CBC>CRYPTO_SKIPJACK_CBC</code></a></dt><dd style="width: auto;"> </dd></dl></dd><dt><var class=Va>cri_klen</var></dt><dd>For variable-size key algorithms, the length of the key in bits.</dd><dt><var class=Va>cri_mlen</var></dt><dd>If non-zero, truncate the calculated hash to this many bytes.</dd><dt><var class=Va>cri_key</var></dt><dd>The key to be used.</dd><dt><var class=Va>cri_iv</var></dt><dd>An explicit initialization vector if it does not prefix the data. This field is ignored during initialization (<code class=Nm>crypto_newsession</code>). If no IV is explicitly passed (see below on details), a random IV is used by the device driver processing the request.</dd><dt><var class=Va>cri_next</var></dt><dd>Pointer to another <var class=Vt>cryptoini</var> structure. This is used to establish dual-algorithm sessions, such as combining a cipher with a MAC.</dd></dl><p class=Pp>The <var class=Vt>cryptoini</var> structure and its contents will not be modified or referenced by the framework or any cryptographic drivers. The memory associated with <var class=Fa>cri</var> can be released once <code class=Fn>crypto_newsession</code>() returns.</p><p class=Pp><code class=Fn>crypto_freesession</code>() is called with the session handle returned by <code class=Fn>crypto_newsession</code>() to free the session.</p><p class=Pp><code class=Fn>crypto_dispatch</code>() is called to process a request. The various fields in the <var class=Vt>cryptop</var> structure are:</p><dl class=Bl-tag><dt><var class=Va>crp_session</var></dt><dd>The session handle.</dd><dt><var class=Va>crp_ilen</var></dt><dd>The total length in bytes of the buffer to be processed.</dd><dt><var class=Va>crp_olen</var></dt><dd>On return, contains the total length of the result. For symmetric crypto operations, this will be the same as the input length. This will be used if the framework needs to allocate a new buffer for the result (or for re-formatting the input).</dd><dt><var class=Va>crp_callback</var></dt><dd>Callback routine invoked when a request is completed via <code class=Fn>crypto_done</code>(). The callback routine should inspect the <var class=Va>crp_etype</var> to determine if the request was successfully completed.</dd><dt><var class=Va>crp_etype</var></dt><dd>The error type, if any errors were encountered, or zero if the request was successfully processed. If the <code class=Er>EAGAIN</code> error code is returned, the session handle has changed (and has been recorded in the <var class=Va>crp_session</var> field). The consumer should record the new session handle and use it in all subsequent requests. In this case, the request may be re-submitted immediately. This mechanism is used by the framework to perform session migration (move a session from one driver to another, because of availability, performance, or other considerations). <p class=Pp>This field is only valid in the context of the callback routine specified by <var class=Va>crp_callback</var>. Errors are returned to the invoker of <code class=Fn>crypto_process</code>() only when enough information is not present to call the callback routine (i.e., if the pointer passed is <code class=Dv>NULL</code> or if no callback routine was specified).</p></dd><dt><var class=Va>crp_flags</var></dt><dd>A bitmask of flags associated with this request. Currently defined flags are: <dl class=Bl-tag><dt><a class=permalink href=#CRYPTO_F_IMBUF><code class=Dv id=CRYPTO_F_IMBUF>CRYPTO_F_IMBUF</code></a></dt><dd>The buffer is an mbuf chain pointed to by <var class=Va>crp_mbuf</var>.</dd><dt><a class=permalink href=#CRYPTO_F_IOV><code class=Dv id=CRYPTO_F_IOV>CRYPTO_F_IOV</code></a></dt><dd>The buffer is a <var class=Vt>uio</var> structure pointed to by <var class=Va>crp_uio</var>.</dd><dt><a class=permalink href=#CRYPTO_F_BATCH><code class=Dv id=CRYPTO_F_BATCH>CRYPTO_F_BATCH</code></a></dt><dd>Batch operation if possible.</dd><dt><a class=permalink href=#CRYPTO_F_CBIMM><code class=Dv id=CRYPTO_F_CBIMM>CRYPTO_F_CBIMM</code></a></dt><dd>Do callback immediately instead of doing it from a dedicated kernel thread.</dd><dt><a class=permalink href=#CRYPTO_F_DONE><code class=Dv id=CRYPTO_F_DONE>CRYPTO_F_DONE</code></a></dt><dd>Operation completed.</dd><dt><a class=permalink href=#CRYPTO_F_CBIFSYNC><code class=Dv id=CRYPTO_F_CBIFSYNC>CRYPTO_F_CBIFSYNC</code></a></dt><dd>Do callback immediately if operation is synchronous (that the driver specified the <code class=Dv>CRYPTOCAP_F_SYNC</code> flag).</dd><dt><a class=permalink href=#CRYPTO_F_ASYNC><code class=Dv id=CRYPTO_F_ASYNC>CRYPTO_F_ASYNC</code></a></dt><dd>Try to do the crypto operation in a pool of workers if the operation is synchronous (that is, if the driver specified the <code class=Dv>CRYPTOCAP_F_SYNC</code> flag). It aims to speed up processing by dispatching crypto operations on different processors.</dd><dt><a class=permalink href=#CRYPTO_F_ASYNC_KEEPORDER><code class=Dv id=CRYPTO_F_ASYNC_KEEPORDER>CRYPTO_F_ASYNC_KEEPORDER</code></a></dt><dd>Dispatch callbacks in the same order they are posted. Only relevant if the <code class=Dv>CRYPTO_F_ASYNC</code> flag is set and if the operation is synchronous.</dd></dl></dd><dt><var class=Va>crp_buf</var></dt><dd>Data buffer unless <code class=Dv>CRYPTO_F_IMBUF</code> or <code class=Dv>CRYPTO_F_IOV</code> is set in <var class=Va>crp_flags</var>. The length in bytes is set in <var class=Va>crp_ilen</var>.</dd><dt><var class=Va>crp_mbuf</var></dt><dd>Data buffer mbuf chain when <code class=Dv>CRYPTO_F_IMBUF</code> is set in <var class=Va>crp_flags</var>.</dd><dt><var class=Va>crp_uio</var></dt><dd><var class=Vt>struct uio</var> data buffer when <code class=Dv>CRYPTO_F_IOV</code> is set in <var class=Va>crp_flags</var>.</dd><dt><var class=Va>crp_opaque</var></dt><dd>Cookie passed through the crypto framework untouched. It is intended for the invoking application's use.</dd><dt><var class=Va>crp_desc</var></dt><dd>A linked list of descriptors. Each descriptor provides information about what type of cryptographic operation should be done on the input buffer. The various fields are: <dl class=Bl-tag><dt><var class=Va>crd_iv</var></dt><dd>When the flag <code class=Dv>CRD_F_IV_EXPLICIT</code> is set, this field contains the IV.</dd><dt><var class=Va>crd_key</var></dt><dd>When the <code class=Dv>CRD_F_KEY_EXPLICIT</code> flag is set, the <var class=Va>crd_key</var> points to a buffer with encryption or authentication key.</dd><dt><var class=Va>crd_alg</var></dt><dd>An algorithm to use. Must be the same as the one given at newsession time.</dd><dt><var class=Va>crd_klen</var></dt><dd>The <var class=Va>crd_key</var> key length.</dd><dt><var class=Va>crd_skip</var></dt><dd>The offset in the input buffer where processing should start.</dd><dt><var class=Va>crd_len</var></dt><dd>How many bytes, after <var class=Va>crd_skip</var>, should be processed.</dd><dt><var class=Va>crd_inject</var></dt><dd>The <var class=Va>crd_inject</var> field specifies an offset in bytes from the beginning of the buffer. For encryption algorithms, this may be where the IV will be inserted when encrypting or where the IV may be found for decryption (subject to <var class=Va>crd_flags</var>). For MAC algorithms, this is where the result of the keyed hash will be inserted.</dd><dt><var class=Va>crd_flags</var></dt><dd>The following flags are defined: <dl class=Bl-tag><dt><a class=permalink href=#CRD_F_ENCRYPT><code class=Dv id=CRD_F_ENCRYPT>CRD_F_ENCRYPT</code></a></dt><dd>For encryption algorithms, this bit is set when encryption is required (when not set, decryption is performed).</dd><dt><a class=permalink href=#CRD_F_IV_PRESENT><code class=Dv id=CRD_F_IV_PRESENT>CRD_F_IV_PRESENT</code></a></dt><dd>For encryption, if this bit is not set the IV used to encrypt the packet will be written at the location pointed to by <var class=Va>crd_inject</var>. The IV length is assumed to be equal to the blocksize of the encryption algorithm. For encryption, if this bit is set, nothing is done. For decryption, this flag has no meaning. Applications that do special “IV cooking”, such as the half-IV mode in <a class=Xr href=ipsec.4.html>ipsec(4)</a>, can use this flag to indicate that the IV should not be written on the packet. This flag is typically used in conjunction with the <code class=Dv>CRD_F_IV_EXPLICIT</code> flag.</dd><dt><a class=permalink href=#CRD_F_IV_EXPLICIT><code class=Dv id=CRD_F_IV_EXPLICIT>CRD_F_IV_EXPLICIT</code></a></dt><dd>This bit is set when the IV is explicitly provided by the consumer in the <var class=Va>crd_iv</var> field. Otherwise, for encryption operations the IV is provided for by the driver used to perform the operation, whereas for decryption operations the offset of the IV is provided by the <var class=Va>crd_inject</var> field. This flag is typically used when the IV is calculated “on the fly” by the consumer, and does not precede the data.</dd><dt><a class=permalink href=#CRD_F_KEY_EXPLICIT><code class=Dv id=CRD_F_KEY_EXPLICIT>CRD_F_KEY_EXPLICIT</code></a></dt><dd>For encryption and authentication (MAC) algorithms, this bit is set when the key is explicitly provided by the consumer in the <var class=Va>crd_key</var> field for the given operation. Otherwise, the key is taken at newsession time from the <var class=Va>cri_key</var> field. As calculating the key schedule may take a while, it is recommended that often used keys are given their own session.</dd><dt><a class=permalink href=#CRD_F_COMP><code class=Dv id=CRD_F_COMP>CRD_F_COMP</code></a></dt><dd>For compression algorithms, this bit is set when compression is required (when not set, decompression is performed).</dd></dl></dd><dt><var class=Va>CRD_INI</var></dt><dd>This <var class=Vt>cryptoini</var> structure will not be modified by the framework or the device drivers. Since this information accompanies every cryptographic operation request, drivers may re-initialize state on-demand (typically an expensive operation). Furthermore, the cryptographic framework may re-route requests as a result of full queues or hardware failure, as described above.</dd><dt><var class=Va>crd_next</var></dt><dd>Point to the next descriptor. Linked operations are useful in protocols such as <a class=Xr href=ipsec.4.html>ipsec(4)</a>, where multiple cryptographic transforms may be applied on the same block of data.</dd></dl></dd></dl><p class=Pp><code class=Fn>crypto_getreq</code>() allocates a <var class=Vt>cryptop</var> structure with a linked list of <var class=Fa>num</var><var class=Vt>cryptodesc</var> structures.</p><p class=Pp><code class=Fn>crypto_freereq</code>() deallocates a structure <var class=Vt>cryptop</var> and any <var class=Vt>cryptodesc</var> structures linked to it. Note that it is the responsibility of the callback routine to do the necessary cleanups associated with the opaque field in the <var class=Vt>cryptop</var> structure.</p><p class=Pp><code class=Fn>crypto_kdispatch</code>() is called to perform a keying operation. The various fields in the <var class=Vt>cryptkop</var> structure are:</p><dl class=Bl-tag><dt><var class=Va>krp_op</var></dt><dd>Operation code, such as <code class=Dv>CRK_MOD_EXP</code>.</dd><dt><var class=Va>krp_status</var></dt><dd>Return code. This <var class=Va>errno</var>-style variable indicates whether lower level reasons for operation failure.</dd><dt><var class=Va>krp_iparams</var></dt><dd>Number of input parameters to the specified operation. Note that each operation has a (typically hardwired) number of such parameters.</dd><dt><var class=Va>krp_oparams</var></dt><dd>Number of output parameters from the specified operation. Note that each operation has a (typically hardwired) number of such parameters.</dd><dt><var class=Va>krp_kvp</var></dt><dd>An array of kernel memory blocks containing the parameters.</dd><dt><var class=Va>krp_hid</var></dt><dd>Identifier specifying which low-level driver is being used.</dd><dt><var class=Va>krp_callback</var></dt><dd>Callback called on completion of a keying operation.</dd></dl></section><section class=Sh><h2 class=Sh id=DRIVER_SIDE_API><a class=permalink href=#DRIVER_SIDE_API>DRIVER-SIDE API</a></h2> The <code class=Fn>crypto_get_driverid</code>(), <code class=Fn>crypto_get_driver_session</code>(), <code class=Fn>crypto_register</code>(), <code class=Fn>crypto_kregister</code>(), <code class=Fn>crypto_unregister</code>(), <code class=Fn>crypto_unblock</code>(), and <code class=Fn>crypto_done</code>() routines are used by drivers that provide support for cryptographic primitives to register and unregister with the kernel crypto services framework. <p class=Pp>Drivers must first use the <code class=Fn>crypto_get_driverid</code>() function to acquire a driver identifier, specifying the <var class=Fa>flags</var> as an argument. One of <code class=Dv>CRYPTOCAP_F_SOFTWARE</code> or <code class=Dv>CRYPTOCAP_F_HARDWARE</code> must be specified. The <code class=Dv>CRYPTOCAP_F_SYNC</code> may also be specified, and should be specified if the driver does all of it's operations synchronously. Drivers must pass the size of their session structure as the second argument. An appropriately sized memory will be allocated by the framework, zeroed, and passed to the driver's <code class=Fn>newsession</code>() method.</p><p class=Pp>For each algorithm the driver supports, it must then call <code class=Fn>crypto_register</code>(). The first two arguments are the driver and algorithm identifiers. The next two arguments specify the largest possible operator length (in bits, important for public key operations) and flags for this algorithm.</p><p class=Pp><code class=Fn>crypto_unregister</code>() is called by drivers that wish to withdraw support for an algorithm. The two arguments are the driver and algorithm identifiers, respectively. Typically, drivers for PCMCIA crypto cards that are being ejected will invoke this routine for all algorithms supported by the card. <code class=Fn>crypto_unregister_all</code>() will unregister all algorithms registered by a driver and the driver will be disabled (no new sessions will be allocated on that driver, and any existing sessions will be migrated to other drivers). The same will be done if all algorithms associated with a driver are unregistered one by one. After a call to <code class=Fn>crypto_unregister_all</code>() there will be no threads in either the newsession or freesession function of the driver.</p><p class=Pp>The calling convention for the driver-supplied routines are:</p><p class=Pp></p><ul class="Bl-item Bl-compact"><li><var class=Ft>int</var><code class=Fn>(*newsession)</code>(<var class=Fa>device_t</var>, <var class=Fa>crypto_session_t</var>, <var class=Fa>struct cryptoini *</var>);</li><li><var class=Ft>void</var><code class=Fn>(*freesession)</code>(<var class=Fa>device_t</var>, <var class=Fa>crypto_session_t</var>);</li><li><var class=Ft>int</var><code class=Fn>(*process)</code>(<var class=Fa>device_t</var>, <var class=Fa>struct cryptop *</var>, <var class=Fa>int</var>);</li><li><var class=Ft>int</var><code class=Fn>(*kprocess)</code>(<var class=Fa>device_t</var>, <var class=Fa>struct cryptkop *</var>, <var class=Fa>int</var>);</li></ul><p class=Pp>On invocation, the first argument to all routines is the <var class=Fa>device_t</var> that was provided to <code class=Fn>crypto_get_driverid</code>(). The second argument to <code class=Fn>newsession</code>() is the opaque session handle for the new session. The third argument is identical to that of <code class=Fn>crypto_newsession</code>().</p><p class=Pp>Drivers obtain a pointer to their session memory by invoking <code class=Fn>crypto_get_driver_session</code>() on the opaque <var class=Vt>crypto_session_t</var> handle.</p><p class=Pp>The <code class=Fn>freesession</code>() routine takes as arguments the opaque data value and the session handle. It should clear any context associated with the session (clear hardware registers, memory, etc.). If no resources need to be released other than the contents of session memory, the method is optional. The <code class=Nm>crypto</code> framework will zero and release the allocated session memory (after running the <code class=Fn>freesession</code>() method, if one exists).</p><p class=Pp>The <code class=Fn>process</code>() routine is invoked with a request to perform crypto processing. This routine must not block or sleep, but should queue the request and return immediately or process the request to completion. In case of an unrecoverable error, the error indication must be placed in the <var class=Va>crp_etype</var> field of the <var class=Vt>cryptop</var> structure. When the request is completed, or an error is detected, the <code class=Fn>process</code>() routine must invoke <code class=Fn>crypto_done</code>(). Session migration may be performed, as mentioned previously.</p><p class=Pp>In case of a temporary resource exhaustion, the <code class=Fn>process</code>() routine may return <code class=Er>ERESTART</code> in which case the crypto services will requeue the request, mark the driver as “blocked”, and stop submitting requests for processing. The driver is then responsible for notifying the crypto services when it is again able to process requests through the <code class=Fn>crypto_unblock</code>() routine. This simple flow control mechanism should only be used for short-lived resource exhaustion as it causes operations to be queued in the crypto layer. Doing so is preferable to returning an error in such cases as it can cause network protocols to degrade performance by treating the failure much like a lost packet.</p><p class=Pp>The <code class=Fn>kprocess</code>() routine is invoked with a request to perform crypto key processing. This routine must not block, but should queue the request and return immediately. Upon processing the request, the callback routine should be invoked. In case of an unrecoverable error, the error indication must be placed in the <var class=Va>krp_status</var> field of the <var class=Vt>cryptkop</var> structure. When the request is completed, or an error is detected, the <code class=Fn>kprocess</code>() routine should invoked <code class=Fn>crypto_kdone</code>().</p></section><section class=Sh><h2 class=Sh id=RETURN_VALUES><a class=permalink href=#RETURN_VALUES>RETURN VALUES</a></h2><code class=Fn>crypto_register</code>(), <code class=Fn>crypto_kregister</code>(), <code class=Fn>crypto_unregister</code>(), <code class=Fn>crypto_newsession</code>(), <code class=Fn>crypto_freesession</code>(), and <code class=Fn>crypto_unblock</code>() return 0 on success, or an error code on failure. <code class=Fn>crypto_get_driverid</code>() returns a non-negative value on error, and -1 on failure. <code class=Fn>crypto_getreq</code>() returns a pointer to a <var class=Vt>cryptop</var> structure and <code class=Dv>NULL</code> on failure. <code class=Fn>crypto_dispatch</code>() returns <code class=Er>EINVAL</code> if its argument or the callback function was <code class=Dv>NULL</code>, and 0 otherwise. The callback is provided with an error code in case of failure, in the <var class=Va>crp_etype</var> field. </section><section class=Sh><h2 class=Sh id=FILES><a class=permalink href=#FILES>FILES</a></h2><dl class=Bl-tag><dt><span class=Pa>sys/opencrypto/crypto.c</span></dt><dd>most of the framework code</dd></dl></section><section class=Sh><h2 class=Sh id=SEE_ALSO><a class=permalink href=#SEE_ALSO>SEE ALSO</a></h2><a class=Xr href=crypto.4.html>crypto(4)</a>, <a class=Xr href=ipsec.4.html>ipsec(4)</a>, <a class=Xr href=crypto.7.html>crypto(7)</a>, <a class=Xr href=malloc.9.html>malloc(9)</a>, <a class=Xr href=sleep.9.html>sleep(9)</a></section><section class=Sh><h2 class=Sh id=HISTORY><a class=permalink href=#HISTORY>HISTORY</a></h2> The cryptographic framework first appeared in <span class=Ux>OpenBSD 2.7</span> and was written by <span class=An>Angelos D. Keromytis</span> &lt;<a class=Mt href=mailto:angelos@openbsd.org>angelos@openbsd.org</a>&gt;. </section><section class=Sh><h2 class=Sh id=BUGS><a class=permalink href=#BUGS>BUGS</a></h2> The framework currently assumes that all the algorithms in a <code class=Fn>crypto_newsession</code>() operation must be available by the same driver. If that is not the case, session initialization will fail. <p class=Pp>The framework also needs a mechanism for determining which driver is best for a specific set of algorithms associated with a session. Some type of benchmarking is in order here.</p><p class=Pp>Multiple instances of the same algorithm in the same session are not supported.</p></section></div><table class=foot><tr><td class=foot-date>December 17, 2019</td><td class=foot-os>FreeBSD 13.1-RELEASE-p2</td></tr></table></div></div><html><body><footer><p>©️ 2023 Inobulles</p></footer></body></html></body></html>